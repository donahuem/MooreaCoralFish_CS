---
title: "Coral Growth and Symbionts Analysis"
author: "Callie Stephenson"
date: "2023-08-29"
output: github_document
---
## Introduction

This is a R Markdown file in which I hope to write out my analyses. I will use this document to process all the R scripts found in the R folder and complete my project. 

#### Loading the data
```{r load packages, echo=FALSE, message=FALSE}
library(tidyverse)
library(here)
library(ggrepel)
library(patchwork)
library(tidytext)
library(AICcmodavg)
library(kableExtra)
library(PNWColors)
library(fishualize)
library(lme4)
library(lmerTest) #figure out which lme package you need
library(ggpp)
library(ggplot2)
library(GGally)
library(ggeffects)
library(arm) #discrete hist
library(MuMIn) #dredge
library(effects) #effects plots for dredged models
library(curl) #curl
library(gridExtra)
```

NS Notes:
Wants to do grams per grams (change in bw / initaial bw / number of days)
aka not multiplying by 100 to get percent change, but dividing by time to get change in bw by day

```{r load data, echo=FALSE, message=FALSE}
#explanatory data
all_nut <- read.csv("data/All_Nutrients_Processed.csv")
nut <- read.csv("data/March_nutrients_processed.csv")
nut_wide <- read.csv("data/Nutrient_data_wide.csv")
explanatory_seasonal <- read.csv("data/Explanatory_variables.csv")
turb <- read_csv(curl("https://raw.githubusercontent.com/dbarnas/Community_Functional_Diversity/main/Data/Biogeochem/August2021/Turb_NC.csv"))

#explanatory 2
cv_low_wet <- read.csv("data/Wet_Nutrients_Processed_CV_Low.csv")
cv_low_all <- read.csv("data/All_Nutrients_Processed_CV_Low.csv")

#Response data
sa <- read.csv("data/Surface_Area.csv")
BW <- read.csv("data/BW_tidy.csv") 
BW <- subset(BW, select=-c(1,4,5)) #remove some erroneous columns
TLE <- read.csv("data/TLE_summary.csv")
FCM <- read.csv("data/FCM_tidy.csv") %>% 
  rename(Placement_Code = PLACEMENT)
SI <- read.csv("data/STABLE_ISOTOPE_RAW.csv")

#metadata
PAC_meta <- read.csv("data/PAC_Coral_Codes.csv") 
PRU_meta <- read.csv("data/PRU_Coral_Codes.csv") 

#Mean Low Tide Value PCA 1 Axis
PCA_Pulse_variables_wide <- read.csv("data/PCA_Pulse_variables_wide.csv")
#explan <- read.csv("data/Explanatory_variables_wide.csv")
```

```{r clean turb}
turb1 <- turb %>% 
  filter(startsWith(CowTagID, "V")& CowTagID != "VSEEP")

turb1 <- turb1 %>%
  dplyr::select(c(CowTagID,
                   N_percent,
                   C_N))
#use C:N 
#can also use N percent
#plot(turb$C_N, turb$N_percent)
#hist(turb$C_N)
#hist(turb$N_percent)
#N_percent looks better. Will use N_percent for models
```

```{r build explanatory}
all_nut_long <- pivot_longer(
  data = all_nut,
  cols = c(Minimum_Salinity:Low_Tide_Mean_Ammonia_umolL)) 
names(all_nut_long)[names(all_nut_long) == "name"] <- "Parameter"

join <- explanatory_seasonal[,c(2:7)]
join <- unique(join)

explanatory_all <- left_join(join,all_nut_long, by = join_by(CowTagID))
explanatory_all_wide <- left_join(join, all_nut,by = join_by(CowTagID))
explanatory_all_wide <- left_join(explanatory_all_wide, turb1,by = join_by(CowTagID))
explanatory_all_wide <- left_join(explanatory_all_wide, PCA_Pulse_variables_wide,by = join_by(CowTagID))
```


```{r fix meta}
#meta takes a little massaging
PAC_meta <- PAC_meta[,c(3:10)]
PAC_meta$Species <- "Pocillopora acuta"
PAC_meta$Genotype <- gsub('PR21', 'PA21', PAC_meta$Genotype) #fix a typo in the genotypes
PRU_meta <- PRU_meta[,c(2:9)]
PRU_meta$Species <- "Porites rus"

meta <- rbind(PAC_meta, PRU_meta)
meta$Cage_Uncaged <- ifelse(meta$Cage_Uncaged == "T0", meta$Cage_Uncaged, 
                            substr(meta$Placement_Code, nchar(meta$Placement_Code),
                                   nchar(meta$Placement_Code)))
meta$Cage_Uncaged <- as.factor(meta$Cage_Uncaged)
```

```{r stable isotope data, warning=FALSE}
SI <- SI[,c(1:6)] #remove random extra columns
# Create a new column 'HS' containing the last 4 characters of 'Sample.ID'
SI$HS <- substr(SI$Sample.ID, nchar(SI$Sample.ID) - 3, nchar(SI$Sample.ID))

# Create a new column 'Sample.ID' containing all characters except the last 4 characters
SI$Sample.ID <- substr(SI$Sample.ID, 1, nchar(SI$Sample.ID) - 5)
SI$δ15N <- SI$δ15N...........vs..AIR.
SI$δ13C <- SI$δ13C............vs..VPDB

# Now your_data contains 'Sample.ID' split into two columns 'Sample.ID' and 'HS'
SI_cleaner <- SI[SI$Sample.ID != "", ]

SI_cleaner <- SI_cleaner %>%
  rename(`Micro_Vial` = Sample.ID)

SI_meta <- left_join(SI_cleaner, meta, by = join_by(Micro_Vial))
SI_meta$Genotype[is.na(SI_meta$Genotype)] <- SI_meta$Micro_Vial[is.na(SI_meta$Genotype)]
SI_meta$CowTagID <- paste0("V", SI_meta$Pin_Number)

CV <- names(explanatory_all_wide)[grepl("CV_", names(explanatory_all_wide), names(explanatory_all_wide))]
mean_low <- names(explanatory_all_wide)[grepl("Low_Tide_Mean_", names(explanatory_all_wide), names(explanatory_all_wide))]

filter_values <- c(CV, mean_low)

SI_data <- left_join(SI_meta, explanatory_all,by = join_by(CowTagID))
SI_data_wide <- left_join(SI_meta, explanatory_all_wide,by = join_by(CowTagID))

# Filter the dataframe SI_data
SI_data <- SI_data[SI_data$Parameter %in% filter_values, ] 
```



```{r build response, echo=FALSE}
#make a master response variable data sheet
response_data <- left_join(meta[,c(2:4,7,8)], BW[,c(2,4,5)], by = join_by(Placement_Code)) %>% 
  #select(!X) %>% #check that this doesn't need to be here
  left_join(FCM[,c(1,15,17)], by = join_by(Placement_Code)) %>% 
  left_join(TLE[,c(3:7)], by = join_by(Placement_Code))
response_data$CowTagID <- paste0("V",response_data$Pin_Number)

PRU_response_data <- response_data %>% 
  filter(Species == "Porites rus")

PRU_response_data_caged <- PRU_response_data %>% 
  filter(Cage_Uncaged == "C")

PAC_response_data <- response_data %>% 
  filter(Species == "Pocillopora acuta")

PAC_response_data_caged <- PAC_response_data %>% 
  filter(Cage_Uncaged == "C")
```


```{r all data seasonal, warning=FALSE}
#now make an all data that has both explanatory and response variables:
all_data_seasonal <- left_join(response_data, explanatory_seasonal, by = join_by(CowTagID))
#suppress warnings because there will be a many-to-many relationship between x and y
all_data_seasonal$Genotype <- as.factor(all_data_seasonal$Genotype)
all_PAC_data_seasonal <- all_data_seasonal %>% 
  filter(Species == "Pocillopora acuta")
```

```{r all data both seasons, warning=FALSE}
#now make an all data that has both explanatory and response variables:
all_data <- left_join(response_data, explanatory_all, by = join_by(CowTagID))
#suppress warnings because there will be a many-to-many relationship between x and y
all_data$Genotype <- as.factor(all_data$Genotype)
all_PAC_data <- all_data %>% 
  filter(Species == "Pocillopora acuta")

all_data_wide <- left_join(response_data, explanatory_all_wide, by = join_by(CowTagID))
```


```{r columns to dredge}
minimum_columns <- names(all_data_wide)[grepl("Minimum_", names(all_data_wide)) & 
                                     grepl("Salinity|Temperature|pH", names(all_data_wide))]
#LOOK OUT YOU CHANGED THIS ON APRIL 17
maximum_columns <- names(all_data_wide)[grepl("Maximum_", names(all_data_wide)) & 
                                  !grepl("Salinity|Temperature|Ammonia_umol",names(all_data_wide))]
#mean_columns <- names(all_data_wide)[grepl("Mean_", names(all_data_wide)) & 
#                                  !grepl("Salinity|Temperature|pH|Ammonia_umol",names(all_data_wide))]
CV_columns <- names(all_data_wide)[grepl("CV_", names(all_data_wide), names(all_data_wide))]

mean_low_columns <- names(all_data_wide)[grepl("Low_Tide_Mean_", names(all_data_wide), names(all_data_wide))]

#PAC_model_data$CV_Salinity_scaled <- scale(PAC_model_data$CV_Salinity, TRUE, TRUE)
#PAC_model_data$CV_Temperature_scaled  <-  scale(PAC_model_data$CV_Temperature, TRUE, TRUE)
#PAC_model_data$CV_TA_scaled  <-  scale(PAC_model_data$CV_TA, TRUE, TRUE)
#PAC_model_data$CV_pH_scaled  <-  scale(PAC_model_data$CV_pH, TRUE, TRUE)
#PAC_model_data$Low_Tide_Mean_Phosphate_umolL_scaled<-
#  scale(PAC_model_data$Low_Tide_Mean_Phosphate_umolL, TRUE, TRUE)
#PAC_model_data$Low_Tide_Mean_NN_umolL_scaled  <-  
#  scale(PAC_model_data$Low_Tide_Mean_NN_umolL, TRUE, TRUE)
#PAC_model_data$Low_Tide_Mean_Ammonia_umolL_scaled  <-
#  scale(PAC_model_data$Low_Tide_Mean_Ammonia_umolL, TRUE, TRUE)
#PAC_model_data$Low_Tide_Mean_NNP_umolL_scaled <- 
#  scale(PAC_model_data$Low_Tide_Mean_Ammonia_umolL, TRUE, TRUE)


for (col in CV_columns) {
  scaled_variable <- paste0(col, "_scaled")
  scaled_values <- scale(all_data_wide[[col]], TRUE, TRUE)
  all_data_wide[[scaled_variable]] <- scaled_values[, 1]
}

for (col in mean_low_columns) {
  scaled_variable <- paste0(col, "_scaled")
  scaled_values <- scale(all_data_wide[[col]], TRUE, TRUE)
  all_data_wide[[scaled_variable]] <- scaled_values[, 1]
}

for (col in minimum_columns) {
  scaled_variable <- paste0(col, "_scaled")
  scaled_values <- scale(all_data_wide[[col]], TRUE, TRUE)
  all_data_wide[[scaled_variable]] <- scaled_values[, 1]
}

for (col in maximum_columns) {
  scaled_variable <- paste0(col, "_scaled")
  scaled_values <- scale(all_data_wide[[col]], TRUE, TRUE)
  all_data_wide[[scaled_variable]] <- scaled_values[, 1]
}

scaled_cv_columns <- names(all_data_wide)[grepl("^CV.*_scaled$", names(all_data_wide))]
scaled_ml_columns <- names(all_data_wide)[grepl("^Low.*_scaled$", names(all_data_wide))]
scaled_min_columns <- names(all_data_wide)[grepl("^Minimum.*_scaled$", names(all_data_wide))]
scaled_max_columns <- names(all_data_wide)[grepl("^Maximum.*_scaled$", names(all_data_wide))]

# Extract column names for filtering
selected_columns <- c("FSC.Events_per_cm_2", "Percent_Change", "Genotype", "Cage_Uncaged", "Species",
                      minimum_columns, 
                      maximum_columns,
                      CV_columns,
                      mean_low_columns,
                      scaled_min_columns, 
                      scaled_max_columns,
                      scaled_cv_columns,
                      scaled_ml_columns)


model_data <- all_data_wide[, selected_columns]


PAC_model_data <- na.omit(model_data %>% 
                            filter(Species == "Pocillopora acuta")) #%>%
# filter(Cage_Uncaged == "C")

PRU_model_data <- na.omit(model_data %>% 
        filter(Species == "Porites rus")) # %>% 
#  filter(Cage_Uncaged == "C")

dredge.data <- na.omit(model_data[, c(maximum_columns, 
                                    minimum_columns #,
#                                    mean_columns, #removed bc not enough data for the amount of variables
#                                    CV_columns,
#                      CV_columns,
#                      mean_low_columns,
#                      scaled_min_columns, 
#                      scaled_max_columns,
#                      scaled_cv_columns,
#                      scaled_ml_columns
)])
```
## Data Exploration:
Data exploration focuses on the following points:
1. Outliers
2. Collinearity
3. Independence (Relationships between response and explanatory variables) 

```{r response data hist, fig.width=10, fig.height=10, echo=FALSE}
#png("output/response_data_hist.png", width = 1100, height = 1100)
par(mfrow = c(4,4), oma=c(1,1,3,1))
hist(PAC_response_data$Change_Over_Area, main="Change Over Area", col="lightblue", xlab="Change_Over_Area")
hist_columns <- c(7:13)
for (i in 1:length(hist_columns)) {
  hist(PAC_response_data[, hist_columns[i]], col="lightblue", 
       main = paste("PAC", colnames(PAC_response_data)[hist_columns[i]], sep=" - "),
       xlab=colnames(data)[hist_columns[i]])
}
hist(PRU_response_data$Change_Over_Area, main="Change Over Area", col="darkolivegreen3", xlab="Change_Over_Area")
for (i in 1:length(hist_columns)) {
  hist(PRU_response_data[, hist_columns[i]], col="darkolivegreen3", 
       main = paste("PRU", colnames(PRU_response_data)[hist_columns[i]], sep=" - "),
       xlab=colnames(data)[hist_columns[i]])
}
main_title <- "Response Data Exploration"
title(main = main_title, outer = TRUE)
#dev.off()
```

Ok so FSC.Events are both pretty right-skewed. CN says log10 transform these.

```{r wet season raw growth data plots, echo=FALSE, fig.width=15, fig.height=15}
species <- unique(all_data_seasonal$Species)
for (sp in species) {
  # Filter data for the current species and only caged
  species_data <- all_data_seasonal %>%
    filter(Species == sp, Cage_Uncaged == "C")
  
  # Create plot for the current species
  plot <- species_data %>%
    ggplot(aes(x = value, y = Percent_Change)) +
    geom_point() +
    geom_smooth(method = "lm") +
    facet_wrap(~ Parameter, scales = "free_x") +
    ggtitle(paste(sp)) +  #Add species name to the plot title
    theme_bw()
  # Print and save the plot
  print(plot)
#  ggsave(filename = paste("output/wet_raw_growth_data_response_plot_", sp, ".png", sep = ""),
#         plot = plot, 
#         width = 15, height = 15)
}
```
Now, doing this again but for both seasons combined:
```{r both season raw growth data plots, fig.width=15, fig.height=15}
species <- unique(all_data$Species)
for (sp in species) {
  # Filter data for the current species and only caged
  species_data <- all_data %>%
    filter(Species == sp, Cage_Uncaged == "C")
  
  # Create plot for the current species
  plot <- species_data %>%
    ggplot(aes(x = value, y = Percent_Change)) +
    geom_point() +
    geom_smooth(method = "lm") +
    facet_wrap(~ Parameter, scales = "free_x") +
    ggtitle(paste(sp)) +  #Add species name to the plot title
    theme_bw()
  # Print and save the plot
  print(plot)
  #ggsave(filename = paste("output/raw_growth_data_response_plot_", sp, ".png", sep = ""),
  #       plot = plot, 
  #       width = 15, height = 15)
}
```

Same but let's do for FCM data

```{r wet season raw symbiont count plots, echo=FALSE, fig.width=15, fig.height=15}
species <- unique(all_data_seasonal$Species)
for (sp in species) {
  # Filter data for the current species and only caged
  species_data <- all_data_seasonal %>%
    filter(Species == sp, Cage_Uncaged == "C")
  
  # Create plot for the current species
  plot <- species_data %>%
    ggplot(aes(x = value, y = FSC.Events_per_cm_2)) +
    geom_point() +
    geom_smooth(method = "lm") +
    facet_wrap(~ Parameter, scales = "free_x") +
    ggtitle(paste(sp)) +  #Add species name to the plot title
    theme_bw()
  # Print and save the plot
  print(plot)
  ggsave(filename = paste("output/wet_raw_symbiong_count_response_plot_", sp, ".png", sep = ""),
         plot = plot, 
         width = 15, height = 15)
}
```

And again, now for both seasons:
```{r both seasons raw symbiont count plots, echo=FALSE, fig.width=15, fig.height=15}
species <- unique(all_data$Species)
for (sp in species) {
  # Filter data for the current species and only caged
  species_data <- all_data %>%
    filter(Species == sp, Cage_Uncaged == "C")
  
  # Create plot for the current species
  plot <- species_data %>%
    ggplot(aes(x = value, y = log10(FSC.Events_per_cm_2))) +
    geom_point() +
    geom_smooth(method = "lm") +
    facet_wrap(~ Parameter, scales = "free_x") +
    ggtitle(paste(sp)) +  #Add species name to the plot title
    theme_bw()
  # Print and save the plot
  print(plot)
  #ggsave(filename = paste("output/raw_growth_data_response_plot_", sp, ".png", sep = ""),
  #       plot = plot, 
  #       width = 15, height = 15)
}
```

```{r growth change by symbionts}
response_data %>% 
  filter(Cage_Uncaged == "C") %>% 
  ggplot(aes(y = Percent_Change, x = log10(FSC.Events_per_cm_2)))+
  geom_point() +
  ggtitle("Change in BW by Number of Symbionts") +
#  geom_text(aes(label = Pin_Number)) +
  facet_wrap(~ Species, scales = "free")
```


```{r bw change in rus vs acuta}
BW_long <- response_data %>% 
  filter(Cage_Uncaged == "C") %>%
  dplyr::select(Species, Percent_Change,Pin_Number ) %>%
  group_by(Species, Pin_Number)%>%
  summarise(Percent_ChangeM  = mean(Percent_Change, na.rm = TRUE)) %>% 
  pivot_wider(names_from = "Species",
              values_from = "Percent_ChangeM")

ggplot(data = BW_long, aes(x = `Pocillopora acuta`, y = `Porites rus`))+
  geom_point()
  
```

```{r maybe its polynomial}
ggplot(data = model_data, aes(x = Maximum_Silicate_umolL, y = Percent_Change))+
  geom_point()+
  geom_smooth(method = "lm", formula = "y~poly(x,2)") +
  facet_wrap(~Species)
```


#### Look for Outliers:
Buoyant Weight
It looks like that 13 A is really off. We know it broke, so I am removing it and replotted next to it:
```{r BW Outlier Tidy, echo=FALSE}
# BW Plot
BW <- merge(BW, meta[, c("Placement_Code", "Cage_Uncaged")], by = "Placement_Code")
BW_no <- BW[!(BW$Placement_Code == "PRU V13 A"), ]
```

Now making a plot to look at outliers:
```{r BW Outlier Plot, echo=FALSE}
par(mar = c(2.5, 1, 1, 1) + 0.1)
layout(matrix(1:2, nrow = 2), heights = c(3, 3))
dotchart(BW$Change_Over_Area, main = "∆BW", 
         groups = BW$Cage_Uncaged)
dotchart(BW_no$Change_Over_Area, main = "∆BW removed erroneous data point", 
         groups = BW_no$Cage_Uncaged)
layout(1)
```
I removed PRU V13 A placement because this was broken in the field, creating a large negative change in buoyant weight. 

TLE
```{r TLE Plot, echo=FALSE}
TLE <- merge(TLE, meta[, c("Placement_Code", "Cage_Uncaged")], by = "Placement_Code")
layout(matrix(c(1, 2, 3, 4), 2, 2, byrow = TRUE)) # Setting up the layout
dotchart(TLE$Max_L_AVG, main = "Max L", groups = TLE$Cage_Uncaged) # Side Max L Plot
dotchart(TLE$Max_L_Basal, main = "Max L Basal", groups = TLE$Cage_Uncaged) # Basal Max L plot
dotchart(TLE$Area_AVG, main = "Area", groups = TLE$Cage_Uncaged) # Area plot
dotchart(TLE$Area_Basal, main = "Basal Area", groups = TLE$Cage_Uncaged) # Basal Area plot
layout(1) # Reset the layout
title("TLE Outlier Dotchart", line = -1, outer = TRUE, cex.main = 1.5)
```

### Symbionts

```{r Sym plot, echo=FALSE}
FCM <- FCM[complete.cases(FCM[, "Cage_Uncaged"]), ] #Remove T0 samples by only including rows where the "Cage_Uncaged" exists
FCM$Cage_Uncaged <- as.factor(FCM$Cage_Uncaged) 
FCM_no <- FCM[!(FCM$Placement_Code == "PRU V17 C"), ]
par(mar = c(2.5, 1, 1, 1) + 0.1)
layout(matrix(1:2, nrow = 2), heights = c(3, 3))
dotchart(FCM$FSC.Events_per_cm_2, main = "Symbionts", groups = FCM$Cage_Uncaged)
dotchart(FCM_no$FSC.Events_per_cm_2, main = "Symbionts without erroneous point", groups = FCM_no$Cage_Uncaged)
layout(1)
```
Jess will rerun PRU 49 (PRU V17 C) with her samples - I likely added twice as much as needed to the sample, but for now I will omit in my analyses (using dataframe FCM_no for "no outliers")

```{r FCM Violin Plot}
ggplot(FCM, aes(x = Cage_Uncaged, y = log10(FSC.Events_per_cm_2), fill = Species)) +
  geom_violin() +
  geom_jitter(width = 0.2, height = 0, alpha = 0.5) +  # Adding jitter
  scale_fill_fish_d(option = "Acanthurus_olivaceus", alpha = 0.4, begin = 0.3, end = 1)+
  facet_wrap(~Species)+
  labs(title = expression(paste("Symbionts per ", cm^2, " by caging treatment")))+
  theme(plot.title = element_text(hjust = 0.5))
```
same but other normalization:
```{r FCM Violin Plot Dry Weight}
ggplot(FCM, aes(x = Cage_Uncaged, y = log10(FSC.Events_per_g_dry_weight), fill = Species)) +
  geom_violin() +
  geom_jitter(width = 0.2, height = 0, alpha = 0.5) +  # Adding jitter
  scale_fill_fish_d(option = "Acanthurus_olivaceus", alpha = 0.4, begin = 0.3, end = 1) +
  facet_wrap(~Species)+
  labs(title = "Symbionts per g dry weight by caging treatment")+
  theme(plot.title = element_text(hjust = 0.5))
```

### Collinearity
need to make a dataframe that's long that has all the nutrient metrics and independent variables
Here's the thing: we KNOW the nutrients are collinear
For example, here's a pairs plot for the maximum of all the nutrient values:

```{r pairs plot collinearity}
nut_wide_no_seep<- nut_wide[nut_wide$CowTagID != 'VSEEP', ]
maximum_columns <- names(nut_wide)[grepl("Maximum_", names(nut_wide)) & !grepl("Salinity|Temperature|pH|Ammonia_umol", names(nut_wide))]

ggpairs(nut_wide_no_seep[, c(maximum_columns)],progress = FALSE)
```

```{r}

```


### Independence
```{r independence}

```

### Data Analysis


FCM Data Analysis:
```{r FCM vis, echo=FALSE}
anova_PRU <- aov(FSC.Events_per_cm_2 ~ Cage_Uncaged, 
                 data = FCM_no %>% 
                   filter(Species=="Porites_rus"))
summary(anova_PRU)

#caging did not effect P. rus

anova_PAC <- aov(FSC.Events_per_cm_2 ~ Cage_Uncaged, 
                 data = FCM_no %>% 
                   filter(Species=="Pocillopora_acuta"))
summary(anova_PAC)
#caging did not effect symbionts in P. acuta
#this I have a bit of a hard time believing 
```

### UNIVARIATE Growth Models

```{r CALLIE THIS IS YOUR LOOPING CODE Singular model looping, warning=FALSE}
#make the PAC data frame longer
PAC_model_scaled_data_long <- pivot_longer(
  data = PAC_model_data[,c(1:5,32:57)],
  cols = c(Minimum_Salinity_scaled:Low_Tide_Mean_Ammonia_umolL_scaled)) 
names(PAC_model_scaled_data_long)[names(PAC_model_scaled_data_long) == "name"] <- "Parameter"

PAC_model_data_long <- pivot_longer(
  data = PAC_model_data[,c(1:5,6:31)],
  cols = c(Minimum_Salinity:Low_Tide_Mean_Ammonia_umolL)) 
names(PAC_model_data_long)[names(PAC_model_data_long) == "name"] <- "Parameter"


#make the PRU data frame longer
PRU_model_scaled_data_long <- pivot_longer(
  data = PRU_model_data[,c(1:5,32:57)],
  cols = c(Minimum_Salinity_scaled:Low_Tide_Mean_Ammonia_umolL_scaled)) 
names(PRU_model_scaled_data_long)[names(PRU_model_scaled_data_long) == "name"] <- "Parameter"

#lmer(y~poly(x,2) + (1|random effect)
```

##### linear growth pac

```{r PAC linear model all scaled parameteres against growth}
model_results <- data.frame(Parameter = character(),
                            AICc = numeric(),
                            p.value = numeric(),
                            Estimate = numeric(),
                            stringsAsFactors = FALSE)

plotlist <- list()

parameters <- unique(PAC_model_scaled_data_long$Parameter)

for (parameter in parameters) {
  # Create a subset of data for the current parameter
  subset_data <- subset(PAC_model_scaled_data_long, Parameter == parameter)
  
  # Fit the mixed-effects model
  model <- lmer(Percent_Change ~ value + (1|Genotype) + (1|Cage_Uncaged), data = subset_data)
  
  # Get AICc and p-value
    AICc <- AICc(model)
  
  # Get p-value from summary
  model_summary <- summary(model)
  p.value <- model_summary$coefficients["value", "Pr(>|t|)"]
  Estimate <- model_summary$coefficients["value", "Estimate"]
  
  # Calculate marginal and conditional R-squared values
    rsq <- as.numeric(r.squaredGLMM(model))
    marginal_R2 <- rsq[1]
    conditional_R2 <- rsq[2]
  
  if (p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = AICc,
                                                     p.value = p.value,
                                                     Estimate = Estimate,
                                                     Marginal_R2 = marginal_R2,
                                                     Conditional_R2 = conditional_R2))
    
    # Create an effects plot using ggpredict
    effect_plot <- ggpredict(model, terms = "value[all]")
    
    # Extract the ggplot object from the ggpredict object
    ggplot_obj <- plot(effect_plot)
    
    # Add the ggplot object to the plotlist
    plotlist[[parameter]] <- ggplot_obj + ggtitle(parameter)
  }
  }
print(model_results)
grid.arrange(grobs = plotlist, ncol = 2)

model_results$Species <- "Pocillopora acuta"
model_results$type <- "linear"

all_PAC_growth_model_results <- model_results

```

##### polynomial growth PAC

```{r PAC polynomial model all scaled parameteres against growth}
model_results <- data.frame(Parameter = character(),
                            AICc = numeric(),
                            p.value = numeric(),
                            Estimate = numeric(),
                            stringsAsFactors = FALSE)
plotlist <- list()

parameters <- unique(PAC_model_scaled_data_long$Parameter)

for (parameter in parameters) {
  # Create a subset of data for the current parameter
  subset_data <- subset(PAC_model_scaled_data_long, Parameter == parameter)
  
  # Fit the mixed-effects model
  model <- lmer(Percent_Change ~ poly(value,2) + (1|Genotype) + (1|Cage_Uncaged), data = subset_data)
  
  # Get AICc and p-value
  AICc <- AICc(model)
  
  # Get p-value from summary
  model_summary <- summary(model)
  p.value <- model_summary$coefficients["poly(value, 2)1", "Pr(>|t|)"]
  Estimate <- model_summary$coefficients["poly(value, 2)1", "Estimate"]
  
  # Calculate marginal and conditional R-squared values
    rsq <- as.numeric(r.squaredGLMM(model))
    marginal_R2 <- rsq[1]
    conditional_R2 <- rsq[2]
  
  if (p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = AICc,
                                                     p.value = p.value,
                                                     Estimate = Estimate,
                                                     Marginal_R2 = marginal_R2,
                                                     Conditional_R2 = conditional_R2))
    
    # Create an effects plot using ggpredict
    effect_plot <- ggpredict(model, terms = "value[all]")
    
    # Extract the ggplot object from the ggpredict object
    ggplot_obj <- plot(effect_plot)
    
    # Add the ggplot object to the plotlist
    plotlist[[parameter]] <- ggplot_obj + ggtitle(parameter)
  }
  }

model_results %>% filter(p.value < 0.05)
grid.arrange(grobs = plotlist, ncol = 2)

model_results$Species <- "Pocillopora acuta"
model_results$type <- "polynomial"

all_PAC_growth_model_results <- rbind(model_results, all_PAC_growth_model_results)
```


#### linear PAC symb

```{r model all parameteres scaled against symbiont, warning=FALSE, message=FALSE}
model_results <- data.frame(Parameter = character(),
                            AICc = numeric(),
                            p.value = numeric(),
                            Estimate = numeric(),
                            stringsAsFactors = FALSE)

plotlist <- list()

parameters <- unique(PAC_model_scaled_data_long$Parameter)

for (parameter in parameters) {
  # Create a subset of data for the current parameter
  subset_data <- subset(PAC_model_scaled_data_long, Parameter == parameter)
  
  # Fit the mixed-effects model
  model <- lmer(log10(FSC.Events_per_cm_2) ~ value + (1|Genotype) + (1|Cage_Uncaged), data = subset_data)
  
  # Get AICc and p-value
    AICc <- AICc(model)
  
  # Get p-value from summary
  model_summary <- summary(model)
  p.value <- model_summary$coefficients["value", "Pr(>|t|)"]
  Estimate <- model_summary$coefficients["value", "Estimate"]
  
if (p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = AICc,
                                                     p.value = p.value,
                                                     Estimate = Estimate))
    
    # Create an effects plot using ggpredict
    effect_plot <- ggpredict(model, terms = "value[all]")
    
    # Extract the ggplot object from the ggpredict object
    ggplot_obj <- plot(effect_plot)
    
    # Add the ggplot object to the plotlist
    plotlist[[parameter]] <- ggplot_obj + ggtitle(parameter)
  }
  }
model_results %>% filter(p.value < 0.05)
#grid.arrange(grobs = plotlist, ncol = 2)

model_results$Species <- "Pocillopora acuta"
model_results$type <- "linear"
all_PAC_symb_model_results <- model_results
```

So, nothing is changing the symbionts in acuta...

##### PRU linear growth

```{r PRU all variables scaled against growth, message=FALSE}
model_results <- data.frame(Parameter = character(),
                            AICc = numeric(),
                            p.value = numeric(),
                            Estimate = numeric(),
                            stringsAsFactors = FALSE)
plotlist <- list()

parameters <- unique(PRU_model_scaled_data_long$Parameter)

for (parameter in parameters) {
  # Create a subset of data for the current parameter
  subset_data <- subset(PRU_model_scaled_data_long, Parameter == parameter)
  
  # Fit the mixed-effects model
  model <- lmer(Percent_Change ~ value + (1|Genotype) + (1|Cage_Uncaged), data = subset_data)
  
  # Get AICc
  AICc <- AICc(model)
  
  # Get p-value from summary
  model_summary <- summary(model)
  p.value <- model_summary$coefficients["value", "Pr(>|t|)"]
  Estimate <- model_summary$coefficients["value", "Estimate"]
  
 if (p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = AICc,
                                                     p.value = p.value,
                                                     Estimate = Estimate))
    
    # Create an effects plot using ggpredict
    effect_plot <- ggpredict(model, terms = "value[all]")
    
    # Extract the ggplot object from the ggpredict object
    ggplot_obj <- plot(effect_plot)
    
    # Add the ggplot object to the plotlist
    plotlist[[parameter]] <- ggplot_obj + ggtitle(parameter)
  }
  }
model_results %>% filter(p.value < 0.05)
grid.arrange(grobs = plotlist, ncol = 2)

model_results$Species <- "Porites rus"
model_results$type <- "linear"

all_PRU_growth_model_results <- model_results
```


```{r PRU symbionts}
model_results <- data.frame(Parameter = character(),
                            AICc = numeric(),
                            p.value = numeric(),
                            Estimate = numeric(),
                            stringsAsFactors = FALSE)
plotlist <- list()

parameters <- unique(PRU_model_scaled_data_long$Parameter)

for (parameter in parameters) {
  # Create a subset of data for the current parameter
  subset_data <- subset(PRU_model_scaled_data_long, Parameter == parameter)
  
  # Fit the mixed-effects model
  model <- lmer(log10(FSC.Events_per_cm_2) ~ value + (1|Genotype) + Cage_Uncaged, data = subset_data)
  
  # Get AICc and p-value
    AICc <- AICc(model)
  
  # Get p-value from summary
  model_summary <- summary(model)
  p.value <- model_summary$coefficients["value", "Pr(>|t|)"]
  Estimate <- model_summary$coefficients["value", "Estimate"]
  
 if (p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = AICc,
                                                     p.value = p.value,
                                                     Estimate = Estimate))
    
    # Create an effects plot using ggpredict
    effect_plot <- ggpredict(model, terms = "value[all]")
    
    # Extract the ggplot object from the ggpredict object
    ggplot_obj <- plot(effect_plot)
    
    # Add the ggplot object to the plotlist
    plotlist[[parameter]] <- ggplot_obj + ggtitle(parameter)
  }
  }
model_results %>% filter(p.value < 0.05)
grid.arrange(grobs = plotlist, ncol = 2)


model_results$Species <- "Porites rus"
model_results$type <- "linear"

all_PRU_symb_model_results <- model_results
```
#### Polynomial models
lmer(y~poly(x,2) + (1|random effect)

```{r polynomialmodel all parameteres scaled against symbiont, warning=FALSE, message=FALSE}
model_results <- data.frame(Parameter = character(),
                            AICc = numeric(),
                            p.value = numeric(),
                            Estimate = numeric(),
                            stringsAsFactors = FALSE)
plotlist <- list()

parameters <- unique(PAC_model_scaled_data_long$Parameter)

for (parameter in parameters) {
  # Create a subset of data for the current parameter
  subset_data <- subset(PAC_model_scaled_data_long, Parameter == parameter)

  # Fit the mixed-effects model
  model <- lmer(log10(FSC.Events_per_cm_2) ~ poly(value,2) + (1|Genotype) + (1|Cage_Uncaged), data = subset_data)
  
  # Get AICc and p-value
  AICc <- AICc(model)
  
  # Get p-value from summary
  model_summary <- summary(model)
  p.value <- model_summary$coefficients["poly(value, 2)1", "Pr(>|t|)"]
  Estimate <- model_summary$coefficients["poly(value, 2)1", "Estimate"]
  
  if (p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = AICc,
                                                     p.value = p.value,
                                                     Estimate = Estimate))
    
    # Create an effects plot using ggpredict
    effect_plot <- ggpredict(model, terms = "value")
    
    # Extract the ggplot object from the ggpredict object
    ggplot_obj <- plot(effect_plot)
    
    # Add the ggplot object to the plotlist
    plotlist[[parameter]] <- ggplot_obj + ggtitle(parameter)
  }
  }

model_results %>% filter(p.value < 0.05)
#grid.arrange(grobs = plotlist, ncol = 1)

model_results$Species <- "Pocillopora acuta"
model_results$type <- "polynomial"

all_PAC_symb_model_results <- rbind(model_results, all_PAC_symb_model_results)
```

So, nothing is changing the symbionts in acuta...

```{r PRU polynomial all variables scaled against growth, message=FALSE}
model_results <- data.frame(Parameter = character(),
                            AICc = numeric(),
                            p.value = numeric(),
                            Estimate = numeric(),
                            stringsAsFactors = FALSE)
plotlist <- list()

parameters <- unique(PRU_model_scaled_data_long$Parameter)

for (parameter in parameters) {
  # Create a subset of data for the current parameter
  subset_data <- subset(PRU_model_scaled_data_long, Parameter == parameter)
  
  # Fit the mixed-effects model
  model <- lmer(Percent_Change ~ poly(value,2) + (1|Genotype) + (1|Cage_Uncaged), data = subset_data)
  
  # Get AICc and p-value
  AICc <- AICc(model)
  
  # Get p-value from summary
  model_summary <- summary(model)
  p.value <- model_summary$coefficients["poly(value, 2)1", "Pr(>|t|)"]
  Estimate <- model_summary$coefficients["poly(value, 2)1", "Estimate"]
  
  if (p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = AICc,
                                                     p.value = p.value,
                                                     Estimate = Estimate))
    
    # Create an effects plot using ggpredict
    effect_plot <- ggpredict(model, terms = "value")
    
    # Extract the ggplot object from the ggpredict object
    ggplot_obj <- plot(effect_plot)
    
    # Add the ggplot object to the plotlist
    plotlist[[parameter]] <- ggplot_obj + ggtitle(parameter)
  }
  }

model_results %>% filter(p.value < 0.05)
grid.arrange(grobs = plotlist, ncol = 2)

model_results$Species <- "Porites rus"
model_results$type <- "polynomial"

all_PRU_growth_model_results <- model_results
```



```{r PRU symbionts polynomial, message=FALSE}
model_results <- data.frame(Parameter = character(),
                            AICc = numeric(),
                            p.value = numeric(),
                            Estimate = numeric(),
                            stringsAsFactors = FALSE)

plotlist <- list()

parameters <- unique(PRU_model_scaled_data_long$Parameter)

for (parameter in parameters) {
  # Create a subset of data for the current parameter
  subset_data <- subset(PRU_model_scaled_data_long, Parameter == parameter)
  
  # Fit the mixed-effects model
  model <- lmer(log10(FSC.Events_per_cm_2) ~ poly(value,2) + (1|Genotype) + (1|Cage_Uncaged), data = subset_data)
  
  # Get AICc and p-value
  AICc <- AICc(model)
  
  # Get p-value from summary
  model_summary <- summary(model)
  p.value <- model_summary$coefficients["poly(value, 2)1", "Pr(>|t|)"]
  Estimate <- model_summary$coefficients["poly(value, 2)1", "Estimate"]
  
  if (p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = AICc,
                                                     p.value = p.value,
                                                     Estimate = Estimate))
    
    # Create an effects plot using ggpredict
    effect_plot <- ggpredict(model, terms = "value")
    
    # Extract the ggplot object from the ggpredict object
    ggplot_obj <- plot(effect_plot)
    
    # Add the ggplot object to the plotlist
    plotlist[[parameter]] <- ggplot_obj + ggtitle(parameter)
  }
  }

model_results %>% filter(p.value < 0.05)
grid.arrange(grobs = plotlist, ncol = 1)

model_results$Species <- "Porites rus"
model_results$type <- "polynomial"

all_PRU_symb_model_results <- model_results
```


#### Dredged data models (aka is multiresponse better than univariate models)

```{r collinearity in cv dredge parameters}
ggpairs(PAC_model_data, columns = c("CV_Salinity_scaled",  
                       "CV_Temperature_scaled",  
                       "CV_TA_scaled",  
                       "CV_pH_scaled"), progress = FALSE)
```

```{r collinearity in pulse dredge parameters}
ggpairs(PAC_model_data, columns = c("Low_Tide_Mean_Phosphate_umolL",  
                       "Low_Tide_Mean_NN_umolL", 
                       "Low_Tide_Mean_Ammonia_umolL",
                       "Low_Tide_Mean_NNP_umolL"), progress = FALSE)
```

Extra exploratory plots:
```{r exploratory plots with bw change}
PAC_model_data_long <- pivot_longer(
  data = PAC_model_data,
  cols = c("Low_Tide_Mean_Phosphate_umolL",  
                       "Low_Tide_Mean_NN_umolL", 
                       "Low_Tide_Mean_Ammonia_umolL",
                       "Low_Tide_Mean_NNP_umolL",
           "CV_Salinity_scaled",  
                       "CV_Temperature_scaled",  
                       "CV_TA_scaled",  
                       "CV_pH_scaled"),
  names_to = "Parameter",
  values_to = "Value")

ggplot(PAC_model_data_long, aes(x = Value, y = Percent_Change)) +
    geom_point() +
    geom_smooth(method = "lm") +
    facet_wrap(~ Parameter, scales = "free") +
    theme_bw()
```


```{r exploratory plots with symb}
ggplot(PAC_model_data_long, aes(x = Value, y = FSC.Events_per_cm_2)) +
    geom_point() +
    geom_smooth(method = "lm") +
    facet_wrap(~ Parameter, scales = "free") +
    theme_bw()
```


```{r Growth Dredge CV or Low Tide Pulse, warning=FALSE, message=FALSE}
#PAC_cv_model <- glm(Percent_Change ~ ., data = PAC_cv_model_data, na.action = na.pass)
#the above line works if you only include response and explanatory in the dataframe, but dredge can't handle it with random effects

# Build the GLM model
#PAC_cv_model <- glm(Percent_Change ~ ., data = PAC_cv_model_data, na.action = na.pass)
PAC_cv_low_growth_model <- lmer(Percent_Change ~ 
                       CV_Salinity_scaled + 
                       CV_Temperature_scaled + 
                       CV_TA_scaled + 
                       CV_pH_scaled +
                       Low_Tide_Mean_Phosphate_umolL_scaled + 
                       Low_Tide_Mean_NN_umolL_scaled + 
                       Low_Tide_Mean_Ammonia_umolL_scaled +
                       Low_Tide_Mean_NNP_umolL_scaled +
                       (1 | Genotype), 
                                 data = PAC_model_data, 
                                 na.action = na.pass)

PAC_cv_low_growth_model_dredge <- dredge(PAC_cv_low_growth_model, trace = 2)
#model.sel(PAC_cv_low_growth_model_dredge)
PAC.avg_cv_low_growth_model = model.avg(PAC_cv_low_growth_model_dredge, delta < 5)
summary(PAC.avg_cv_low_growth_model)
PAC.avg_cv_low_growth_model$sw
```

Make the effects plots for the model with the most support:
```{r Growth CV + Low tide best model effects plots}
PAC_growth_cv_plus_lowtide_model <- lmer(Percent_Change ~ 
#                       CV_Salinity_scaled + 
#                       CV_Temperature_scaled + 
                       CV_TA_scaled + 
#                       CV_pH_scaled +
                       (1 | Genotype), 
                                 data = PAC_model_data, 
                                 na.action = na.pass)
plot(allEffects(PAC_growth_cv_plus_lowtide_model))
```

# April 17 Minimum Maximum models aka extremes drive change
```{r  PAC Growth Dredge Min and Max, warning=FALSE, message=FALSE}
#PAC_cv_model <- glm(Percent_Change ~ ., data = PAC_cv_model_data, na.action = na.pass)
#the above line works if you only include response and explanatory in the dataframe, but dredge can't handle it with random effects

# Build the GLM model
#PAC_cv_model <- glm(Percent_Change ~ ., data = PAC_cv_model_data, na.action = na.pass)
PAC_cv_minmax_growth_model <- lmer(Percent_Change ~ 
                       Minimum_Salinity_scaled + 
                       Minimum_Temperature_scaled + 
                       Maximum_TA_scaled + 
                       Minimum_pH_scaled +
                       Maximum_NN_umolL_scaled + 
                       Maximum_Phosphate_umolL_scaled + 
                       Maximum_NNP_umolL_scaled +
                       (1 | Genotype), 
                                 data = PAC_model_data, 
                                 na.action = na.pass)

PAC_cv_minmax_growth_model_dredge <- dredge(PAC_cv_minmax_growth_model, trace = 2)
#model.sel(PAC_cv_low_growth_model_dredge)
PAC.avg_minmax_growth_model = model.avg(PAC_cv_minmax_growth_model_dredge, delta < 10)
summary(PAC.avg_minmax_growth_model)
PAC.avg_minmax_growth_model$sw
```

```{r PRU Growth Dredge Min and Max, warning=FALSE, message=FALSE}
PRU_cv_minmax_growth_model <- lmer(Percent_Change ~ 
                       Minimum_Salinity_scaled + 
                       Minimum_Temperature_scaled + 
                       Maximum_TA_scaled + 
                       Minimum_pH_scaled +
                       Maximum_NN_umolL_scaled + 
                       Maximum_Phosphate_umolL_scaled + 
                       Maximum_NNP_umolL_scaled +
                       (1 | Genotype), 
                                 data = PRU_model_data, 
                                 na.action = na.pass)

PRU_cv_minmax_growth_model_dredge <- dredge(PRU_cv_minmax_growth_model, trace = 2)
#model.sel(PAC_cv_low_growth_model_dredge)
PRU.avg_minmax_growth_model = model.avg(PRU_cv_minmax_growth_model_dredge, delta < 10)
summary(PRU.avg_minmax_growth_model)
PRU.avg_minmax_growth_model$sw
```

### Symbiont Count Models

```{r Symbiont data CV AND low tide data dredge, warning=FALSE, message=FALSE}
# Build the GLM model
#PAC_cv_model <- glm(Percent_Change ~ ., data = PAC_cv_model_data, na.action = na.pass)
PAC_cv_low_symb_model <- lmer(log10(FSC.Events_per_cm_2) ~
                       Low_Tide_Mean_Phosphate_umolL_scaled + 
                       Low_Tide_Mean_NN_umolL_scaled + 
                       Low_Tide_Mean_Ammonia_umolL_scaled +
                       Low_Tide_Mean_NNP_umolL_scaled +
                       (1 | Genotype) + (1 | Cage_Uncaged), 
                                 data = PAC_model_data, 
                                 na.action = na.pass)

PAC_cv_low_symb_model_dredge <- dredge(PAC_cv_low_symb_model, trace = 2)
model.sel(PAC_cv_low_symb_model_dredge)
PAC_cv_low_symb_model_dredge_model.avg = model.avg(PAC_cv_low_symb_model_dredge, delta < 8)
summary(PAC_cv_low_symb_model_dredge_model.avg)
PAC_cv_low_symb_model_dredge_model.avg$sw
```


```{r Symbiont cv and low tide best model effects plots}
PAC_symb_cv_plus_lowtide_model <- lmer(log10(FSC.Events_per_cm_2) ~ 
                       CV_Salinity + 
                       CV_Temperature + 
                       CV_TA + 
                       CV_pH +
                       (1 | Genotype) + (1 | Cage_Uncaged), 
                                 data = PAC_model_data, 
                                 na.action = na.pass)
plot(allEffects(PAC_symb_cv_plus_lowtide_model))
```


#### ISOTOPES
If you could plot their 15N and 13C host and symbiont values on 2 different plots that would be a good place to start. One plot for 15N and one for 13C and then facet by whatever your categories are (location on gradient?). Then we can look at how overlapped their isotopes are

"δ15N...........vs..AIR."
"δ13C............vs..VPDB."

```{r 15N host, fig.width=15, fig.height=15}
# species <- unique(SI_data$Species) # has NA
species <- c("Pocillopora acuta", "Porites rus" )
for (sp in species) {
  # Filter data for the current species and only caged
  species_data <- SI_data %>%
    filter(Species == sp, HS == "host")
  
  # Create plot for the current species
  plot <- species_data %>%
    ggplot(aes(x = value, y = δ15N)) +
    geom_point() +
    geom_smooth(method = "lm") +
    facet_wrap(~ Parameter, scales = "free_x") +
    ggtitle(paste(sp)) +  #Add species name to the plot title
    theme_bw()
  # Print and save the plot
  print(plot)
  #ggsave(filename = paste("output/wet_raw_growth_data_response_plot_", sp, ".png", sep = ""),
  #       plot = plot, 
  #       width = 15, height = 15)
}
```

```{r EXPLORATORY 13C host, fig.width=15, fig.height=15}
species <- c("Pocillopora acuta", "Porites rus" )
for (sp in species) {
  # Filter data for the current species and only caged
  species_data <- SI_data %>%
    filter(Species == sp, HS == "host")
  
  # Create plot for the current species
  plot <- species_data %>%
    ggplot(aes(x = value, y = δ13C)) +
    geom_point() +
    geom_smooth(method = "lm") +
    facet_wrap(~ Parameter, scales = "free") +
    ggtitle(paste(sp)) +  #Add species name to the plot title
    theme_bw()
  # Print and save the plot
  print(plot)
  #ggsave(filename = paste("output/wet_raw_growth_data_response_plot_", sp, ".png", sep = ""),
  #       plot = plot, 
  #       width = 15, height = 15)
}
```

```{r EXPLORATORY 13C symb, fig.width=15, fig.height=15}
species <- c("Pocillopora acuta", "Porites rus" )
for (sp in species) {
  # Filter data for the current species and only caged
  species_data <- SI_data %>%
    filter(Species == sp, HS == "symb")
  
  # Create plot for the current species
  plot <- species_data %>%
    ggplot(aes(x = value, y = δ13C)) +
    geom_point() +
    geom_smooth(method = "lm") +
    facet_wrap(~ Parameter, scales = "free") +
    ggtitle(paste(sp)) +  #Add species name to the plot title
    theme_bw()
  # Print and save the plot
  print(plot)
  #ggsave(filename = paste("output/wet_raw_growth_data_response_plot_", sp, ".png", sep = ""),
  #       plot = plot, 
  #       width = 15, height = 15)
}
```


```{r EXPLORATORY 15N symb, fig.width=15, fig.height=15}
species <- c("Pocillopora acuta", "Porites rus" )
for (sp in species) {
  # Filter data for the current species and only caged
  species_data <- SI_data %>%
    filter(Species == sp, HS == "symb")
  
  # Create plot for the current species
  plot <- species_data %>%
    ggplot(aes(x = value, y = δ15N)) +
    geom_point() +
    geom_smooth(method = "lm") +
    facet_wrap(~ Parameter, scales = "free_x") +
    ggtitle(paste(sp)) +  #Add species name to the plot title
    theme_bw()
  # Print and save the plot
  print(plot)
  #ggsave(filename = paste("output/wet_raw_growth_data_response_plot_", sp, ".png", sep = ""),
  #       plot = plot, 
  #       width = 15, height = 15)
}
```

```{r}
plot1 <- SI_data_wide %>%
    filter(Species == "Porites rus", HS == "symb") %>% 
    ggplot(aes(x = pulse_pc1, y = δ15N)) +
    geom_point() +
    geom_smooth(method = "lm") +
    ggtitle("Porites rus symb δ15N") +  #Add species name to the plot title
    theme_bw()

plot2 <- SI_data_wide %>%
    filter(Species == "Porites rus", HS == "host") %>% 
    ggplot(aes(x = pulse_pc1, y = δ15N)) +
    geom_point() +
    geom_smooth(method = "lm") +
    ggtitle("Porites rus host δ15N") +  #Add species name to the plot title
    theme_bw()

plot3 <- SI_data_wide %>%
    filter(Species == "Pocillopora acuta", HS == "symb") %>% 
    ggplot(aes(x = pulse_pc1, y = δ15N)) +
    geom_point() +
    geom_smooth(method = "lm") +
    ggtitle("Pocillopora acuta symb δ15N") +  #Add species name to the plot title
    theme_bw()

plot4 <- SI_data_wide %>%
    filter(Species == "Pocillopora acuta", HS == "host") %>% 
    ggplot(aes(x = pulse_pc1, y = δ15N)) +
    geom_point() +
    geom_smooth(method = "lm") +
    ggtitle("Pocillopora acuta host δ15N") +  #Add species name to the plot title
    theme_bw()

grid.arrange(plot1, plot2, plot3, plot4, ncol = 2)
```

```{r}
plot1 <- SI_data_wide %>%
    filter(Species == "Porites rus", HS == "symb") %>% 
    ggplot(aes(x = pulse_pc1, y = δ13C)) +
    geom_point() +
    geom_smooth(method = "lm") +
    ggtitle("Porites rus symb δ13C") +  #Add species name to the plot title
    theme_bw()

plot2 <- SI_data_wide %>%
    filter(Species == "Porites rus", HS == "host") %>% 
    ggplot(aes(x = pulse_pc1, y = δ13C)) +
    geom_point() +
    geom_smooth(method = "lm") +
    ggtitle("Porites rus host δ13C") +  #Add species name to the plot title
    theme_bw()

plot3 <- SI_data_wide %>%
    filter(Species == "Pocillopora acuta", HS == "symb") %>% 
    ggplot(aes(x = pulse_pc1, y = δ13C)) +
    geom_point() +
    geom_smooth(method = "lm") +
    ggtitle("Pocillopora acuta symb δ13C") +  #Add species name to the plot title
    theme_bw()

plot4 <- SI_data_wide %>%
    filter(Species == "Pocillopora acuta", HS == "host") %>% 
    ggplot(aes(x = pulse_pc1, y = δ13C)) +
    geom_point() +
    geom_smooth(method = "lm") +
    ggtitle("Pocillopora acuta host δ13C") +  #Add species name to the plot title
    theme_bw()

grid.arrange(plot1, plot2, plot3, plot4, ncol = 2)
```



