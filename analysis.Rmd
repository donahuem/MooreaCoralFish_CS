---
title: "Coral Growth and Symbionts Analysis"
author: "Callie Stephenson"
date: "2023-08-29"
output: github_document
---
## Introduction

This is a R Markdown file in which I hope to write out my analyses. I will use this document to process all the R scripts found in the R folder and complete my project. 

#### Loading the data
```{r load packages, echo=FALSE, message=FALSE}
library(tidyverse)
library(here)
library(ggrepel)
library(patchwork)
library(tidytext)
library(AICcmodavg)
library(kableExtra)
library(PNWColors)
library(fishualize)
library(lme4)
library(lmerTest) #figure out which lme package you need
library(ggpp)
library(ggplot2)
library(GGally)
library(ggeffects)
library(arm) #discrete hist
library(MuMIn) #dredge
library(effects) #effects plots for dredged models
library(curl) #curl
library(gridExtra)
library(vegan) #pcoa
```


```{r load data, echo=FALSE, message=FALSE}
#explanatory data
all_nut <- read.csv("data/All_Nutrients_Processed.csv")
nut <- read.csv("data/March_nutrients_processed.csv")
nut_wide <- read.csv("data/Nutrient_data_wide.csv")
explanatory_seasonal <- read.csv("data/Explanatory_variables.csv")
turb <- read_csv("https://raw.githubusercontent.com/dbarnas/Community_Functional_Diversity/main/Data/Biogeochem/August2021/Turb_NC.csv")

#explanatory 2
#cv_low_wet <- read.csv("data/Wet_Nutrients_Processed_CV_Low.csv")
#cv_low_all <- read.csv("data/All_Nutrients_Processed_CV_Low.csv")

#Response data
sa <- read.csv("data/Surface_Area.csv")
BW <- read.csv("data/BW_tidy.csv") 
BW <- subset(BW, select=-c(1,4,5)) #remove some erroneous columns
TLE <- read.csv("data/TLE_summary.csv")
FCM <- read.csv("data/FCM_tidy.csv") %>% 
  rename(Placement_Code = PLACEMENT)
SI <- read.csv("data/SI_Tidy.csv")

SI_join <- SI[,c("HS","δ15N", "δ13C", "Placement_Code","Pin_Number", "Cage_Uncaged", "Genotype", "Species", "CowTagID", "Δ15N", "Δ13C", "C_N_ratio","δ15N_T1_T0", "δ13C_T1_T0", "Δ15N_T1T0","Δ13C_T1T0")] %>%
  pivot_wider(names_from = HS, values_from = c("δ15N", "δ13C", "C_N_ratio","δ15N_T1_T0", "δ13C_T1_T0", "Δ15N_T1T0","Δ13C_T1T0"), names_sep = "_")

#metadata
meta <- read.csv("data/coral_metadata.csv")

#Mean Low Tide Value PCA 1 Axis
PCA_Pulse_variables_wide <- read.csv("data/PCA_Pulse_variables_wide.csv")
#explan <- read.csv("data/Explanatory_variables_wide.csv")
```


```{r clean turb}
turb1 <- turb %>% 
  filter(startsWith(CowTagID, "V")& CowTagID != "VSEEP")

turb1 <- turb1 %>%
  dplyr::select(c(CowTagID,
                   N_percent,
                   C_N))
#use C:N 
#can also use N percent
#plot(turb$C_N, turb$N_percent)
#hist(turb$C_N)
#hist(turb$N_percent)
#N_percent looks better. Will use N_percent for models
```

```{r build explanatory}
all_nut_long <- pivot_longer(
  data = all_nut,
  cols = c(Minimum_Salinity:Low_Tide_Mean_Ammonia_umolL)) 
names(all_nut_long)[names(all_nut_long) == "name"] <- "Parameter"

join <- explanatory_seasonal[,c(2:7)]
join <- unique(join)

explanatory_all <- left_join(join,all_nut_long, by = join_by(CowTagID))
explanatory_all_wide <- left_join(join, all_nut,by = join_by(CowTagID))
explanatory_all_wide <- left_join(explanatory_all_wide, turb1,by = join_by(CowTagID))
explanatory_all_wide <- left_join(explanatory_all_wide, PCA_Pulse_variables_wide,by = join_by(CowTagID))
```


```{r build response, echo=FALSE}
#make a master response variable data sheet
response_data <- left_join(meta[,c(2:4,7,8)], BW[,c(2,4,5,6)], by = join_by(Placement_Code)) %>% 
  #select(!X) %>% #check that this doesn't need to be here
  left_join(FCM[,c(1,16,17)], by = join_by(Placement_Code)) %>% 
  left_join(TLE[,c(3:7)], by = join_by(Placement_Code)) %>% 
  left_join(SI_join[,c(1,4,6:18)], by = join_by(Placement_Code, Genotype))
response_data$CowTagID <- paste0("V",response_data$Pin_Number)

PRU_response_data <- response_data %>% 
  filter(Species == "Porites rus")

PRU_response_data_caged <- PRU_response_data %>% 
  filter(Cage_Uncaged == "C")

PAC_response_data <- response_data %>% 
  filter(Species == "Pocillopora acuta")

PAC_response_data_caged <- PAC_response_data %>% 
  filter(Cage_Uncaged == "C")
```


```{r all data seasonal, warning=FALSE}
#now make an all data that has both explanatory and response variables:
all_data_seasonal <- left_join(response_data, explanatory_seasonal, by = join_by(CowTagID))
#suppress warnings because there will be a many-to-many relationship between x and y
all_data_seasonal$Genotype <- as.factor(all_data_seasonal$Genotype)
all_PAC_data_seasonal <- all_data_seasonal %>% 
  filter(Species == "Pocillopora acuta")
```

```{r all data both seasons, warning=FALSE}
#now make an all data that has both explanatory and response variables:
all_data <- left_join(response_data, explanatory_all, by = join_by(CowTagID))
#suppress warnings because there will be a many-to-many relationship between x and y
all_data$Genotype <- as.factor(all_data$Genotype)
all_PAC_data <- all_data %>% 
  filter(Species == "Pocillopora acuta")

all_data_wide <- left_join(response_data, explanatory_all_wide, by = join_by(CowTagID))
```


```{r columns to dredge}
minimum_columns <- names(all_data_wide)[grepl("Minimum_", names(all_data_wide)) & 
                                     grepl("Salinity|Temperature|pH", names(all_data_wide))]
#LOOK OUT YOU CHANGED THIS ON APRIL 17
maximum_columns <- names(all_data_wide)[grepl("Maximum_", names(all_data_wide)) & 
                                  !grepl("Salinity|Temperature|Ammonia_umol",names(all_data_wide))]
#mean_columns <- names(all_data_wide)[grepl("Mean_", names(all_data_wide)) & 
#                                  !grepl("Salinity|Temperature|pH|Ammonia_umol",names(all_data_wide))]
CV_columns <- names(all_data_wide)[grepl("CV_", names(all_data_wide), names(all_data_wide))]

mean_low_columns <- names(all_data_wide)[grepl("Low_Tide_Mean_", names(all_data_wide), names(all_data_wide))]

variance_columns <- names(all_data_wide)[grepl("sd_", names(all_data_wide), names(all_data_wide))]

#PAC_model_data$CV_Salinity_scaled <- scale(PAC_model_data$CV_Salinity, TRUE, TRUE)
#PAC_model_data$CV_Temperature_scaled  <-  scale(PAC_model_data$CV_Temperature, TRUE, TRUE)
#PAC_model_data$CV_TA_scaled  <-  scale(PAC_model_data$CV_TA, TRUE, TRUE)
#PAC_model_data$CV_pH_scaled  <-  scale(PAC_model_data$CV_pH, TRUE, TRUE)
#PAC_model_data$Low_Tide_Mean_Phosphate_umolL_scaled<-
#  scale(PAC_model_data$Low_Tide_Mean_Phosphate_umolL, TRUE, TRUE)
#PAC_model_data$Low_Tide_Mean_NN_umolL_scaled  <-  
#  scale(PAC_model_data$Low_Tide_Mean_NN_umolL, TRUE, TRUE)
#PAC_model_data$Low_Tide_Mean_Ammonia_umolL_scaled  <-
#  scale(PAC_model_data$Low_Tide_Mean_Ammonia_umolL, TRUE, TRUE)
#PAC_model_data$Low_Tide_Mean_NNP_umolL_scaled <- 
#  scale(PAC_model_data$Low_Tide_Mean_Ammonia_umolL, TRUE, TRUE)


for (col in CV_columns) {
  scaled_variable <- paste0(col, "_scaled")
  scaled_values <- scale(all_data_wide[[col]], TRUE, TRUE)
  all_data_wide[[scaled_variable]] <- scaled_values[, 1]
}

for (col in mean_low_columns) {
  scaled_variable <- paste0(col, "_scaled")
  scaled_values <- scale(all_data_wide[[col]], TRUE, TRUE)
  all_data_wide[[scaled_variable]] <- scaled_values[, 1]
}

for (col in minimum_columns) {
  scaled_variable <- paste0(col, "_scaled")
  scaled_values <- scale(all_data_wide[[col]], TRUE, TRUE)
  all_data_wide[[scaled_variable]] <- scaled_values[, 1]
}

for (col in maximum_columns) {
  scaled_variable <- paste0(col, "_scaled")
  scaled_values <- scale(all_data_wide[[col]], TRUE, TRUE)
  all_data_wide[[scaled_variable]] <- scaled_values[, 1]
}

for (col in variance_columns) {
  scaled_variable <- paste0(col, "_scaled")
  scaled_values <- scale(all_data_wide[[col]], TRUE, TRUE)
  all_data_wide[[scaled_variable]] <- scaled_values[, 1]
}

scaled_cv_columns <- names(all_data_wide)[grepl("^CV.*_scaled$", names(all_data_wide))]
scaled_ml_columns <- names(all_data_wide)[grepl("^Low.*_scaled$", names(all_data_wide))]
scaled_min_columns <- names(all_data_wide)[grepl("^Minimum.*_scaled$", names(all_data_wide))]
scaled_max_columns <- names(all_data_wide)[grepl("^Maximum.*_scaled$", names(all_data_wide))]
scaled_sd_columns <- names(all_data_wide)[grepl("^sd.*_scaled$", names(all_data_wide))]

# Extract column names for filtering
selected_columns <- c("FSC.Events_per_cm_2", "Percent_Change", "Genotype", "Cage_Uncaged", "Species",
 #                     minimum_columns, 
#                      maximum_columns,
#                      CV_columns,
#                      mean_low_columns,
                      scaled_min_columns, 
                      scaled_max_columns,
#                      scaled_cv_columns,
                      scaled_ml_columns,
                      scaled_sd_columns,
                      "Pin_Number", "FSC.Events_per_g_dry_weight")

model_data <- all_data_wide[, selected_columns]


PAC_model_data <- na.omit(model_data %>% 
                            filter(Species == "Pocillopora acuta")) #%>%
# filter(Cage_Uncaged == "C")

PRU_model_data <- na.omit(model_data %>% 
        filter(Species == "Porites rus")) # %>% 
#  filter(Cage_Uncaged == "C")

dredge.data <- na.omit(model_data[, c(scaled_ml_columns,
                      scaled_sd_columns
                      #mean_low_columns, 
#                                    minimum_columns,
#                                    mean_columns, #removed bc not enough data for the amount of variables
#                                  CV_columns,
#                                  variance_columns
#                     mean_low_columns,
#                      scaled_min_columns, 
#                      scaled_max_columns,
#                      scaled_cv_columns,
#                      scaled_ml_columns
)])
```

## Data Exploration:
Data exploration focuses on the following points:
1. Outliers
2. Collinearity
3. Independence (Relationships between response and explanatory variables) 

```{r response data hist, fig.width=10, fig.height=10, echo=FALSE}
#png("output/response_data_hist.png", width = 1100, height = 1100)
par(mfrow = c(4,4), oma=c(1,1,3,1))
hist(PAC_response_data$Change_Over_Area, main="Change Over Area", col="lightblue", xlab="Change_Over_Area")
hist_columns <- c(7:13)
for (i in 1:length(hist_columns)) {
  hist(PAC_response_data[, hist_columns[i]], col="lightblue", 
       main = paste("PAC", colnames(PAC_response_data)[hist_columns[i]], sep=" - "),
       xlab=colnames(data)[hist_columns[i]])
}
hist(PRU_response_data$Change_Over_Area, main="Change Over Area", col="darkolivegreen3", xlab="Change_Over_Area")
for (i in 1:length(hist_columns)) {
  hist(PRU_response_data[, hist_columns[i]], col="darkolivegreen3", 
       main = paste("PRU", colnames(PRU_response_data)[hist_columns[i]], sep=" - "),
       xlab=colnames(data)[hist_columns[i]])
}
main_title <- "Response Data Exploration"
title(main = main_title, outer = TRUE)
#dev.off()
```

Ok so FSC.Events are both pretty right-skewed. CN says log10 transform these.


```{r wet season raw growth data plots, echo=FALSE, fig.width=15, fig.height=15}
species <- unique(all_data_seasonal$Species)
for (sp in species) {
  # Filter data for the current species and only caged
  species_data <- all_data_seasonal %>%
    filter(Species == sp, Cage_Uncaged == "C")
  
  # Create plot for the current species
  plot <- species_data %>%
    ggplot(aes(x = value, y = Percent_Change)) +
    geom_point() +
    geom_smooth(method = "lm") +
    facet_wrap(~ Parameter, scales = "free_x") +
    ggtitle(paste(sp)) +  #Add species name to the plot title
    theme_bw()
  # Print and save the plot
  print(plot)
#  ggsave(filename = paste("output/wet_raw_growth_data_response_plot_", sp, ".png", sep = ""),
#         plot = plot, 
#         width = 15, height = 15)
}
```

Now, doing this again but for both seasons combined:
```{r both season raw growth data plots, fig.width=15, fig.height=15}
species <- unique(all_data$Species)
for (sp in species) {
  # Filter data for the current species and only caged
  species_data <- all_data %>%
    filter(Species == sp, Cage_Uncaged == "C")
  
  # Create plot for the current species
  plot <- species_data %>%
    ggplot(aes(x = value, y = Percent_Change)) +
    geom_point() +
    geom_smooth(method = "lm") +
    facet_wrap(~ Parameter, scales = "free_x") +
    ggtitle(paste(sp)) +  #Add species name to the plot title
    theme_bw()
  # Print and save the plot
  print(plot)
  #ggsave(filename = paste("output/raw_growth_data_response_plot_", sp, ".png", sep = ""),
  #       plot = plot, 
  #       width = 15, height = 15)
}
```

Same but let's do for FCM data

```{r wet season raw symbiont count plots, echo=FALSE, fig.width=15, fig.height=15}
species <- unique(all_data_seasonal$Species)
for (sp in species) {
  # Filter data for the current species and only caged
  species_data <- all_data_seasonal %>%
    filter(Species == sp, Cage_Uncaged == "C")
  
  # Create plot for the current species
  plot <- species_data %>%
    ggplot(aes(x = value, y = FSC.Events_per_cm_2)) +
    geom_point() +
    geom_smooth(method = "lm") +
    facet_wrap(~ Parameter, scales = "free_x") +
    ggtitle(paste(sp)) +  #Add species name to the plot title
    theme_bw()
  # Print and save the plot
  print(plot)
#  ggsave(filename = paste("output/wet_raw_symbiong_count_response_plot_", sp, ".png", sep = ""),
#         plot = plot, 
#         width = 15, height = 15)
}
```

And again, now for both seasons:
```{r both seasons raw symbiont count plots, echo=FALSE, fig.width=15, fig.height=15}
species <- unique(all_data$Species)
for (sp in species) {
  # Filter data for the current species and only caged
  species_data <- all_data %>%
    filter(Species == sp, Cage_Uncaged == "C")
  
  # Create plot for the current species
  plot <- species_data %>%
    ggplot(aes(x = value, y = log10(FSC.Events_per_cm_2))) +
    geom_point() +
    geom_smooth(method = "lm") +
    facet_wrap(~ Parameter, scales = "free_x") +
    ggtitle(paste(sp)) +  #Add species name to the plot title
    theme_bw()
  # Print and save the plot
  print(plot)
  #ggsave(filename = paste("output/raw_growth_data_response_plot_", sp, ".png", sep = ""),
  #       plot = plot, 
  #       width = 15, height = 15)
}
```



```{r growth change by symbionts}
response_data %>% 
  filter(Cage_Uncaged == "C") %>% 
  ggplot(aes(y = Percent_Change, x = log10(FSC.Events_per_cm_2)))+
  geom_point() +
  geom_smooth(method = "lm", formula = "y~poly(x,2)") +
  ggtitle("Change in BW by Number of Symbionts") +
  geom_text(aes(label = Pin_Number)) +
  facet_wrap(~ Species, scales = "free") -> growth_v_symb_plot

growth_v_symb_plot
#ggsave("output/caged_growth_v_symb.png", width = 9, height = 6, plot = growth_v_symb_plot)


symb_growth_model <- response_data %>%
  filter(Cage_Uncaged == "C") %>%
  group_by(Species) %>% 
  do(model = lmer(Percent_Change ~ log10(FSC.Events_per_cm_2) + (1|Genotype), data = .))

# Extract model objects and print the anovas
model_objects <- symb_growth_model$model
anova_tables <- lapply(model_objects, function(model) {
  car::Anova(model)
})
anova_tables
#car::Anova(symb_growth_model$model[[1]]) #less code with small number of models
car::Anova(symb_growth_model$model[[2]])
```

OK, I don't want this relationship driven by 14 for rus, which I know had a good B coral and a diseased C coral

```{r}
response_data_no_14C_14B <- response_data %>%
  filter(Species == "Porites rus" & 
         (Cage_Uncaged == "C" | (Cage_Uncaged == "B" & Pin_Number == 14)))%>% 
  filter(!(Pin_Number == 14 & Cage_Uncaged == "C"))

response_data_no_14C <- response_data %>%
  filter(Species == "Porites rus" & 
         (Cage_Uncaged == "C")) %>%
  filter(!(Pin_Number == 14 & Cage_Uncaged == "C"))

model = lmer(Percent_Change ~ log10(FSC.Events_per_cm_2) + (1|Genotype), data = response_data_no_14C_14B)
car::Anova(model)

plot1 <- response_data_no_14C_14B %>% ggplot(aes(y = Percent_Change, x = log10(FSC.Events_per_cm_2)))+
  geom_point() +
  geom_smooth(method = "lm", formula = "y~poly(x,2)") +
  ggtitle("BW by Number of Symbionts no 14C with 14B")

plot2 <- response_data_no_14C %>% ggplot(aes(y = Percent_Change, x = log10(FSC.Events_per_cm_2)))+
  geom_point() +
  geom_smooth(method = "lm", formula = "y~poly(x,2)") +
  ggtitle("BW by Number of Symbionts no 14C")

grid.arrange(plot1, plot2, ncol = 2)

```




```{r bw change in rus vs acuta}
BW_long <- response_data %>% 
  filter(Cage_Uncaged == "C") %>%
  dplyr::select(Species, Percent_Change,Pin_Number ) %>%
  group_by(Species, Pin_Number)%>%
  summarise(Percent_ChangeM  = mean(Percent_Change, na.rm = TRUE)) %>% 
  pivot_wider(names_from = "Species",
              values_from = "Percent_ChangeM")

growth_v_sp_plot <- ggplot(data = BW_long, aes(x = `Pocillopora acuta`, y = `Porites rus`))+
  geom_point() +
  labs(title = "% ∆ BW between species by Pin Number")

#  geom_smooth(method = "lm") +
  growth_v_sp_plot
#ggsave("output/caged_growth_v_sp_plot.png", width = 9, height = 6, plot = growth_v_sp_plot)
```

#### Look for Outliers:
Buoyant Weight
It looks like that 13 A is really off. We know it broke, so I am removing it and replotted next to it:
```{r BW Outlier Tidy, echo=FALSE}
# BW Plot
BW <- merge(BW, meta[, c("Placement_Code", "Cage_Uncaged")], by = "Placement_Code")
BW_no <- BW[!(BW$Placement_Code == "PRU V13 A"), ]
```

Now making a plot to look at outliers:
```{r BW Outlier Plot, echo=FALSE}
par(mar = c(2.5, 1, 1, 1) + 0.1)
layout(matrix(1:2, nrow = 2), heights = c(3, 3))
#dotchart(BW$Change_Over_Area, main = "∆BW", 
#         groups = BW$Cage_Uncaged)
#dotchart(BW_no$Change_Over_Area, main = "∆BW removed erroneous data point", 
#         groups = BW_no$Cage_Uncaged)
layout(1)
```
I removed PRU V13 A placement because this was broken in the field, creating a large negative change in buoyant weight. 

TLE
```{r TLE Plot, echo=FALSE}
TLE <- merge(TLE, meta[, c("Placement_Code", "Cage_Uncaged")], by = "Placement_Code")
layout(matrix(c(1, 2, 3, 4), 2, 2, byrow = TRUE)) # Setting up the layout
#dotchart(na.omit(TLE$Max_L_AVG), main = "Max L", groups = na.omit(TLE$Cage_Uncaged)) # Side Max L Plot
#dotchart(TLE$Max_L_Basal, main = "Max L Basal", groups = na.omit(TLE$Cage_Uncaged)) # Basal Max L plot
#dotchart(TLE$Area_AVG, main = "Area", groups = na.omit(TLE$Cage_Uncaged)) # Area plot
#dotchart(TLE$Area_Basal, main = "Basal Area", groups = na.omit(TLE$Cage_Uncaged)) # Basal Area plot
layout(1) # Reset the layout
#title("TLE Outlier Dotchart", line = -1, outer = TRUE, cex.main = 1.5)
```

### Symbionts

```{r Sym plot, echo=FALSE}
FCM <- FCM[complete.cases(FCM[, "Cage_Uncaged"]), ] #Remove T0 samples by only including rows where the "Cage_Uncaged" exists
FCM$Cage_Uncaged <- as.factor(FCM$Cage_Uncaged) 
FCM_no <- FCM[!(FCM$Placement_Code == "PRU V17 C"), ]
par(mar = c(2.5, 1, 1, 1) + 0.1)
layout(matrix(1:2, nrow = 2), heights = c(3, 3))
dotchart(log10(FCM$FSC.Events_per_cm_2), main = "Symbionts", groups = FCM$Cage_Uncaged)
dotchart(log10(FCM_no$FSC.Events_per_cm_2), main = "Symbionts without erroneous point", groups = FCM_no$Cage_Uncaged)
layout(1)
```
Jess will rerun PRU 49 (PRU V17 C) with her samples - I likely added twice as much as needed to the sample, but for now I will omit in my analyses (using dataframe FCM_no for "no outliers")

```{r FCM Violin Plot}
FCM_violin <- ggplot(FCM, aes(x = Cage_Uncaged, y = log10(FSC.Events_per_cm_2), fill = Species)) +
  geom_violin() +
  geom_jitter(width = 0.2, height = 0, alpha = 0.5) +  # Adding jitter
  geom_text(aes(label = Pin_Number)) +
  scale_fill_fish_d(option = "Acanthurus_olivaceus", alpha = 0.4, begin = 0.3, end = 1)+
  facet_wrap(~Species)+
  labs(title = expression(paste("Symbionts per ", cm^2, " by caging treatment")))+
  theme(plot.title = element_text(hjust = 0.5))

FCM_violin
#ggsave("output/FCM_violin.png", width = 9, height = 6, plot = FCM_violin)
```

same but other normalization:

```{r FCM Violin Plot Dry Weight}
ggplot(FCM, aes(x = Cage_Uncaged, y = log10(FSC.Events_per_g_dry_weight), fill = Species)) +
  geom_violin() +
  geom_jitter(width = 0.2, height = 0, alpha = 0.5) +  # Adding jitter
  scale_fill_fish_d(option = "Acanthurus_olivaceus", alpha = 0.4, begin = 0.3, end = 1) +
  facet_wrap(~Species)+
  labs(title = "Symbionts per g dry weight by caging treatment")+
  theme(plot.title = element_text(hjust = 0.5))
```

### Collinearity
need to make a dataframe that's long that has all the nutrient metrics and independent variables
Here's the thing: we KNOW the nutrients are collinear
For example, here's a pairs plot for the maximum of all the nutrient values:

```{r pairs plot collinearity}
nut_wide_no_seep<- nut_wide[nut_wide$CowTagID != 'VSEEP', ]
maximum_columns <- names(nut_wide)[grepl("Maximum_", names(nut_wide)) & !grepl("Salinity|Temperature|pH|Ammonia_umol", names(nut_wide))]

#ggpairs( all_nut_no_seep[, c(CV_columns,variance_columns)], progress = FALSE)
#correlation_matrix <- cor(CV_columns, variance_columns)

all_nut_no_seep<- all_nut[all_nut$CowTagID != 'VSEEP', ]
plot1 <- all_nut_no_seep %>% 
  ggplot(aes(x=CV_Silicate_umolL, y = sd_Silicate_umolL))+
  geom_point()
  
plot2 <- all_nut_no_seep %>% 
  ggplot(aes(x=CV_Silicate_umolL, y = Mean_Silicate_umolL))+
  geom_point()

grid.arrange(plot1, plot2, ncol =2)
```


### Independence
```{r independence}

```

### Data Analysis
```{r}
PAC_model_scaled_data_long <- pivot_longer(
  data = PAC_model_data[,c(1:5,6:32, 33,34)], #33 is the Pin_Number
  cols = c(Minimum_Salinity_scaled:sd_Ammonia_umolL_scaled)) 
names(PAC_model_scaled_data_long)[names(PAC_model_scaled_data_long) == "name"] <- "Parameter"

#PAC_model_data_long <- pivot_longer(
#  data = PAC_model_data[,c(1:5,6:31)],
#  cols = c(Minimum_Salinity:Low_Tide_Mean_Ammonia_umolL)) 
#names(PAC_model_data_long)[names(PAC_model_data_long) == "name"] <- "Parameter"


#make the PRU data frame longer
PRU_model_scaled_data_long <- pivot_longer(
  data = PRU_model_data[,c(1:5,6:32, 33,34)], #67 is the Pin_Number
  cols = c(Minimum_Salinity_scaled:sd_Ammonia_umolL_scaled)) 
names(PRU_model_scaled_data_long)[names(PRU_model_scaled_data_long) == "name"] <- "Parameter"
```


FCM Data Analysis:
```{r FCM vis, echo=FALSE}
anova_PRU <- aov(FSC.Events_per_cm_2 ~ Cage_Uncaged + (1|Pin_Number), 
                 data = FCM %>% 
                   filter(Species=="Porites_rus"))
summary(anova_PRU)

#caging did not effect P. rus

anova_PAC <- aov(FSC.Events_per_cm_2 ~ Cage_Uncaged + (1|Pin_Number), 
                 data = FCM %>% 
                   filter(Species=="Pocillopora_acuta"))
summary(anova_PAC)
#caging did not effect symbionts in P. acuta
#this I have a bit of a hard time believing 
```

#### Pac growth

```{r Pac growth models}
model_results <- data.frame(Parameter = character(),
                            AICc = numeric(),
                            p.value1 = numeric(),
                            p.value2 = numeric(),
                            Estimate1 = numeric(),
                            Estimate2 = numeric(),
                            type = character(),
                            stringsAsFactors = FALSE)
plotlist <- list()

parameters <- unique(PAC_model_scaled_data_long$Parameter)

for (parameter in parameters) {
  # Create a subset of data for the current parameter
  subset_data <- PAC_model_scaled_data_long%>% 
    filter(Parameter == parameter)
#  %>% filter(Cage_Uncaged == "C")
  
  # Fit the mixed-effects model
  linear_model <- lmer(Percent_Change ~ value + (1|Genotype) + (1|Cage_Uncaged), data = subset_data)
  #squared_model <- lmer(Percent_Change ~ (value^2) + (1|Genotype) + (1|Cage_Uncaged), data = subset_data)
  polynomial_model <- lmer(Percent_Change ~ poly(value,2) + (1|Genotype) + (1|Cage_Uncaged), data = subset_data)
  
  # Get AICc
  linear_AICc <- AICc(linear_model)
  #squared_AICc <- AICc(squared_model)
  polynomial_AICc <- AICc(polynomial_model)
  
  # Get p-value from summary
  linear_model_summary <- summary(linear_model)
  anova_linear <- car::Anova(linear_model)
  linear_p.value <- anova_linear$`Pr(>Chisq)`
  linear_p.value <- linear_model_summary$coefficients["value", "Pr(>|t|)"]
  #squared_model_summary <- summary(squared_model)
  #squared_p.value <- squared_model_summary$coefficients["value", "Pr(>|t|)"]
  polynomial_model_summary <- summary(polynomial_model)
  anova_poly <- car::Anova(polynomial_model)
  polynomial_p.value <- anova_poly$`Pr(>Chisq)`
  
  # Get Estimate
  linear_Estimate <- linear_model_summary$coefficients["value", "Estimate"]
  #squared_Estimate <- squared_model_summary$coefficients["value", "Estimate"]
  polynomial_Estimate1 <- polynomial_model_summary$coefficients["poly(value, 2)1", "Estimate"]
  polynomial_Estimate2 <- polynomial_model_summary$coefficients["poly(value, 2)2", "Estimate"]
  
  if (linear_p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = linear_AICc,
                                                     p.value1 = linear_p.value,
                                                     p.value2 = "NA",
                                                     Estimate1 = linear_Estimate,
                                                     Estimate2 = "NA",
                                                     type = "linear"))
    
    # Add the ggplot object to the plotlist
    plotlist[[paste0(parameter, "_linear")]] <- ggplot(data = subset_data, aes(x = value, y = Percent_Change)) +
      geom_point() +
      geom_smooth(method = "lm") +
      labs(x = parameter) +
      theme_bw()
  }
  
    if (polynomial_p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = polynomial_AICc,
                                                     p.value1 = polynomial_p.value,
                                                     p.value2 = "NA",
                                                     Estimate1 = polynomial_Estimate1,
                                                     Estimate2 = polynomial_Estimate2,
                                                     type = "polynomial"))
    
    # Add the ggplot object to the plotlist
    plotlist[[paste0(parameter, "_polynomial")]] <- ggplot(data = subset_data, aes(x = value, y = Percent_Change)) +
      geom_point() +
      geom_smooth(method = "lm", formula = y ~ poly(x, 2)) +
      labs(x = parameter) +
      theme_bw()
    }
}
  
 #if (squared_p.value < 0.05) {
    # Add results to the dataframe
#    model_results <- rbind(model_results, data.frame(Parameter = parameter,
#                                                     AICc = squared_AICc,
#                                                     p.value1 = squared_p.value,
#                                                     p.value2 = "NA",
#                                                     Estimate1 = squared_Estimate,
#                                                     Estimate2 = "NA",
#                                                     type = "squared"))
    
    # Create an effects plot using ggpredict
#    squared_effect_plot <- ggpredict(squared_model, terms = "value[all]")
    
    # Extract the ggplot object from the ggpredict object
#    squared_ggplot_obj <- plot(squared_effect_plot)
    
    # Add the ggplot object to the plotlist
#    plotlist[[parameter]] <- squared_ggplot_obj + ggtitle(parameter)
# }

grid.arrange(grobs = plotlist, ncol = 2)

model_results$Species <- "Pocillopora acuta"

PAC_growth_model_results <- model_results
PAC_growth_model_results[order(PAC_growth_model_results$AICc), c(1, 7, 2:6)]
```

##### Multivariate

```{r}
multivariate_PAC_growth <- lmer(Percent_Change ~ poly(sd_pH_scaled,2) + poly(Minimum_Salinity_scaled,2) + poly(Low_Tide_Mean_Phosphate_umolL_scaled, 2) + (1|Genotype) + (1|Cage_Uncaged), data = PAC_model_data)

summary(multivariate_PAC_growth)
car::Anova(multivariate_PAC_growth)
```


```{r multivariate dredge}
multivariate_PAC_growth <- lmer(Percent_Change ~ 
                       poly(sd_pH_scaled,2) + 
                         poly(Minimum_Salinity_scaled,2) + 
                         poly(Low_Tide_Mean_Phosphate_umolL_scaled, 2) +
                       (1 | Genotype)+ (1|Cage_Uncaged), 
                                 data = PAC_model_data, 
                                 na.action = na.pass)

multivariate_PAC_growth_dredge <- dredge(multivariate_PAC_growth, trace = 2)
#model.sel(PAC_cv_low_growth_model_dredge)
PAC_growth.avg = model.avg(multivariate_PAC_growth_dredge, delta < 15)
summary(PAC_growth.avg)
PAC_growth.avg$sw
```

#### Pru growth 

```{r, message=FALSE}
model_results <- data.frame(Parameter = character(),
                            AICc = numeric(),
                            p.value1 = numeric(),
                            p.value2 = numeric(),
                            Estimate1 = numeric(),
                            Estimate2 = numeric(),
                            type = character(),
                            stringsAsFactors = FALSE)
plotlist <- list()

parameters <- unique(PRU_model_scaled_data_long$Parameter)

for (parameter in parameters) {
  # Create a subset of data for the current parameter
    subset_data <- PRU_model_scaled_data_long%>% 
    filter(Parameter == parameter) %>% 
      filter(Cage_Uncaged == "C") %>% 
       filter(!(Pin_Number == "14"))
  
  # Fit the mixed-effects model
  linear_model <- lmer(Percent_Change ~ value + (1|Genotype), data = subset_data)
  polynomial_model <- lmer(Percent_Change ~ poly(value,2) + (1|Genotype), data = subset_data)
  
  # Get AICc
  linear_AICc <- AICc(linear_model)
  polynomial_AICc <- AICc(polynomial_model)
  
  # Get p-value from summary
  linear_model_summary <- summary(linear_model)
  anova_linear <- car::Anova(linear_model)
  linear_p.value <- anova_linear$`Pr(>Chisq)`
  linear_p.value <- linear_model_summary$coefficients["value", "Pr(>|t|)"]
  polynomial_model_summary <- summary(polynomial_model)
  anova_poly <- car::Anova(polynomial_model)
  polynomial_p.value <- anova_poly$`Pr(>Chisq)`
  
  # Get Estimate
  linear_Estimate <- linear_model_summary$coefficients["value", "Estimate"]
  polynomial_Estimate1 <- polynomial_model_summary$coefficients["poly(value, 2)1", "Estimate"]
  polynomial_Estimate2 <- polynomial_model_summary$coefficients["poly(value, 2)2", "Estimate"]
  
  if (linear_p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = linear_AICc,
                                                     p.value1 = linear_p.value,
                                                     p.value2 = "NA",
                                                     Estimate1 = linear_Estimate,
                                                     Estimate2 = "NA",
                                                     type = "linear"))
    
    # Add the ggplot object to the plotlist
    plotlist[[paste0(parameter, "_linear")]] <- ggplot(data = subset_data, aes(x = value, y = Percent_Change)) +
      geom_point() +
      geom_smooth(method = "lm") +
      labs(x = parameter) +
      theme_bw()
  }
  
    if (polynomial_p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = polynomial_AICc,
                                                     p.value1 = polynomial_p.value,
                                                     p.value2 = "NA",
                                                     Estimate1 = polynomial_Estimate1,
                                                     Estimate2 = polynomial_Estimate2,
                                                     type = "polynomial"))
    
    # Add the ggplot object to the plotlist
    plotlist[[paste0(parameter, "_polynomial")]] <- ggplot(data = subset_data, aes(x = value, y = Percent_Change)) +
      geom_point() +
      geom_smooth(method = "lm", formula = y ~ poly(x, 2)) +
      geom_text(aes(label = Pin_Number)) +
      labs(x = parameter) +
      theme_bw()
    }
}

grid.arrange(grobs = plotlist, ncol = 2)

model_results$Species <- "Porites rus"

PRU_growth_model_results <- model_results
PRU_growth_model_results[order(PRU_growth_model_results$AICc), c(8, 1, 7, 2:6)]
```

##### Multivariate PRU Growth:

Callie, you gotta remember you can't keep the uncaged rus in this bih

```{r, eval = FALSE}
multivariate_PRU_growth <- lmer(Percent_Change ~ poly(Low_Tide_Mean_Salinity_scaled,2) + poly(Low_Tide_Mean_Temperature_scaled,2) + (1|Genotype) + (1|Cage_Uncaged), data = PRU_model_data)

summary(multivariate_PRU_growth)
car::Anova(multivariate_PRU_growth)
```


#### Pac symb

```{r model all parameteres scaled against symbiont, warning=FALSE, message=FALSE}
model_results <- data.frame(Parameter = character(),
                            AICc = numeric(),
                            p.value1 = numeric(),
                            p.value2 = numeric(),
                            Estimate1 = numeric(),
                            Estimate2 = numeric(),
                            type = character(),
                            stringsAsFactors = FALSE)
plotlist <- list()

parameters <- unique(PAC_model_scaled_data_long$Parameter)

for (parameter in parameters) {
  # Create a subset of data for the current parameter
  subset_data <- subset(PAC_model_scaled_data_long, Parameter == parameter)
  
  # Fit the mixed-effects model
  linear_model <- lmer(log10(FSC.Events_per_cm_2) ~ value + (1|Genotype) + (1|Cage_Uncaged), data = subset_data)
  polynomial_model <- lmer(log10(FSC.Events_per_cm_2) ~ poly(value,2) + (1|Genotype) + (1|Cage_Uncaged), data = subset_data)
  
  # Get AICc
  linear_AICc <- AICc(linear_model)
  polynomial_AICc <- AICc(polynomial_model)
  
  # Get p-value from summary
  linear_model_summary <- summary(linear_model)
  anova_linear <- car::Anova(linear_model)
  linear_p.value <- anova_linear$`Pr(>Chisq)`
  linear_p.value <- linear_model_summary$coefficients["value", "Pr(>|t|)"]
  polynomial_model_summary <- summary(polynomial_model)
  anova_poly <- car::Anova(polynomial_model)
  polynomial_p.value <- anova_poly$`Pr(>Chisq)`
  
  # Get Estimate
  linear_Estimate <- linear_model_summary$coefficients["value", "Estimate"]
  polynomial_Estimate1 <- polynomial_model_summary$coefficients["poly(value, 2)1", "Estimate"]
  polynomial_Estimate2 <- polynomial_model_summary$coefficients["poly(value, 2)2", "Estimate"]
  
  if (linear_p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = linear_AICc,
                                                     p.value1 = linear_p.value,
                                                     p.value2 = "NA",
                                                     Estimate1 = linear_Estimate,
                                                     Estimate2 = "NA",
                                                     type = "linear"))
    
    # Add the ggplot object to the plotlist
    plotlist[[paste0(parameter, "_linear")]] <- ggplot(data = subset_data, aes(x = value, y = log10(FSC.Events_per_cm_2))) +
      geom_point() +
      geom_smooth(method = "lm") +
      labs(x = parameter) +
      theme_bw()
  }
  
    if (polynomial_p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = polynomial_AICc,
                                                     p.value1 = polynomial_p.value,
                                                     p.value2 = "NA",
                                                     Estimate1 = polynomial_Estimate1,
                                                     Estimate2 = polynomial_Estimate2,
                                                     type = "polynomial"))
    
    # Add the ggplot object to the plotlist
    plotlist[[paste0(parameter, "_polynomial")]] <- ggplot(data = subset_data, aes(x = value, y = log10(FSC.Events_per_cm_2))) +
      geom_point() +
      geom_smooth(method = "lm", formula = y ~ poly(x, 2)) +
      labs(x = parameter) +
      theme_bw()
    }
}

grid.arrange(grobs = plotlist, ncol = 2)

model_results$Species <- "Pocillopora acuta"

PAC_symb_model_results <- model_results
PAC_symb_model_results[order(PAC_symb_model_results$AICc), c(8, 1, 7, 2:6)]
```


#### Pru symb 

```{r PRU symbionts by cm}
model_results <- data.frame(Parameter = character(),
                            AICc = numeric(),
                            p.value1 = numeric(),
                            p.value2 = numeric(),
                            Estimate1 = numeric(),
                            Estimate2 = numeric(),
                            type = character(),
                            stringsAsFactors = FALSE)
plotlist <- list()

parameters <- unique(PRU_model_scaled_data_long$Parameter)

for (parameter in parameters) {
  # Create a subset of data for the current parameter
  subset_data <-PRU_model_scaled_data_long %>% 
    filter(Parameter == parameter) %>% 
    filter(!(Pin_Number == "14" & Cage_Uncaged == "C"))
  
  # Fit the mixed-effects model
  linear_model <- lmer(log10(FSC.Events_per_cm_2) ~ value + (1|Genotype) + (1|Cage_Uncaged), data = subset_data)
  polynomial_model <- lmer(log10(FSC.Events_per_cm_2) ~ poly(value,2) + (1|Genotype) + (1|Cage_Uncaged), data = subset_data)
  
  # Get AICc
  linear_AICc <- AICc(linear_model)
  polynomial_AICc <- AICc(polynomial_model)
  
  # Get p-value from summary
  linear_model_summary <- summary(linear_model)
  anova_linear <- car::Anova(linear_model)
  linear_p.value <- anova_linear$`Pr(>Chisq)`
  linear_p.value <- linear_model_summary$coefficients["value", "Pr(>|t|)"]
  polynomial_model_summary <- summary(polynomial_model)
  anova_poly <- car::Anova(polynomial_model)
  polynomial_p.value <- anova_poly$`Pr(>Chisq)`
  
  # Get Estimate
  linear_Estimate <- linear_model_summary$coefficients["value", "Estimate"]
  polynomial_Estimate1 <- polynomial_model_summary$coefficients["poly(value, 2)1", "Estimate"]
  polynomial_Estimate2 <- polynomial_model_summary$coefficients["poly(value, 2)2", "Estimate"]
  
  if (linear_p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = linear_AICc,
                                                     p.value1 = linear_p.value,
                                                     p.value2 = "NA",
                                                     Estimate1 = linear_Estimate,
                                                     Estimate2 = "NA",
                                                     type = "linear"))
    
    # Add the ggplot object to the plotlist
    plotlist[[paste0(parameter, "_linear")]] <- ggplot(data = subset_data, aes(x = value, y = log10(FSC.Events_per_cm_2))) +
      geom_point() +
      geom_smooth(method = "lm") +
      labs(x = parameter) +
      theme_bw()
  }
  
    if (polynomial_p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = polynomial_AICc,
                                                     p.value1 = polynomial_p.value,
                                                     p.value2 = "NA",
                                                     Estimate1 = polynomial_Estimate1,
                                                     Estimate2 = polynomial_Estimate2,
                                                     type = "polynomial"))
    
    # Add the ggplot object to the plotlist
    plotlist[[paste0(parameter, "_polynomial")]] <- ggplot(data = subset_data, aes(x = value, y = log10(FSC.Events_per_cm_2))) +
      geom_point() +
      geom_smooth(method = "lm", formula = y ~ poly(x, 2)) +
      labs(x = parameter) +
      theme_bw()
    }
}

grid.arrange(grobs = plotlist, ncol = 2)

model_results$Species <- "Porites rus"

PRU_symb_model_results <- model_results
PRU_symb_model_results[order(PRU_symb_model_results$AICc), c(8, 1, 7, 2:6)]
```

```{r, message=FALSE}
model_results <- data.frame(Parameter = character(),
                            AICc = numeric(),
                            p.value1 = numeric(),
                            p.value2 = numeric(),
                            Estimate1 = numeric(),
                            Estimate2 = numeric(),
                            type = character(),
                            stringsAsFactors = FALSE)
plotlist <- list()

parameters <- unique(PRU_model_scaled_data_long$Parameter)

for (parameter in parameters) {
  # Create a subset of data for the current parameter
  subset_data <-PRU_model_scaled_data_long %>% 
    filter(Parameter == parameter) %>% 
    filter(!(Pin_Number == "14" & Cage_Uncaged == "C"))
  
  # Fit the mixed-effects model
  linear_model <- lmer(log10(FSC.Events_per_g_dry_weight) ~ value + (1|Genotype) + (1|Cage_Uncaged), data = subset_data)
  polynomial_model <- lmer(log10(FSC.Events_per_g_dry_weight) ~ poly(value,2) + (1|Genotype) + (1|Cage_Uncaged), data = subset_data)
  
  # Get AICc
  linear_AICc <- AICc(linear_model)
  polynomial_AICc <- AICc(polynomial_model)
  
  # Get p-value from summary
  linear_model_summary <- summary(linear_model)
  anova_linear <- car::Anova(linear_model)
  linear_p.value <- anova_linear$`Pr(>Chisq)`
  linear_p.value <- linear_model_summary$coefficients["value", "Pr(>|t|)"]
  polynomial_model_summary <- summary(polynomial_model)
  anova_poly <- car::Anova(polynomial_model)
  polynomial_p.value <- anova_poly$`Pr(>Chisq)`
  
  # Get Estimate
  linear_Estimate <- linear_model_summary$coefficients["value", "Estimate"]
  polynomial_Estimate1 <- polynomial_model_summary$coefficients["poly(value, 2)1", "Estimate"]
  polynomial_Estimate2 <- polynomial_model_summary$coefficients["poly(value, 2)2", "Estimate"]
  
  if (linear_p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = linear_AICc,
                                                     p.value1 = linear_p.value,
                                                     p.value2 = "NA",
                                                     Estimate1 = linear_Estimate,
                                                     Estimate2 = "NA",
                                                     type = "linear"))
    
    # Add the ggplot object to the plotlist
    plotlist[[paste0(parameter, "_linear")]] <- ggplot(data = subset_data, aes(x = value, y = log10(FSC.Events_per_cm_2))) +
      geom_point() +
      geom_smooth(method = "lm") +
      labs(x = parameter) +
      theme_bw()
  }
  
    if (polynomial_p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = polynomial_AICc,
                                                     p.value1 = polynomial_p.value,
                                                     p.value2 = "NA",
                                                     Estimate1 = polynomial_Estimate1,
                                                     Estimate2 = polynomial_Estimate2,
                                                     type = "polynomial"))
    
    # Add the ggplot object to the plotlist
    plotlist[[paste0(parameter, "_polynomial")]] <- ggplot(data = subset_data, aes(x = value, y = log10(FSC.Events_per_cm_2))) +
      geom_point() +
      geom_smooth(method = "lm", formula = y ~ poly(x, 2)) +
      labs(x = parameter) +
      theme_bw()
    }
}

grid.arrange(grobs = plotlist, ncol = 2)

model_results$Species <- "Porites rus"

PRU_symb_model_results <- model_results
PRU_symb_model_results[order(PRU_symb_model_results$AICc), c(8, 1, 7, 2:6)]
```


## ISOTOPES

```{r is N being shared}
SI_join %>% 
  filter(!Placement_Code == "T0") %>% 
  ggplot(aes(x = δ15N_host, y = δ15N_symb)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  geom_smooth(method = "lm") +
#  geom_text(aes(label = Pin_Number)) +
  facet_wrap(~Species, scales = "free_x")
```


```{r}
SI_join %>% 
  filter(!Placement_Code == "T0") %>% 
  ggplot(aes(x = δ13C_host, y = δ13C_symb)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
  geom_smooth(method = "lm") +
#  geom_text(aes(label = Pin_Number)) +
  facet_wrap(~Species, scales = "free")
```

### Exploratory plots:
If you could plot their 15N and 13C host and symbiont values on 2 different plots that would be a good place to start. One plot for 15N and one for 13C and then facet by whatever your categories are (location on gradient?). Then we can look at how overlapped their isotopes are:

```{r}
CV <- names(explanatory_all_wide)[grepl("CV_", names(explanatory_all_wide), names(explanatory_all_wide))]
mean_low <- names(explanatory_all_wide)[grepl("Low_Tide_Mean_", names(explanatory_all_wide), names(explanatory_all_wide))]

filter_values <- c("Maximum_NN_umolL",
                   "Maximum_Phosphate_umolL",
                   "Maximum_NNP_umolL",
                   "Low_Tide_Mean_Phosphate_umolL",
                   "Low_Tide_Mean_NN_umolL",
                   "Low_Tide_Mean_pH",
                   "Low_Tide_Mean_TA",
                   "Low_Tide_Mean_Salinity")

SI_data1 <- left_join(SI, explanatory_all,by = join_by(CowTagID))
SI_data_wide <- left_join(SI, explanatory_all_wide,by = join_by(CowTagID))

# Filter the dataframe SI_data
SI_data <- SI_data1[SI_data1$Parameter %in% filter_values, ] 
```

```{r}
SI_data_wide %>% 
  filter(Species == "Pocillopora acuta") %>% 
  ggplot(aes(x = C_N, y = C_N_ratio)) +
  geom_point() + 
  labs(x="Turbinaria C:N", y= "Coral C:N Ratio", main = "Pocillopora acuta") +
  facet_wrap(~HS)
```

```{r}
SI_data_wide %>% 
  filter(Species == 'Porites rus') %>% 
  ggplot(aes(x = C_N, y = C_N_ratio)) +
  geom_point() + 
  geom_text(aes(label=Pin_Number))+
  labs(x="Turbinaria C:N", y= "Coral C:N Ratio", main = "Porites rus") +
  facet_wrap(~HS)
```



```{r, warning=FALSE}
plot_list <- list()
nitrate_parameters <- c("CV_NN_umolL", "Maximum_NN_umolL", "Minimum_NN_umolL", "Low_Tide_Mean_NN_umolL")

for (parameter in nitrate_parameters) {
  # Filter data for the current species and only caged
  species_data <- SI_data_wide %>%
    filter(Species == "Porites rus")
  
  # Create plot for the current species
  plot_list[[parameter]] <- species_data %>%
    ggplot(aes(x = .data[[parameter]], y = Δ15N)) +
    geom_point() +
    geom_smooth(method = "lm") +
    facet_wrap(~ HS, scales = "free") +
    ggtitle(paste(sp)) +  #Add species name to the plot title
    theme_bw()+
    ylim(-1.1, NA) 
}
grid.arrange(grobs = plot_list, ncol = 2)
```

```{r, warning=FALSE}
plot_list <- list()
nitrate_parameters <- c("Maximum_NN_umolL", "Low_Tide_Mean_NN_umolL")

for (parameter in nitrate_parameters) {
  # Filter data for the current species and only caged
  species_data <- SI_data_wide %>%
    filter(Species == "Porites rus")
  
  # Create plot for the current species
  plot_list[[parameter]] <- species_data %>%
    ggplot(aes(x = .data[[parameter]], y = δ15N_T1_T0)) +
    geom_point() +
    geom_smooth(method = "lm") +
    facet_wrap(~ HS) +
    ggtitle(paste(sp)) +  #Add species name to the plot title
    theme_bw()+
    ylim(-1.1, NA) 
}
grid.arrange(grobs = plot_list, ncol = 2)
```

```{r, warning=FALSE}
plot_list <- list()

for (parameter in nitrate_parameters) {
  # Filter data for the current species and only caged
  species_data <- SI_data_wide %>%
    filter(Species == "Pocillopora acuta")
  
  # Create plot for the current species
  plot_list[[parameter]] <- species_data %>%
    ggplot(aes(x = .data[[parameter]], y = δ15N_T1_T0)) +
    geom_point() +
    geom_smooth(method = "lm") +
    facet_wrap(~ HS, scales = "free_x") +
    ggtitle("Pocillopora acuta") +  #Add species name to the plot title
    theme_bw()
}
grid.arrange(grobs = plot_list, ncol = 2)
```


```{r checking that none of these are significant}
Rus_data <- SI_data_wide %>%
  filter(Species == "Porites rus" & HS == "host") 
model <- lmer(δ15N ~ Low_Tide_Mean_NN_umolL + (1|Genotype), data = Rus_data)
car::Anova(model)

#summary(model) #cannot attribute any of this variation to genotype
```

### Exploring plots of symbionts and growth vs. isotope values
```{r}
SI_data_wide <- left_join(SI_data_wide, FCM[,c("Placement_Code", "FSC.Events_per_cm_2")])
SI_data_wide$log10symbcount <- log10(SI_data_wide$FSC.Events_per_cm_2)
```

If you remember, the P. acuta did not have anything affecting its symbionts, but rus did. 

```{r Acuta vs symbionts, fig.width=12, fig.height=6}
create_SI_plot <- function(data, species, host_sym, y_variable, title_suffix) {
  data %>%
    filter(Species == {species}) %>% 
    filter(HS == {host_sym}) %>% 
    ggplot(aes(x = log10(FSC.Events_per_cm_2), y = !!sym(y_variable))) +
    geom_point(aes(shape = Genotype)) +
    geom_smooth(method = "lm") +
    ggtitle(paste(species, host_sym, title_suffix)) +  
    theme_bw() +
    theme(legend.position = "none")
}

plot1 <- create_SI_plot(SI_data_wide, "Pocillopora acuta", "symb", "δ15N", "δ15N")
plot2 <- create_SI_plot(SI_data_wide, "Pocillopora acuta", "host", "δ15N", "δ15N")
plot3 <- create_SI_plot(SI_data_wide, "Pocillopora acuta", "host", "Δ15N", "minus symbiont, Δ15N")
plot4 <- create_SI_plot(SI_data_wide, "Pocillopora acuta", "symb", "δ13C", "δ13C")
plot5 <- create_SI_plot(SI_data_wide, "Pocillopora acuta", "host", "δ13C", "δ13C")
plot6 <- create_SI_plot(SI_data_wide, "Pocillopora acuta", "host", "Δ13C", "minus symbiont, Δ13C")

legend <- gtable::gtable_filter(ggplot_gtable(ggplot_build(plot1 + theme(legend.position = "top"))), "guide-box")

acuta_SIvssymb_plots <- grid.arrange(plot1, plot2, plot3, plot4, plot5, plot6, legend, ncol = 3)
```

I'm not surprised these mostly look like flat lines. Let's look at the symbionts versus the rus:

```{r Prus symb vs isotopes plots, warning=FALSE, message=FALSE, fig.height=6, fig.width=10}
SI_data_wide_no_14C <- SI_data_wide %>%
  filter(!(Pin_Number == 14))

plot1 <- create_SI_plot(SI_data_wide_no_14C, "Porites rus", "symb", "δ15N", "δ15N")
plot2 <- create_SI_plot(SI_data_wide_no_14C, "Porites rus", "host", "δ15N", "δ15N")
plot3 <- create_SI_plot(SI_data_wide_no_14C, "Porites rus", "host", "Δ15N", "minus symbiont, Δ15N")
plot4 <- create_SI_plot(SI_data_wide_no_14C, "Porites rus", "symb", "δ13C", "δ13C")
plot5 <- create_SI_plot(SI_data_wide_no_14C, "Porites rus", "host", "δ13C", "δ13C")
plot6 <- create_SI_plot(SI_data_wide_no_14C, "Porites rus", "host", "Δ13C", "minus symbiont, Δ13C")

legend <- gtable::gtable_filter(ggplot_gtable(ggplot_build(plot1 + theme(legend.position = "top"))), "guide-box")

rus_SIvssymb_plots <- grid.arrange(plot1, plot2, plot3, plot4, plot5, plot6, legend, ncol = 3)
```

Ok, we expect Δ13C(h-s) to increase with increasing symbiont populations. This can make it hard to determine if changed in ∆13C are from additional symbionts decreasing the carbon pool or if increased heterotrophy. I think that because this is driven by the host getting more heavy carbon with more symbionts, this suggests heterotrophy instead of symbionts depleting the carbon pool. 

#### Just running a model to see bc the last plot looks potentially significant:

```{r rus symbiont vs isotope C}
Rus_data <- SI_data_wide %>%
  filter(Species == "Porites rus" & HS == "host")
model <- lmer(δ13C ~ log10(FSC.Events_per_cm_2) + (1|Genotype), data = Rus_data)
car::Anova(model)
model <- lmer(Δ13C ~ log10(FSC.Events_per_cm_2) + (1|Genotype), data = Rus_data)
car::Anova(model)
```
Ok so the host is going to have more 13C than the symbiont at higher symbiont populations in Porties rus corals, but we're not quite significant to the point where it is almost painful. 

Increased contributions of heterotrophically-derived carbon results in more pronounced differences between δ13C levels in host and Symbiodiniaceae (∆13C = δ13Chost - δ13Csymbiont) (Muscatine et al., 1989; M. E. A. Santos et al., 2021).

“During periods of high coral photosynthesis the internal carbon pool becomes enriched in 13C (higher δ13C values) as dissolved inorganic carbon enriched in 12C is preferentially fixed” [Wall et al., 2020, p. 954]. 
^this is what I want to look into, because if 12C is preferentially fixed then why is the host becoming enriched in 13C with more symbionts? shouldn't the symbionts be giving off a lot of 12C and then the coral would be fixing that??

```{r}
plot1 <- create_SI_plot(SI_data_wide_no_14C, "Porites rus", "symb", "δ15N_T1_T0", "δ15N_T1_T0")
plot2 <- create_SI_plot(SI_data_wide_no_14C, "Porites rus", "host", "δ15N_T1_T0", "δ15N_T1_T0")
plot3 <- create_SI_plot(SI_data_wide_no_14C, "Porites rus", "host", "Δ15N_T1T0", "minus symbiont, Δ15N")
plot4 <- create_SI_plot(SI_data_wide_no_14C, "Porites rus", "symb", "δ13C_T1_T0", "δ13C_T1_T0")
plot5 <- create_SI_plot(SI_data_wide_no_14C, "Porites rus", "host", "δ13C_T1_T0", "δ13C_T1_T0")
plot6 <- create_SI_plot(SI_data_wide_no_14C, "Porites rus", "host", "Δ13C_T1T0", "minus symbiont, Δ13C")

legend <- gtable::gtable_filter(ggplot_gtable(ggplot_build(plot1 + theme(legend.position = "top"))), "guide-box")

rus_SIvssymb_plots <- grid.arrange(plot1, plot2, plot3, plot4, plot5, plot6, legend, ncol = 3)
```

I'm pretty pumped that this looks the same, with relatively little enrichment in 13C in the symbionts as populations increase, but a strong increase in 13C in the host. To me, this is suggesting an indirect effect (or like, not really correlated?). I think the nutrients are increasing the symbionts which is also increasing the POM / heterotrophy

```{r}
model <- lmer(δ13C_T1_T0 ~ log10(FSC.Events_per_cm_2) + (1|Genotype), data = Rus_data)
car::Anova(model)
```

POINT O 5 6 7 1 ARE YOU KIDDING MEEEEE

```{r}
model <- lmer(Δ13C_T1T0 ~ log10(FSC.Events_per_cm_2) + (1|Genotype), data = Rus_data)
car::Anova(model)
```

Cool.


```{r Rus Δ13C ~ Maximum_Phosphate_umolL}
model <- lmer(Δ13C_T1T0 ~ Maximum_Phosphate_umolL + (1|Genotype), data = Rus_data)
car::Anova(model)
```


```{r Rus Δ13C ~ Low_Tide_Mean_Phosphate_umolL}
model <- lmer(Δ13C_T1T0 ~ Low_Tide_Mean_Phosphate_umolL + (1|Genotype), data = Rus_data)
car::Anova(model)
```


```{r rus symbiont vs isotope N}
Rus_data <- SI_data_wide %>%
  filter(Species == "Porites rus" & HS == "host")
model <- lmer(Δ13C_T1T0 ~ log10(FSC.Events_per_cm_2) + (1|Genotype), data = Rus_data)
car::Anova(model)
```

But, as expected from the plot, this is not congruent between C and N isotopes. 15N normally comes from more heterotrophy, whereas 14N is normally fixed from the environment.

```{r 15N host, fig.width=15, fig.height=15}
# species <- unique(SI_data$Species) # has NA
species <- c("Pocillopora acuta", "Porites rus" )
for (sp in species) {
  # Filter data for the current species and only caged
  species_data <- SI_data %>%
    filter(Species == sp, HS == "host")
  
  # Create plot for the current species
  plot <- species_data %>%
    ggplot(aes(x = value, y = δ15N)) +
    geom_point(aes(shape = Genotype)) +
    geom_smooth(method = "lm") +
    facet_wrap(~ Parameter, scales = "free_x") +
    ggtitle(paste(sp)) +  #Add species name to the plot title
    theme_bw()
  # Print and save the plot
  print(plot)
  #ggsave(filename = paste("output/wet_raw_growth_data_response_plot_", sp, ".png", sep = ""),
  #       plot = plot, 
  #       width = 15, height = 15)
}
```

```{r EXPLORATORY 13C host, fig.width=15, fig.height=15}
species <- c("Pocillopora acuta", "Porites rus" )
for (sp in species) {
  # Filter data for the current species and only caged
  species_data <- SI_data %>%
    filter(Species == sp, HS == "host")
  
  # Create plot for the current species
  plot <- species_data %>%
    ggplot(aes(x = value, y = δ13C)) +
    geom_point(aes(shape = Genotype)) +
    geom_smooth(method = "lm") +
    facet_wrap(~ Parameter, scales = "free") +
    ggtitle(paste(sp)) +  #Add species name to the plot title
    theme_bw()
  # Print and save the plot
  print(plot)
  #ggsave(filename = paste("output/wet_raw_growth_data_response_plot_", sp, ".png", sep = ""),
  #       plot = plot, 
  #       width = 15, height = 15)
}
```

```{r EXPLORATORY 13C symb, fig.width=15, fig.height=15}
species <- c("Pocillopora acuta", "Porites rus" )
for (sp in species) {
  # Filter data for the current species and only caged
  species_data <- SI_data %>%
    filter(Species == sp, HS == "symb")
  
  # Create plot for the current species
  plot <- species_data %>%
    ggplot(aes(x = value, y = δ13C)) +
    geom_point() +
    geom_smooth(method = "lm") +
    facet_wrap(~ Parameter, scales = "free") +
    ggtitle(paste(sp)) +  #Add species name to the plot title
    theme_bw()
  # Print and save the plot
  print(plot)
  #ggsave(filename = paste("output/wet_raw_growth_data_response_plot_", sp, ".png", sep = ""),
  #       plot = plot, 
  #       width = 15, height = 15)
}
```


```{r EXPLORATORY 15N symb, fig.width=15, fig.height=15}
species <- c("Pocillopora acuta", "Porites rus" )
for (sp in species) {
  # Filter data for the current species and only caged
  species_data <- SI_data %>%
    filter(Species == sp, HS == "symb")
  
  # Create plot for the current species
  plot <- species_data %>%
    ggplot(aes(x = value, y = δ15N)) +
    geom_point() +
    geom_smooth(method = "lm") +
    facet_wrap(~ Parameter, scales = "free_x") +
    ggtitle(paste(sp)) +  #Add species name to the plot title
    theme_bw()
  # Print and save the plot
  print(plot)
  #ggsave(filename = paste("output/wet_raw_growth_data_response_plot_", sp, ".png", sep = ""),
  #       plot = plot, 
  #       width = 15, height = 15)
}
```



```{r}
create_SI_plot <- function(data, species, host_sym, y_variable, title_suffix) {
  data %>%
    filter(Species == {species}) %>% 
    filter(HS == {host_sym}) %>% 
    ggplot(aes(x = pulse_pc1, y = !!sym(y_variable))) +
    geom_point(aes(shape = Genotype)) +
    geom_smooth(method = "lm") +
    ggtitle(paste(species, host_sym, title_suffix)) +  
    theme_bw() +
    theme(legend.position = "none")
}
```



```{r pc plots, warning=FALSE, message=FALSE, fig.width=15, fig.height=8}
plot1 <- create_SI_plot(SI_data_wide, "Porites rus", "symb", "δ15N", "δ15N")
plot2 <- create_SI_plot(SI_data_wide, "Porites rus", "host", "δ15N", "δ15N")
plot3 <- create_SI_plot(SI_data_wide, "Porites rus", "host", "Δ15N", "minus symbiont, Δ15N")
plot4 <- create_SI_plot(SI_data_wide, "Porites rus", "symb", "δ13C", "δ13C")
plot5 <- create_SI_plot(SI_data_wide, "Porites rus", "host", "δ13C", "δ13C")
plot6 <- create_SI_plot(SI_data_wide, "Porites rus", "host", "Δ13C", "minus symbiont, Δ13C")


legend <- gtable::gtable_filter(ggplot_gtable(ggplot_build(plot1 + theme(legend.position = "bottom"))), "guide-box")

rus_pc_plots <- grid.arrange(plot1, plot2, plot3, plot4, plot5, plot6, legend, ncol = 3)

#ggsave(filename = paste("output/exploratory_isotope_rus_pc_plots.png", sep = ""),
#         plot = rus_pc_plots, 
#         width = 15, height = 8)
```


```{r acuta pc plots, warning=FALSE, message=FALSE, fig.width=12, fig.height=6}
plot1 <- create_SI_plot(SI_data_wide, "Pocillopora acuta", "symb", "δ15N", "δ15N")
plot2 <- create_SI_plot(SI_data_wide, "Pocillopora acuta", "host", "δ15N", "δ15N")
plot3 <- create_SI_plot(SI_data_wide, "Pocillopora acuta", "host", "Δ15N", "minus symbiont, Δ15N")
plot4 <- create_SI_plot(SI_data_wide, "Pocillopora acuta", "symb", "δ13C", "δ13C")
plot5 <- create_SI_plot(SI_data_wide, "Pocillopora acuta", "host", "δ13C", "δ13C")
plot6 <- create_SI_plot(SI_data_wide, "Pocillopora acuta", "host", "Δ13C", "minus symbiont, Δ13C")


legend <- gtable::gtable_filter(ggplot_gtable(ggplot_build(plot1 + theme(legend.position = "bottom"))), "guide-box")

acuta_pc_plots <- grid.arrange(plot1, plot2, plot3, plot4, plot5, plot6, ncol = 3)

#ggsave(filename = paste("output/exploratory_isotope_acuta_pc_plots.png", sep = ""),
#         plot = acuta_pc_plots, 
#         width = 15, height = 8)

```


## Some univariate models with isotopes:

```{r PAC_Δ15N_model_results}
model_results <- data.frame(Parameter = character(),
                            AICc = numeric(),
                            p.value1 = numeric(),
                            p.value2 = numeric(),
                            Estimate1 = numeric(),
                            Estimate2 = numeric(),
                            type = character(),
                            Marginal_R2 = numeric(),
                            Conditional_R2 = numeric(),
                            stringsAsFactors = FALSE)

plotlist <- list()

parameters <- unique(SI_data$Parameter)

for (parameter in parameters) {
  # Create a subset of data for the current parameter
  subset_data <- subset(SI_data, Parameter == parameter)
  subset_data <- subset(subset_data, Species == "Pocillopora acuta")
  subset_data <- subset(subset_data, HS == "host")
  
  # Fit the mixed-effects model
  linear_model <- lmer(Δ15N ~ value + (1|Genotype), data = subset_data)
  polynomial_model <- lmer(Δ15N ~ poly(value,2) + (1|Genotype), data = subset_data)
  
  # Get AICc
  linear_AICc <- AICc(linear_model)
  polynomial_AICc <- AICc(polynomial_model)
  
  # Get p-value from summary
  linear_model_summary <- summary(linear_model)
  anova_linear <- car::Anova(linear_model)
  linear_p.value <- anova_linear$`Pr(>Chisq)`
  linear_p.value <- linear_model_summary$coefficients["value", "Pr(>|t|)"]
  polynomial_model_summary <- summary(polynomial_model)
  anova_poly <- car::Anova(polynomial_model)
  polynomial_p.value <- anova_poly$`Pr(>Chisq)`
  
  # Get Estimate
  linear_Estimate <- linear_model_summary$coefficients["value", "Estimate"]
  polynomial_Estimate1 <- polynomial_model_summary$coefficients["poly(value, 2)1", "Estimate"]
  polynomial_Estimate2 <- polynomial_model_summary$coefficients["poly(value, 2)2", "Estimate"]
  
  #Get R2
    rsq <- as.numeric(r.squaredGLMM(linear_model))
    linear_marginal_R2 <- rsq[1]
    linear_conditional_R2 <- rsq[2]
  
  if (linear_p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = linear_AICc,
                                                     p.value1 = linear_p.value,
                                                     p.value2 = "NA",
                                                     Estimate1 = linear_Estimate,
                                                     Estimate2 = "NA",
                                                     Marginal_R2 = linear_marginal_R2,
                                                     Conditional_R2 = linear_conditional_R2,
                                                     type = "linear"))
    
    # Add the ggplot object to the plotlist
    plotlist[[paste0(parameter, "_linear")]] <- ggplot(data = subset_data, aes(x = value, y = Δ15N)) +
      geom_point() +
      geom_smooth(method = "lm") +
      labs(x = parameter) +
      theme_bw()
  }
  
    if (polynomial_p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = polynomial_AICc,
                                                     p.value1 = polynomial_p.value,
                                                     p.value2 = "NA",
                                                     Estimate1 = polynomial_Estimate1,
                                                     Estimate2 = polynomial_Estimate2,
                                                     Marginal_R2 = "NA",
                                                     Conditional_R2 = "NA",
                                                     type = "polynomial"))
    
    # Add the ggplot object to the plotlist
    plotlist[[paste0(parameter, "_polynomial")]] <- ggplot(data = subset_data, aes(x = value, y = Δ15N)) +
      geom_point() +
      geom_smooth(method = "lm", formula = y ~ poly(x, 2)) +
      labs(x = parameter) +
      theme_bw()
    }
}

grid.arrange(grobs = plotlist, ncol = 2)

model_results$Species <- "Pocillopora acuta"

PAC_Δ15N_model_results <- model_results
PAC_Δ15N_model_results[order(PAC_Δ15N_model_results$AICc), c(10, 1, 3, 2, 5:9)]
```

```{r}
SI_data %>% 
  filter(Species == "Pocillopora acuta") %>% 
  filter(Parameter == "Maximum_Phosphate_umolL") %>% 
  ggplot(aes(x = value, y = Δ15N)) +
      geom_point() +
      geom_smooth(method = "lm") +
      labs(x = "Maximum_Phosphate_umolL") +
      theme_bw()
```


```{r PAC_Δ13C_model_results}
model_results <- data.frame(Parameter = character(),
                            AICc = numeric(),
                            p.value1 = numeric(),
                            p.value2 = numeric(),
                            Estimate1 = numeric(),
                            Estimate2 = numeric(),
                            type = character(),
                            Marginal_R2 = numeric(),
                            Conditional_R2 = numeric(),
                            stringsAsFactors = FALSE)

plotlist <- list()

parameters <- unique(SI_data$Parameter)

for (parameter in parameters) {
  # Create a subset of data for the current parameter
  subset_data <- subset(SI_data, Parameter == parameter)
  subset_data <- subset(subset_data, Species == "Pocillopora acuta")
  subset_data <- subset(subset_data, HS == "host")
  
  # Fit the mixed-effects model
  linear_model <- lmer(Δ13C ~ value + (1|Genotype), data = subset_data)
  polynomial_model <- lmer(Δ13C ~ poly(value,2) + (1|Genotype), data = subset_data)
  
  # Get AICc
  linear_AICc <- AICc(linear_model)
  polynomial_AICc <- AICc(polynomial_model)
  
  # Get p-value from summary
  linear_model_summary <- summary(linear_model)
  anova_linear <- car::Anova(linear_model)
  linear_p.value <- anova_linear$`Pr(>Chisq)`
  linear_p.value <- linear_model_summary$coefficients["value", "Pr(>|t|)"]
  polynomial_model_summary <- summary(polynomial_model)
  anova_poly <- car::Anova(polynomial_model)
  polynomial_p.value <- anova_poly$`Pr(>Chisq)`
  
  # Get Estimate
  linear_Estimate <- linear_model_summary$coefficients["value", "Estimate"]
  polynomial_Estimate1 <- polynomial_model_summary$coefficients["poly(value, 2)1", "Estimate"]
  polynomial_Estimate2 <- polynomial_model_summary$coefficients["poly(value, 2)2", "Estimate"]
  
  #Get R2
    rsq <- as.numeric(r.squaredGLMM(linear_model))
    linear_marginal_R2 <- rsq[1]
    linear_conditional_R2 <- rsq[2]
  
  if (linear_p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = linear_AICc,
                                                     p.value1 = linear_p.value,
                                                     p.value2 = "NA",
                                                     Estimate1 = linear_Estimate,
                                                     Estimate2 = "NA",
                                                     Marginal_R2 = linear_marginal_R2,
                                                     Conditional_R2 = linear_conditional_R2,
                                                     type = "linear"))
    
    # Add the ggplot object to the plotlist
    plotlist[[paste0(parameter, "_linear")]] <- ggplot(data = subset_data, aes(x = value, y = Δ13C)) +
      geom_point() +
      geom_smooth(method = "lm") +
      labs(x = parameter) +
      theme_bw()
  }
  
    if (polynomial_p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = polynomial_AICc,
                                                     p.value1 = polynomial_p.value,
                                                     p.value2 = "NA",
                                                     Estimate1 = polynomial_Estimate1,
                                                     Estimate2 = polynomial_Estimate2,
                                                     Marginal_R2 = "NA",
                                                     Conditional_R2 = "NA",
                                                     type = "polynomial"))
    
    # Add the ggplot object to the plotlist
    plotlist[[paste0(parameter, "_polynomial")]] <- ggplot(data = subset_data, aes(x = value, y = Δ13C)) +
      geom_point() +
      geom_smooth(method = "lm", formula = y ~ poly(x, 2)) +
      labs(x = parameter) +
      theme_bw()
    }
}

grid.arrange(grobs = plotlist, ncol = 2)

model_results$Species <- "Pocillopora acuta"

PAC_Δ13C_model_results <- model_results
PAC_Δ13C_model_results[order(PAC_Δ13C_model_results$AICc), c(10, 1, 9, 3, 2, 5:8)]
```

```{r}
plot1 <- SI_data %>% 
  filter(Species == "Pocillopora acuta") %>% 
  filter(Parameter == "Maximum_Phosphate_umolL") %>% 
  ggplot(aes(x = value, y = Δ15N)) +
      geom_point() +
      geom_smooth(method = "lm") +
      labs(x = "Maximum_Phosphate_umolL", title = "Pocillopora acuta") +
      theme_bw()

plot2 <- SI_data %>% 
  filter(Species == "Pocillopora acuta") %>% 
  filter(Parameter == "Maximum_NN_umolL") %>% 
  ggplot(aes(x = value, y = Δ13C)) +
      geom_point() +
      geom_smooth(method = "lm", formula = "y~poly(x,2)")+
      labs(x = "Maximum_NN_umolL", title = "Pocillopora acuta") +
      theme_bw()

grid.arrange(plot1, plot2, ncol = 2)
```



```{r PRU_Δ15N_model_results}
model_results <- data.frame(Parameter = character(),
                            AICc = numeric(),
                            p.value1 = numeric(),
                            p.value2 = numeric(),
                            Estimate1 = numeric(),
                            Estimate2 = numeric(),
                            type = character(),
                            Marginal_R2 = numeric(),
                            Conditional_R2 = numeric(),
                            stringsAsFactors = FALSE)

plotlist <- list()

parameters <- unique(SI_data$Parameter)

for (parameter in parameters) {
  # Create a subset of data for the current parameter
  subset_data <- subset(SI_data, Parameter == parameter)
  subset_data <- subset(subset_data, Species == "Porites rus")
  subset_data <- subset(subset_data, HS == "host")
  
  # Fit the mixed-effects model
  linear_model <- lmer(Δ15N ~ value + (1|Genotype), data = subset_data)
  polynomial_model <- lmer(Δ15N ~ poly(value,2) + (1|Genotype), data = subset_data)
  
  # Get AICc
  linear_AICc <- AICc(linear_model)
  polynomial_AICc <- AICc(polynomial_model)
  
  # Get p-value from summary
  linear_model_summary <- summary(linear_model)
  anova_linear <- car::Anova(linear_model)
  linear_p.value <- anova_linear$`Pr(>Chisq)`
  linear_p.value <- linear_model_summary$coefficients["value", "Pr(>|t|)"]
  polynomial_model_summary <- summary(polynomial_model)
  anova_poly <- car::Anova(polynomial_model)
  polynomial_p.value <- anova_poly$`Pr(>Chisq)`
  
  # Get Estimate
  linear_Estimate <- linear_model_summary$coefficients["value", "Estimate"]
  polynomial_Estimate1 <- polynomial_model_summary$coefficients["poly(value, 2)1", "Estimate"]
  polynomial_Estimate2 <- polynomial_model_summary$coefficients["poly(value, 2)2", "Estimate"]
  
  #Get R2
    rsq <- as.numeric(r.squaredGLMM(linear_model))
    linear_marginal_R2 <- rsq[1]
    linear_conditional_R2 <- rsq[2]
  
  if (linear_p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = linear_AICc,
                                                     p.value1 = linear_p.value,
                                                     p.value2 = "NA",
                                                     Estimate1 = linear_Estimate,
                                                     Estimate2 = "NA",
                                                     Marginal_R2 = linear_marginal_R2,
                                                     Conditional_R2 = linear_conditional_R2,
                                                     type = "linear"))
    
    # Add the ggplot object to the plotlist
    plotlist[[paste0(parameter, "_linear")]] <- ggplot(data = subset_data, aes(x = value, y = Δ15N)) +
      geom_point() +
      geom_smooth(method = "lm") +
      labs(x = parameter) +
      theme_bw()
  }
  
    if (polynomial_p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = polynomial_AICc,
                                                     p.value1 = polynomial_p.value,
                                                     p.value2 = "NA",
                                                     Estimate1 = polynomial_Estimate1,
                                                     Estimate2 = polynomial_Estimate2,
                                                     Marginal_R2 = "NA",
                                                     Conditional_R2 = "NA",
                                                     type = "polynomial"))
    
    # Add the ggplot object to the plotlist
    plotlist[[paste0(parameter, "_polynomial")]] <- ggplot(data = subset_data, aes(x = value, y = Δ15N)) +
      geom_point() +
      geom_smooth(method = "lm", formula = y ~ poly(x, 2)) +
      labs(x = parameter) +
      theme_bw()
    }
}

grid.arrange(grobs = plotlist, ncol = 2)

model_results$Species <- "Porites rus"

PRU_Δ15N_model_results <- model_results
PRU_Δ15N_model_results[order(PRU_Δ15N_model_results$AICc), c(10, 1, 3, 2, 5:9)]
```


```{r PRU_Δ13C_model_results}
model_results <- data.frame(Parameter = character(),
                            AICc = numeric(),
                            p.value1 = numeric(),
                            p.value2 = numeric(),
                            Estimate1 = numeric(),
                            Estimate2 = numeric(),
                            type = character(),
                            Marginal_R2 = numeric(),
                            Conditional_R2 = numeric(),
                            stringsAsFactors = FALSE)

plotlist <- list()

parameters <- unique(SI_data$Parameter)

for (parameter in parameters) {
  # Create a subset of data for the current parameter
  subset_data <- subset(SI_data, Parameter == parameter)
  subset_data <- subset(subset_data, Species == "Porites rus")
  subset_data <- subset(subset_data, HS == "host")
  
  # Fit the mixed-effects model
  linear_model <- lmer(Δ13C ~ value + (1|Genotype), data = subset_data)
  polynomial_model <- lmer(Δ13C ~ poly(value,2) + (1|Genotype), data = subset_data)
  
  # Get AICc
  linear_AICc <- AICc(linear_model)
  polynomial_AICc <- AICc(polynomial_model)
  
  # Get p-value from summary
  linear_model_summary <- summary(linear_model)
  anova_linear <- car::Anova(linear_model)
  linear_p.value <- anova_linear$`Pr(>Chisq)`
  linear_p.value <- linear_model_summary$coefficients["value", "Pr(>|t|)"]
  polynomial_model_summary <- summary(polynomial_model)
  anova_poly <- car::Anova(polynomial_model)
  polynomial_p.value <- anova_poly$`Pr(>Chisq)`
  
  # Get Estimate
  linear_Estimate <- linear_model_summary$coefficients["value", "Estimate"]
  polynomial_Estimate1 <- polynomial_model_summary$coefficients["poly(value, 2)1", "Estimate"]
  polynomial_Estimate2 <- polynomial_model_summary$coefficients["poly(value, 2)2", "Estimate"]
  
  #Get R2
    rsq <- as.numeric(r.squaredGLMM(linear_model))
    linear_marginal_R2 <- rsq[1]
    linear_conditional_R2 <- rsq[2]
  
  if (linear_p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = linear_AICc,
                                                     p.value1 = linear_p.value,
                                                     p.value2 = "NA",
                                                     Estimate1 = linear_Estimate,
                                                     Estimate2 = "NA",
                                                     Marginal_R2 = linear_marginal_R2,
                                                     Conditional_R2 = linear_conditional_R2,
                                                     type = "linear"))
    
    # Add the ggplot object to the plotlist
    plotlist[[paste0(parameter, "_linear")]] <- ggplot(data = subset_data, aes(x = value, y = Δ13C)) +
      geom_point() +
      geom_smooth(method = "lm") +
      labs(x = parameter) +
      theme_bw()
  }
  
    if (polynomial_p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = polynomial_AICc,
                                                     p.value1 = polynomial_p.value,
                                                     p.value2 = "NA",
                                                     Estimate1 = polynomial_Estimate1,
                                                     Estimate2 = polynomial_Estimate2,
                                                     Marginal_R2 = "NA",
                                                     Conditional_R2 = "NA",
                                                     type = "polynomial"))
    
    # Add the ggplot object to the plotlist
    plotlist[[paste0(parameter, "_polynomial")]] <- ggplot(data = subset_data, aes(x = value, y = Δ13C)) +
      geom_point() +
      geom_smooth(method = "lm", formula = y ~ poly(x, 2)) +
      labs(x = parameter) +
      geom_text(aes(label = Pin_Number)) +
      theme_bw()
    }
}

grid.arrange(grobs = plotlist, ncol = 2)

model_results$Species <- "Porites rus"

PRU_Δ13C_model_results <- model_results
PRU_Δ13C_model_results[order(PRU_Δ13C_model_results$AICc), c(10, 1, 3, 2, 5:9)]
```

```{r PRU_Δ13C_model_results}
model_results <- data.frame(Parameter = character(),
                            AICc = numeric(),
                            p.value1 = numeric(),
                            p.value2 = numeric(),
                            Estimate1 = numeric(),
                            Estimate2 = numeric(),
                            type = character(),
                            Marginal_R2 = numeric(),
                            Conditional_R2 = numeric(),
                            stringsAsFactors = FALSE)

plotlist <- list()

parameters <- unique(SI_data$Parameter)

for (parameter in parameters) {
  # Create a subset of data for the current parameter
  subset_data <- subset(SI_data, Parameter == parameter)
  subset_data <- subset(subset_data, Species == "Porites rus")
  subset_data <- subset(subset_data, HS == "host")
  
  # Fit the mixed-effects model
  linear_model <- lmer(Δ13C_T1T0 ~ value + (1|Genotype), data = subset_data)
  polynomial_model <- lmer(Δ13C_T1T0 ~ poly(value,2) + (1|Genotype), data = subset_data)
  
  # Get AICc
  linear_AICc <- AICc(linear_model)
  polynomial_AICc <- AICc(polynomial_model)
  
  # Get p-value from summary
  linear_model_summary <- summary(linear_model)
  anova_linear <- car::Anova(linear_model)
  linear_p.value <- anova_linear$`Pr(>Chisq)`
  linear_p.value <- linear_model_summary$coefficients["value", "Pr(>|t|)"]
  polynomial_model_summary <- summary(polynomial_model)
  anova_poly <- car::Anova(polynomial_model)
  polynomial_p.value <- anova_poly$`Pr(>Chisq)`
  
  # Get Estimate
  linear_Estimate <- linear_model_summary$coefficients["value", "Estimate"]
  polynomial_Estimate1 <- polynomial_model_summary$coefficients["poly(value, 2)1", "Estimate"]
  polynomial_Estimate2 <- polynomial_model_summary$coefficients["poly(value, 2)2", "Estimate"]
  
  #Get R2
    rsq <- as.numeric(r.squaredGLMM(linear_model))
    linear_marginal_R2 <- rsq[1]
    linear_conditional_R2 <- rsq[2]
  
  if (linear_p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = linear_AICc,
                                                     p.value1 = linear_p.value,
                                                     p.value2 = "NA",
                                                     Estimate1 = linear_Estimate,
                                                     Estimate2 = "NA",
                                                     Marginal_R2 = linear_marginal_R2,
                                                     Conditional_R2 = linear_conditional_R2,
                                                     type = "linear"))
    
    # Add the ggplot object to the plotlist
    plotlist[[paste0(parameter, "_linear")]] <- ggplot(data = subset_data, aes(x = value, y = Δ13C_T1T0)) +
      geom_point() +
      geom_smooth(method = "lm") +
      labs(x = parameter) +
      theme_bw()
  }
  
    if (polynomial_p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = polynomial_AICc,
                                                     p.value1 = polynomial_p.value,
                                                     p.value2 = "NA",
                                                     Estimate1 = polynomial_Estimate1,
                                                     Estimate2 = polynomial_Estimate2,
                                                     Marginal_R2 = "NA",
                                                     Conditional_R2 = "NA",
                                                     type = "polynomial"))
    
    # Add the ggplot object to the plotlist
    plotlist[[paste0(parameter, "_polynomial")]] <- ggplot(data = subset_data, aes(x = value, y = Δ13C_T1T0)) +
      geom_point() +
      geom_smooth(method = "lm", formula = y ~ poly(x, 2)) +
      labs(x = parameter) +
      geom_text(aes(label = Pin_Number)) +
      theme_bw()
    }
}

grid.arrange(grobs = plotlist, ncol = 2)

model_results$Species <- "Porites rus"

PRU_Δ13CT1T0_model_results <- model_results
PRU_Δ13CT1T0_model_results[order(PRU_Δ13CT1T0_model_results$AICc), c(10, 1, 3, 2, 5:9)]
```



```{r}
plot1 <- SI_data %>% 
  filter(Species == "Porites rus") %>% 
  filter(Parameter == "Low_Tide_Mean_NN_umolL") %>% 
  ggplot(aes(x = value, y = Δ15N)) +
      geom_point() +
      geom_smooth(method = "lm", formula = "y~poly(x,2)") +
      labs(x = "Low_Tide_Mean_NN_umolL", title = "Porites rus") +
      theme_bw()

plot2 <- SI_data %>% 
  filter(Species == "Porites rus") %>% 
  filter(Parameter == "Low_Tide_Mean_Phosphate_umolL") %>% 
  ggplot(aes(x = value, y = Δ13C)) +
      geom_point() +
      geom_smooth(method = "lm")+
      labs(x = "Low_Tide_Mean_Phosphate_umolL", title = "Porites rus") +
      theme_bw()

grid.arrange(plot1, plot2, ncol = 2)
```


### Versus growth

```{r}
SI_data_wide <- left_join(SI_data_wide, BW[,c("Placement_Code", "Percent_Change")])
SI_data_wide$Percent_Change <-100*SI_data_wide$Percent_Change
```

```{r, warning=FALSE, message=FALSE}
plot1 <- create_SI_plot(SI_data_wide, "Pocillopora acuta", "symb", "Percent_Change","δ15N", "δ15N")
plot2 <- create_SI_plot(SI_data_wide, "Pocillopora acuta", "host", "Percent_Change", "δ15N", "δ15N")
plot3 <- create_SI_plot(SI_data_wide, "Pocillopora acuta", "host", "Percent_Change", "Δ15N", "minus symbiont, Δ15N")
plot4 <- create_SI_plot(SI_data_wide, "Pocillopora acuta", "symb", "Percent_Change", "δ13C", "δ13C")
plot5 <- create_SI_plot(SI_data_wide, "Pocillopora acuta", "host", "Percent_Change", "δ13C", "δ13C")
plot6 <- create_SI_plot(SI_data_wide, "Pocillopora acuta", "host", "Percent_Change", "Δ13C", "minus symbiont, Δ13C")


legend <- gtable::gtable_filter(ggplot_gtable(ggplot_build(plot1 + theme(legend.position = "top"))), "guide-box")

acuta_SIvsgrowth_plots <- grid.arrange(plot1, plot2, plot3, plot4, plot5, plot6, legend, ncol = 3)
```

```{r}
plot1 <- create_SI_plot(SI_data_wide, "Porites rus", "symb", "Percent_Change","δ15N", "δ15N")
plot2 <- create_SI_plot(SI_data_wide, "Porites rus", "host", "Percent_Change", "δ15N", "δ15N")
plot3 <- create_SI_plot(SI_data_wide, "Porites rus", "host", "Percent_Change", "Δ15N", "minus symbiont, Δ15N")
plot4 <- create_SI_plot(SI_data_wide, "Porites rus", "symb", "Percent_Change", "δ13C", "δ13C")
plot5 <- create_SI_plot(SI_data_wide, "Porites rus", "host", "Percent_Change", "δ13C", "δ13C")
plot6 <- create_SI_plot(SI_data_wide, "Porites rus", "host", "Percent_Change", "Δ13C", "minus symbiont, Δ13C")


legend <- gtable::gtable_filter(ggplot_gtable(ggplot_build(plot1 + theme(legend.position = "top"))), "guide-box")

rus_SIvsgrowth_plots <- grid.arrange(plot1, plot2, plot3, plot4, plot5, plot6, legend, ncol = 3)
```


#### PC of response?
```{r PRU Response PC}
PRU_response_data$logsymb <- log10(PRU_response_data$FSC.Events_per_cm_2)
pca.data <-na.omit(PRU_response_data[,c("Pin_Number", "Percent_Change", "logsymb", "δ15N_host","δ15N_symb", "δ13C_host", "δ13C_symb")])
pca = princomp(pca.data[,c(2:7)], cor=TRUE)
summary(pca)
loadings(pca)
pca.data$pc1 = pca$scores[,1] #what's this data's score on pc1 axis
pca.data$pc2 = pca$scores[,2] #what's this data's score on pc2 axis
```

```{r}
biplot(pca)
```

```{r}
#ggplot(pca.data, aes(x=pc1, y=pc2))+
#  geom_point()
```

```{r}
pcoa = capscale(pca.data ~ 1, dist = "euclidean")
pcoa
```
The total inertia (0.889) is the summed squared Bray distance, which is the total variation in the
data. I don't fully understand the 'imaginary' vs. 'unconstrained' variance, but I know if you do this:
```{r}
summary <- summary(pcoa)
summary$cont
```
You can see that the first axis explains 87% of the variation... which is very very high. The second explains an additional 12% 

```{r}
par(mfrow = c(1,2))
plot(pcoa, type = 'n')
text(pcoa, "species", col = 'blue', cex = 1)
plot(pcoa, type = 'n')
#text(pcoa, "location", col = 'blue', cex = 0.5)
points(pcoa, col = 'black', bg = 'grey', pch = 21)
```


```{r}
proc <- procrustes(pca, pcoa)
plot(proc, main = "sample ordination")
```


```{r PAC Response PC}
PAC_response_data$log10symb <- log10(PAC_response_data$FSC.Events_per_cm_2)
pca.data <-na.omit(PAC_response_data[,c("Pin_Number", "Percent_Change", "log10symb", "δ15N_host","δ15N_symb", "δ13C_host", "δ13C_symb")])
pca = princomp(pca.data[,c("Percent_Change", "log10symb", "δ15N_host","δ15N_symb", "δ13C_host", "δ13C_symb")], cor=TRUE)
summary(pca)
loadings(pca)
```

```{r}
biplot(pca)
```
```{r PAC PCoA}
pcoa = capscale(pca.data ~ 1, dist = "euclidean")
pcoa
```

```{r}
par(mfrow = c(1,2))
plot(pcoa, type = 'n')
text(pcoa, "species", col = 'blue', cex = 1)
plot(pcoa, type = 'n')
#text(pcoa, "location", col = 'blue', cex = 0.5)
points(pcoa, col = 'black', bg = 'grey', pch = 21)
```

```{r}
unique(explanatory_all_wide[,c(mean_low_columns)])
colname <- unique(mean_low_columns)
loop <- ncol(explanatory_all_wide)

#for (i in 1:length(mean_low_columns)) {
#  hist(explanatory_all_wide[,c(i)])
#}

dist_explan_df <-explanatory_all_wide[,c("CowTagID", "Low_Tide_Mean_NN_umolL", "Low_Tide_Mean_Phosphate_umolL", "Low_Tide_Mean_Salinity", "Low_Tide_Mean_Temperature", "Low_Tide_Mean_TA", "Low_Tide_Mean_pH", "Low_Tide_Mean_Silicate_umolL")]

dist_explan_df <- dist_explan_df %>% 
  separate(col = CowTagID, sep = "V", into = c(NA, "Pin_Number")) %>% 
  filter(!Pin_Number == "14")

par(mfrow = c(2,5))
hist(explanatory_all_wide$Low_Tide_Mean_NN_umolL)
hist(explanatory_all_wide$Low_Tide_Mean_Phosphate_umolL)
hist(explanatory_all_wide$Low_Tide_Mean_Salinity)
hist(explanatory_all_wide$Low_Tide_Mean_Temperature)
hist(explanatory_all_wide$Low_Tide_Mean_TA)
hist(explanatory_all_wide$Low_Tide_Mean_pH)
hist(explanatory_all_wide$Low_Tide_Mean_Silicate_umolL)
```



```{r}
dist.explanatory <- dist(scale(x = dist_explan_df[,c(2:8)], scale = T, center = T), method = "euclidean")
dist.response <- dist(scale(x = pca.data[,c(2:7)], scale = T, center = T), method = "euclidean")
```

```{r}
response_by_explan <- mantel(dist.response, dist.explanatory, method = "spearman", permutations = 900, na.rm = TRUE)
response_by_explan
```



```{r}
analyze_species <- function(data, species, response_variable) {
  model_results <- data.frame(Parameter = character(),
                              AICc = numeric(),
                              p.value1 = numeric(),
                              p.value2 = numeric(),
                              Estimate1 = numeric(),
                              Estimate2 = numeric(),
                              type = character(),
                              stringsAsFactors = FALSE)
  plotlist <- list()
  
  parameters <- unique(data$Parameter)
  
  for (parameter in parameters) {
    # Create a subset of data for the current parameter
    subset_data <- data %>%
      filter(Parameter == parameter)
    
    # Fit the mixed-effects model
    linear_model <- lmer(as.formula(paste(response_variable, "~ value + (1|Genotype) + (1|Cage_Uncaged)")), data = subset_data)
    polynomial_model <- lmer(as.formula(paste(response_variable, "~ poly(value, 2) + (1|Genotype) + (1|Cage_Uncaged)")), data = subset_data)
    
    # Get AICc
    linear_AICc <- AICc(linear_model)
    polynomial_AICc <- AICc(polynomial_model)
    
    # Get p-value from summary
    linear_model_summary <- summary(linear_model)
    anova_linear <- car::Anova(linear_model)
    linear_p.value <- anova_linear$`Pr(>Chisq)`
    linear_p.value <- linear_model_summary$coefficients["value", "Pr(>|t|)"]
    
    polynomial_model_summary <- summary(polynomial_model)
    anova_poly <- car::Anova(polynomial_model)
    polynomial_p.value <- anova_poly$`Pr(>Chisq)`
    
    # Get Estimate
    linear_Estimate <- linear_model_summary$coefficients["value", "Estimate"]
    polynomial_Estimate1 <- polynomial_model_summary$coefficients["poly(value, 2)1", "Estimate"]
    polynomial_Estimate2 <- polynomial_model_summary$coefficients["poly(value, 2)2", "Estimate"]
    
    if (linear_p.value < 0.05) {
      # Add results to the dataframe
      model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                       AICc = linear_AICc,
                                                       p.value1 = linear_p.value,
                                                       p.value2 = NA,
                                                       Estimate1 = linear_Estimate,
                                                       Estimate2 = NA,
                                                       type = "linear"))
      
      # Add the ggplot object to the plotlist
      plotlist[[paste0(parameter, "_linear")]] <- ggplot(data = subset_data, aes(x = value, y = !!sym(response_variable))) +
        geom_point() +
        geom_smooth(method = "lm") +
        labs(x = parameter) +
        theme_bw()
    }
    
    if (polynomial_p.value < 0.05) {
      # Add results to the dataframe
      model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                       AICc = polynomial_AICc,
                                                       p.value1 = polynomial_p.value,
                                                       p.value2 = NA,
                                                       Estimate1 = polynomial_Estimate1,
                                                       Estimate2 = polynomial_Estimate2,
                                                       type = "polynomial"))
      
      # Add the ggplot object to the plotlist
      plotlist[[paste0(parameter, "_polynomial")]] <- ggplot(data = subset_data, aes(x = value, y = !!sym(response_variable))) +
        geom_point() +
        geom_smooth(method = "lm", formula = y ~ poly(x, 2)) +
        labs(x = parameter) +
        theme_bw()
    }
  }
  
  grid.arrange(grobs = plotlist, ncol = 2)
  
  return(model_results)
}
# Example usage:
# result <- analyze_species(SI_data, "Porites rus", "Δ15N")
```

```{r}
PAC_growth <- analyze_species(PAC_model_scaled_data_long, "Pocillopora acuta", "Percent_Change")
PAC_growth[order(PAC_growth$AICc),]
PAC_growth_model_results[order(PAC_growth_model_results$AICc),]
```

