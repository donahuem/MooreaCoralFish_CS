---
title: "Coral"
author: "Callie Stephenson"
date: "2023-08-29"
output: github_document
---
## Introduction

This is a R Markdown file in which I hope to write out my analyses. I will use this document to process all the R scripts found in the R folder and complete my project. 

#### Loading the data
```{r load packages, echo=FALSE, message=FALSE}
library(tidyverse)
library(here)
library(ggrepel)
library(patchwork)
library(tidytext)
library(AICcmodavg)
library(kableExtra)
library(PNWColors)
library(fishualize)
library(lme4)
library(lmerTest) #figure out which lme package you need
library(ggpp)
library(ggplot2)
library(GGally)
library(ggeffects)
```

```{r load data, echo=FALSE}
nut <- read.csv("data/March_nutrients_processed.csv")
sa <- read.csv("data/Surface_Area.csv")
BW <- read.csv("data/BW_tidy.csv") 
BW <- subset(BW, select=-c(1,4,5)) #remove some erroneous columns
TLE <- read.csv("data/TLE_summary.csv")
FCM <- read.csv("data/FCM_tidy.csv") %>% 
  rename(Placement_Code = PLACEMENT)


#meta takes a little massaging
PAC_meta <- read.csv("data/PAC_Coral_Codes.csv") %>% 
  select(!X) %>% 
  select(!X.1)
PAC_meta$Genotype <- gsub('PR21', 'PA21', PAC_meta$Genotype) #did find a typo in the genotypes here

PRU_meta <- read.csv("data/PRU_Coral_Codes.csv") %>% 
  select(!X)
meta <- rbind(PAC_meta, PRU_meta) %>% 
  select(!Species)
meta$Cage_Uncaged <- as.factor(meta$Cage_Uncaged)

#make a master data
data <- left_join(meta, BW, by = join_by(Placement_Code)) %>% 
  #select(!X) %>% #check that this doesn't need to be here
  left_join(TLE, by = join_by(Placement_Code, Species)) %>% 
  select(!X) %>% 
  left_join(FCM, by = join_by(Placement_Code))
```

### Data Exploration:
Data exploration focuses on the following points:
1. Outliers
2. Collinearity
3. Independence (Relationships between response and explanatory variables) 

#### Look for Outliers:
Buoyant Weight
It looks like that 13 A is really off. We know it broke, so I am removing it and replotted next to it:
```{r BW Outlier Tidy, echo=FALSE}
# BW Plot
BW <- merge(BW, meta[, c("Placement_Code", "Cage_Uncaged")], by = "Placement_Code")
BW_no <- BW[!(BW$Placement_Code == "PRU V13 A"), ]
```
```{r BW Outlier Plot, echo=FALSE}
par(mar = c(2.5, 1, 1, 1) + 0.1)
layout(matrix(1:2, nrow = 2), heights = c(3, 3))
dotchart(BW$Change_Over_Area, main = "∆BW", groups = BW$Cage_Uncaged)
dotchart(BW_no$Change_Over_Area, main = "∆BW removed erroneous data point", groups = BW_no$Cage_Uncaged)
layout(1)
```
I removed PRU V13 A placement because this was broken in the field, creating a large negative change in buoyant weight. 

TLE
```{r TLE Plot, echo=FALSE}
TLE <- merge(TLE, meta[, c("Placement_Code", "Cage_Uncaged")], by = "Placement_Code")
# Setting up the layout
layout(matrix(c(1, 2, 3, 4), 2, 2, byrow = TRUE))
# Side Max L Plot
dotchart(TLE$Max_L_AVG, main = "Max L", groups = TLE$Cage_Uncaged)
# Basal Max L plot
dotchart(TLE$Max_L_Basal, main = "Max L Basal", groups = TLE$Cage_Uncaged)
# Area plot
dotchart(TLE$Area_AVG, main = "Area", groups = TLE$Cage_Uncaged)
# Basal Area plot
dotchart(TLE$Area_Basal, main = "Basal Area", groups = TLE$Cage_Uncaged)
# Reset the layout
layout(1)
# Add a title
title("TLE Outlier Dotchart", line = -1, outer = TRUE, cex.main = 1.5)
```

### Symbionts

```{r Sym plot, echo=FALSE}
FCM <- FCM[complete.cases(FCM[, "Cage_Uncaged"]), ] #Remove T0 samples by only including rows where the "Cage_Uncaged" exists
FCM$Cage_Uncaged <- as.factor(FCM$Cage_Uncaged) 
FCM_no <- FCM[!(FCM$Placement_Code == "PRU V17 C"), ]
par(mar = c(2.5, 1, 1, 1) + 0.1)
layout(matrix(1:2, nrow = 2), heights = c(3, 3))
dotchart(FCM$FSC.Events_normalized, main = "Symbionts", groups = FCM$Cage_Uncaged)
dotchart(FCM_no$FSC.Events_normalized, main = "Symbionts without erroneous point", groups = FCM_no$Cage_Uncaged)
layout(1)
```
Jess will rerun PRU 49 (PRU V17 C) with her samples - I likely added twice as much as needed to the sample, but for now I will omit in my analyses (using dataframe FCM_no for "no outliers")

```{r}
ggplot(FCM_no, aes(x = Cage_Uncaged, y = FSC.Events_normalized, fill = Species)) +
  geom_violin() +
  geom_jitter(width = 0.2, height = 0, alpha = 0.5) +  # Adding jitter
  scale_fill_fish_d(option = "Acanthurus_olivaceus", alpha = 0.4, begin = 0.3, end = 1)+
  facet_wrap(~Species)
```

### Collinearity
need to make a datframe that's long that has all the nutrient metrics and independent variables
Here's the thing: we KNOW the nutrients are collinear
For example, here's a pairs plot for the maximum of all the nutrient values:
```{r collinearity}
nut_wide <- pivot_wider(
  data = nut,
  names_from = Parameters,
  values_from =3:9,
  names_glue = "{.value}_{Parameters}"
)

ggpairs(nut, columns = 2:8,progress = FALSE)
```

### Independence
```{r independence}

```

### Data Analysis
FCM Data Analysis:
```{r FCM vis, echo=FALSE}
anova_PRU <- aov(FSC.Events_normalized ~ Cage_Uncaged, data = FCM_no %>% filter(Species=="Porites_rus"))
summary(anova_PRU)

anova_PAC <- aov(FSC.Events_normalized ~ Cage_Uncaged, data = FCM_no %>% filter(Species=="Pocillopora_acuta"))
summary(anova_PAC)
```
```{r}
FCM$CowTagID <- paste0("V",FCM$Pin_Number) #make a joining variable
all_data <- left_join(FCM, nut, by="CowTagID")  #join them
all_data <- drop_na(all_data)
gg_data <- all_data %>% 
  filter(Parameters == "Phosphate_umolL")
```

```{r}
ggplot(gg_data, aes(x = CVSeasonal, y = FSC.Events_normalized,)) +
  geom_point(aes(color=Cage_Uncaged)) +  # Add points
  scale_color_fish_d(option = "Coryphaena_hippurus")+
  labs(title = "Number of Symbionts vs Phosphate Variability",
       x = "CV Phosphate",
       y = "Symbionts") +
  facet_wrap(~Species, scales = "free_y")
```

### Models

```{r response variable}
max <- all_data %>% 
       filter(Parameters=="Silicate_umolL")

hist(max$Maximum)
hist(log(max$Maximum))
```

```{r first symbiont model, echo=FALSE, warning=FALSE, message=FALSE}
m1 <- lm(FSC.Events_normalized ~ log(Maximum)*Cage_Uncaged, 
         data= all_data %>%
           filter(Parameters=="Silicate_umolL", Species=="Porites_rus"))
anova(m1)
summary(m1)
```

Now that we've done our data exploration, let's make the data frame needed to build some models!
```{r create all_data, warning=FALSE}
bw_no <- merge(BW_no, meta[, c('Placement_Code', 'Pin_Number','Genotype')], by = 'Placement_Code') #make a joining variable
bw_no$CowTagID <- paste0("V",bw_no$Pin_Number) #make it match with nutrient variable name
bw_sym_no <- left_join(bw_no, FCM_no[,c('Placement_Code','sym_FSC.Events_normalized')],
                       by="Placement_Code")

all_data <- left_join(bw_sym_no, nut, by="CowTagID")  #join them
all_data$Genotype <- as.factor(all_data$Genotype)
all_data$Normalized_Symbiont_Counts <- all_data$sym_FSC.Events_normalized
```

Preliminary models!
```{r starting models}
#For models of only caged corals, we are running with Genotype as covariate instead of random effect
#Cannot run as random effect without singularity (as there is only one occurance of genotype for every occurence of the nutrient parameter)
#for example, see how this is singular:
bw_m1_caged_PAC <-lmer(Percent_Change ~ CVSeasonal + (1 | Genotype), data = all_data %>% 
                    filter(Parameters == "Salinity" & Species == "PAC" & Cage_Uncaged == "C")) 
anova(bw_m1_caged_PAC)
                    
###
#Cannot run as random effect without singularity (as there is only one occurance of genotype for every occurence of the nutrient parameter)
bw_m1_caged_PAC <-lm(Percent_Change ~ CVSeasonal + Genotype,
                  data = all_data %>% 
                    filter(Parameters == "Salinity" & Species == "PAC" & Cage_Uncaged == "C"))
anova(bw_m1_caged_PAC)

bw_m1_caged_PRU <-lm(Percent_Change ~ CVSeasonal + Genotype,
                  data = all_data %>% 
                    filter(Parameters == "Salinity" & Species == "PRU" & Cage_Uncaged == "C"))
anova(bw_m1_caged_PRU)

#For models of all corals, we are running with Genotype as a random effect
bw_m1_PAC <- lmer(Percent_Change ~ CVSeasonal + (1 | Genotype) + Cage_Uncaged, 
                  data = all_data %>% 
                    filter(Parameters == "Salinity" & Species == "PAC"))
anova(bw_m1_PAC)

bw_m1_PRU <- lmer(Percent_Change ~ CVSeasonal + (1 | Genotype) + Cage_Uncaged, 
                  data = all_data %>% 
                    filter(Parameters == "Salinity" & Species == "PRU"))
anova(bw_m1_PRU)
summary(bw_m1_PRU)
```
Same models as before, but now with silicate instead, because the range in SiO32- was an order of magnitude higher on the reef than salinity allowing for a higher signal to noise ratio. I also used maximum silicate, as it is more indicative of the maximum amount of groundwater experienced
```{r starting models silicate}
#For models of only caged corals, we are running with Genotype as covariate instead of random effect
#Cannot run as random effect without singularity (as there is only one occurance of genotype for every occurence of the nutrient parameter)
#for example, see how this is singular:
bw_m1_caged_PAC <-lmer(Percent_Change ~ Maximum + (1 | Genotype), data = all_data %>% 
                    filter(Parameters == "Silicate_umolL" & Species == "PAC" & Cage_Uncaged == "C")) 
anova(bw_m1_caged_PAC)
                    
###
#Cannot run as random effect without singularity (as there is only one occurrence of genotype for every occurrence of the nutrient parameter)
bw_m1_caged_PAC <-lm(Percent_Change ~ Maximum + Genotype,
                  data = all_data %>% 
                    filter(Parameters == "Silicate_umolL" & 
                             Species == "PAC" & 
                             Cage_Uncaged == "C"))
anova(bw_m1_caged_PAC)

bw_m1_caged_PRU <-lm(Percent_Change ~ Maximum + Genotype,
                  data = all_data %>% 
                    filter(Parameters == "Silicate_umolL" & 
                             Species == "PRU" & 
                             Cage_Uncaged == "C"))
anova(bw_m1_caged_PRU)

#For models of all corals, we are running with Genotype as a random effect
bw_m1_PAC <- lmer(Percent_Change ~ Maximum + (1 | Genotype) + Cage_Uncaged, 
                  data = all_data %>% 
                    filter(Parameters == "Silicate_umolL" & 
                             Species == "PAC"))
anova(bw_m1_PAC)
summary(bw_m1_PAC)

bw_m1_PRU <- lmer(Percent_Change ~ Maximum + (1 | Genotype) + Cage_Uncaged, 
                  data = all_data %>% 
                    filter(Parameters == "Silicate_umolL" & 
                             Species == "PRU"))
anova(bw_m1_PRU)
summary(bw_m1_PRU)
```
This also only sees a correlation between all (not just caged) change in buoyant weight for PRU. PAC is not significant.

Now let's see those same models with symbiont counts
```{r starting models symb}
#again running with Genotype as covariate when only 
symb_m1_caged_PAC <-lm(Normalized_Symbiont_Counts ~ CVSeasonal + Genotype,
                  data = all_data %>% 
                    filter(Parameters == "Salinity" & Species == "PAC" & Cage_Uncaged == "C"))
anova(symb_m1_caged_PAC)

symb_m1_caged_PRU <-lm(Normalized_Symbiont_Counts ~ CVSeasonal + Genotype,
                  data = all_data %>% 
                    filter(Parameters == "Salinity" & Species == "PRU" & Cage_Uncaged == "C"))
anova(symb_m1_caged_PRU)

#but with all the corals we can use Genotype as random effect
symb_m1_PAC <- lmer(Normalized_Symbiont_Counts ~ CVSeasonal + (1 | Genotype) + Cage_Uncaged, 
                  data = all_data %>% 
                    filter(Parameters == "Salinity" & Species == "PAC"))
anova(symb_m1_PAC)

symb_m1_PRU <- lmer(Normalized_Symbiont_Counts ~ CVSeasonal + (1 | Genotype) + Cage_Uncaged, 
                  data = all_data %>% 
                    filter(Parameters == "Salinity" & Species == "PRU"))
anova(symb_m1_PRU)
summary(symb_m1_PRU)
```
Nothing significant there


IGNORE THESE PLOTS:
```{r proposal plots all bad very bad}
gg_data <- all_data %>% 
  filter(Parameters == "Salinity")

gg_data <- merge(gg_data, FCM_Join[, c("Placement_Code", "sym_FSC.Events")], by = "Placement_Code")

ggplot(gg_data, aes(x = CVSeasonal, y = Percent_Change, color = factor(Cage_Uncaged, labels = c("Uncaged", "Partially Caged", "Caged")))) +
  geom_point() + # add points
  geom_smooth(data = subset(gg_data, Species == "PRU"), method = "lm") + # only PRU was significant
  scale_color_fish_d(option = "Coryphaena_hippurus") +
  labs(
    title = "Percent Change in Buoyant Weight vs Salinity Variability",
    x = "CV Salinity",
    y = "Percent Change in Buoyant Weight",
    color = "Cage Status"
  ) +
  facet_wrap(~Species)

gg_data_no <- gg_data[!(gg_data$Placement_Code == "PRU V17 C"), ]

ggplot(gg_data_no, aes(x = CVSeasonal, y = Normalized_Symbiont_Counts,)) +
  geom_point(aes(color=Cage_Uncaged)) +  # Add points
  scale_color_fish_d(option = "Coryphaena_hippurus")+
  labs(title = "Number of Symbionts vs Salinity Variability",
       x = "CV Salinity",
       y = "Symbionts") +
  facet_wrap(~Species)

#NOW I'M ONLY LOOKING AT CAGED:
gg_data <- all_data %>% 
  filter(Parameters == "Silicate_umolL") %>% 
  filter(Cage_Uncaged == "C")

ggplot(gg_data, aes(x = CVSeasonal, y = Change_Over_Area)) +
  geom_point(aes(color=Species)) +  # Add points
  labs(title = "Percent Change in Buoyant Weight vs Salinity Variability",
       x = "CV Silicate",
       y = "Change Over Area")

```

```{r more symbiont in caged or no}
#IS C MORE LIKELY TO HAVE BEEN BIGGER THAN A OR B
sym_weight <- read.csv("data/Symbiont_filter_weight.csv")
sym_weight$Placement_Code <- sym_weight$Placement
sym_weight$Symbiont_dry_weight <- as.numeric(sym_weight$Symbiont_dry_weight)
sym_weight <- subset(sym_weight, Symbiont_dry_weight >= 0 & !is.na(Symbiont_dry_weight))
sym_weight <- merge(sym_weight, meta[, c("Placement_Code", "Cage_Uncaged")], by = "Placement_Code")

# Example boxplot
boxplot(Symbiont_dry_weight ~ Cage_Uncaged, data = sym_weight)

# Create subsets for each 'Cage_Uncaged' value
subset_A <- sym_weight$Symbiont_dry_weight[sym_weight$Cage_Uncaged == 'A']
subset_B <- sym_weight$Symbiont_dry_weight[sym_weight$Cage_Uncaged == 'B']
subset_C <- sym_weight$Symbiont_dry_weight[sym_weight$Cage_Uncaged == 'C']

# Calculate proportions for each subset
prop_A <- mean(subset_A > 0.5, na.rm = TRUE)
prop_B <- mean(subset_B > 0.5, na.rm = TRUE)
prop_C <- mean(subset_C > 0.5, na.rm = TRUE)

# Perform proportion test for 'C' vs 'A'
prop_test_result <- prop.test(c(sum(subset_C > 0.5), sum(subset_A > 0.5)), c(length(subset_C), length(subset_A)))

# Print the proportions and test result
cat("Proportion for 'C':", prop_C, "\n")
cat("Proportion for 'A':", prop_A, "\n")
print(prop_test_result)

```



