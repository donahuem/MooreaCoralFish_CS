---
title: "Coral Growth and Symbionts Analysis"
author: "Callie Stephenson"
date: "2023-08-29"
output: github_document
---
## Introduction

This is a R Markdown file in which I hope to write out my analyses. I will use this document to process all the R scripts found in the R folder and complete my project. 

#### Loading the data
```{r load packages, echo=FALSE, message=FALSE}
library(tidyverse)
library(here)
library(ggrepel)
library(patchwork)
library(tidytext)
library(AICcmodavg)
library(kableExtra)
library(PNWColors)
library(fishualize)
library(lme4)
library(lmerTest) #figure out which lme package you need
library(ggpp)
library(ggplot2)
library(GGally)
library(ggeffects)
library(arm) #discrete hist
library(MuMIn) #dredge
library(effects) #effects plots for dredged models
library(curl) #curl
library(gridExtra)
library(vegan) #pcoa
library(car)
```


```{r load data, echo=FALSE, message=FALSE}
#explanatory data
explanatory_all_wide <- read.csv("data/explanatory_all_wide.csv")

#Response data
response_data <- read.csv("data/response_data.csv")
response_data$Genotype <- as.factor(response_data$Genotype)
response_data$Cage_Uncaged <- as.factor(response_data$Cage_Uncaged)
response_data$Pin_Number <- as.factor(response_data$Pin_Number)

PRU_response_data <- response_data %>% 
  filter(Species == "Porites rus")

PRU_response_data_caged <- PRU_response_data %>% 
  filter(Cage_Uncaged == "C")

PAC_response_data <- response_data %>% 
  filter(Species == "Pocillopora acuta")

PAC_response_data_caged <- PAC_response_data %>% 
  filter(Cage_Uncaged == "C")

#metadata
meta <- read.csv("data/coral_metadata.csv")
```



```{r all data both seasons, warning=FALSE}
all_data_wide <- left_join(response_data, explanatory_all_wide, by = join_by(CowTagID))
```


```{r columns to dredge}
minimum_columns <- names(all_data_wide)[grepl("Minimum_", names(all_data_wide)) & 
                                     grepl("Salinity|Temperature|pH", names(all_data_wide))]
#LOOK OUT YOU CHANGED THIS ON APRIL 17
maximum_columns <- names(all_data_wide)[grepl("Maximum_", names(all_data_wide)) & 
                                  !grepl("Salinity|Temperature|Ammonia_umol",names(all_data_wide))]
#mean_columns <- names(all_data_wide)[grepl("Mean_", names(all_data_wide)) & 
#                                  !grepl("Salinity|Temperature|pH|Ammonia_umol",names(all_data_wide))]
CV_columns <- names(all_data_wide)[grepl("CV_", names(all_data_wide), names(all_data_wide))]

mean_low_columns <- names(all_data_wide)[grepl("Low_Tide_Mean_", names(all_data_wide), names(all_data_wide))]

variance_columns <- names(all_data_wide)[grepl("sd_", names(all_data_wide), names(all_data_wide))]

#PAC_model_data$CV_Salinity_scaled <- scale(PAC_model_data$CV_Salinity, TRUE, TRUE)
#PAC_model_data$CV_Temperature_scaled  <-  scale(PAC_model_data$CV_Temperature, TRUE, TRUE)
#PAC_model_data$CV_TA_scaled  <-  scale(PAC_model_data$CV_TA, TRUE, TRUE)
#PAC_model_data$CV_pH_scaled  <-  scale(PAC_model_data$CV_pH, TRUE, TRUE)
#PAC_model_data$Low_Tide_Mean_Phosphate_umolL_scaled<-
#  scale(PAC_model_data$Low_Tide_Mean_Phosphate_umolL, TRUE, TRUE)
#PAC_model_data$Low_Tide_Mean_NN_umolL_scaled  <-  
#  scale(PAC_model_data$Low_Tide_Mean_NN_umolL, TRUE, TRUE)
#PAC_model_data$Low_Tide_Mean_Ammonia_umolL_scaled  <-
#  scale(PAC_model_data$Low_Tide_Mean_Ammonia_umolL, TRUE, TRUE)
#PAC_model_data$Low_Tide_Mean_NNP_umolL_scaled <- 
#  scale(PAC_model_data$Low_Tide_Mean_Ammonia_umolL, TRUE, TRUE)


for (col in CV_columns) {
  scaled_variable <- paste0(col, "_scaled")
  scaled_values <- scale(all_data_wide[[col]], TRUE, TRUE)
  all_data_wide[[scaled_variable]] <- scaled_values[, 1]
}

for (col in mean_low_columns) {
  scaled_variable <- paste0(col, "_scaled")
  scaled_values <- scale(all_data_wide[[col]], TRUE, TRUE)
  all_data_wide[[scaled_variable]] <- scaled_values[, 1]
}

for (col in minimum_columns) {
  scaled_variable <- paste0(col, "_scaled")
  scaled_values <- scale(all_data_wide[[col]], TRUE, TRUE)
  all_data_wide[[scaled_variable]] <- scaled_values[, 1]
}

for (col in maximum_columns) {
  scaled_variable <- paste0(col, "_scaled")
  scaled_values <- scale(all_data_wide[[col]], TRUE, TRUE)
  all_data_wide[[scaled_variable]] <- scaled_values[, 1]
}

for (col in variance_columns) {
  scaled_variable <- paste0(col, "_scaled")
  scaled_values <- scale(all_data_wide[[col]], TRUE, TRUE)
  all_data_wide[[scaled_variable]] <- scaled_values[, 1]
}

scaled_cv_columns <- names(all_data_wide)[grepl("^CV.*_scaled$", names(all_data_wide))]
scaled_ml_columns <- names(all_data_wide)[grepl("^Low.*_scaled$", names(all_data_wide))]
scaled_min_columns <- names(all_data_wide)[grepl("^Minimum.*_scaled$", names(all_data_wide))]
scaled_max_columns <- names(all_data_wide)[grepl("^Maximum.*_scaled$", names(all_data_wide))]
scaled_sd_columns <- names(all_data_wide)[grepl("^sd.*_scaled$", names(all_data_wide))]

# Extract column names for filtering
selected_columns <- c("FSC.Events_per_cm_2", "FSC.Events_per_g_dry_weight","Percent_Change", 
                      "Genotype", "Cage_Uncaged", "Species", "Pin_Number","shore_dist_m",
 #                     minimum_columns, 
#                      maximum_columns,
#                      CV_columns,
#                      mean_low_columns,
                      scaled_min_columns, 
                      scaled_max_columns,
#                      scaled_cv_columns,
                      scaled_ml_columns,
                      scaled_sd_columns,
                      "pulse_pc1")

model_data <- all_data_wide[, selected_columns]

#plotting columns:
plot_columns <- c("FSC.Events_per_cm_2", "FSC.Events_per_g_dry_weight","Percent_Change", 
                      "Genotype", "Cage_Uncaged", "Species", "Pin_Number","shore_dist_m",
                     minimum_columns, 
                      maximum_columns,
                  variance_columns,
                      mean_low_columns,
                      "pulse_pc1")

plot_data <- all_data_wide[,plot_columns]

PAC_model_data <- na.omit(model_data %>% 
                            filter(Species == "Pocillopora acuta")) #%>%
# filter(Cage_Uncaged == "C")

PAC_plot_data <-  na.omit(plot_data %>% 
                            filter(Species == "Pocillopora acuta"))

PRU_plot_data <-  na.omit(plot_data %>% 
                            filter(Species == "Porites rus"))

PRU_model_data <- na.omit(model_data %>% 
        filter(Species == "Porites rus")) # %>% 
#  filter(Cage_Uncaged == "C")

dredge.data <- na.omit(model_data[, c(scaled_ml_columns,
                      scaled_sd_columns
                      #mean_low_columns, 
#                                    minimum_columns,
#                                    mean_columns, #removed bc not enough data for the amount of variables
#                                  CV_columns,
#                                  variance_columns
#                     mean_low_columns,
#                      scaled_min_columns, 
#                      scaled_max_columns,
#                      scaled_cv_columns,
#                      scaled_ml_columns
)])
```



### Data Analysis
```{r}
PAC_model_scaled_data_long <- pivot_longer(
  data = PAC_model_data[,c(1:36)], #35 is the Pin_Number CS EDITED JUNE 6
  cols = c(shore_dist_m:pulse_pc1)) 
names(PAC_model_scaled_data_long)[names(PAC_model_scaled_data_long) == "name"] <- "Parameter"

#PAC_model_data_long <- pivot_longer(
#  data = PAC_model_data[,c(1:5,6:31)],
#  cols = c(Minimum_Salinity:Low_Tide_Mean_Ammonia_umolL)) 
#names(PAC_model_data_long)[names(PAC_model_data_long) == "name"] <- "Parameter"


#make the PRU data frame longer
PRU_model_scaled_data_long <- pivot_longer(
  data = PRU_model_data[,c(1:36)], #35 is the Pin_Number CS EDITED JUNE 6
  cols = c(shore_dist_m:pulse_pc1)) 
names(PRU_model_scaled_data_long)[names(PRU_model_scaled_data_long) == "name"] <- "Parameter"
```


FCM Data Analysis:
```{r FCM vis, echo=FALSE}
#anova_PRU <- aov(FSC.Events_per_cm_2 ~ Cage_Uncaged + (1|Pin_Number), 
#                 data = model_data %>% 
#                   filter(!is.na(FSC.Events_per_cm_2)) %>% 
#                   filter(Species=="Porites rus") %>% 
#                   filter(!Pin_Number == "0"))
#summary(anova_PRU)

anova_PRU <- lmer(FSC.Events_per_cm_2 ~ Cage_Uncaged + (1|Pin_Number), 
                 data = model_data %>% 
                   filter(!is.na(FSC.Events_per_cm_2)) %>% 
                   filter(Species=="Porites rus") %>% 
                   filter(!Pin_Number == "0"))
summary(anova_PRU)
Anova(anova_PRU)
#caging did not effect symbionts in P. rus
#almost significant (p = 0.59)

#anova_PAC <- aov(FSC.Events_per_cm_2 ~ Cage_Uncaged + (1|Pin_Number), 
#                 data = model_data %>% 
#                   filter(Species=="Pocillopora acuta"))
#summary(anova_PAC)

anova_PAC <- lme4::lmer(FSC.Events_per_cm_2 ~ Cage_Uncaged + (1|Pin_Number), 
                 data = model_data %>% 
                   filter(!is.na(FSC.Events_per_cm_2)) %>% 
                   filter(Species=="Pocillopora acuta"))
summary(anova_PAC)
Anova(anova_PAC)
#caging did not effect symbionts in P. acuta
#this I have a bit of a hard time believing 
```
## LMER FUNCTIONS:

```{r analyze function}
analyze_dsr <- function(data, species, response_variable) {
  model_results <- data.frame(Parameter = character(),
                              AICc = numeric(),
                              p.value1 = numeric(),
                              Estimate1 = numeric(),
                              Estimate2 = numeric(),
                              type = character(),
                              marginal_R2 = numeric(),
                              conditional_R2 = numeric(),
                              stringsAsFactors = FALSE)
  plotlist <- list()
  
  parameters <- unique(data$Parameter)
  
  for (parameter in parameters) {
    # Create a subset of data for the current parameter
    subset_data <- data %>%
      filter(Parameter == parameter)
    
    # Fit the mixed-effects model
    linear_model <- lmer(as.formula(paste(response_variable, "~ value + (1|Genotype) + (1|Cage_Uncaged)")), data = subset_data)
    polynomial_model <- lmer(as.formula(paste(response_variable, "~ poly(value, 2) + (1|Genotype) + (1|Cage_Uncaged)")), data = subset_data)
    
    # Get AICc
    linear_AICc <- AICc(linear_model)
    polynomial_AICc <- AICc(polynomial_model)
    
    # Get p-value from summary
    linear_model_summary <- summary(linear_model)
    anova_linear <- car::Anova(linear_model)
    linear_p.value <- anova_linear$`Pr(>Chisq)`
    linear_p.value <- linear_model_summary$coefficients["value", "Pr(>|t|)"]
    
    polynomial_model_summary <- summary(polynomial_model)
    anova_poly <- car::Anova(polynomial_model)
    polynomial_p.value <- anova_poly$`Pr(>Chisq)`
    
    # Get Estimate
    linear_Estimate <- linear_model_summary$coefficients["value", "Estimate"]
    polynomial_Estimate1 <- polynomial_model_summary$coefficients["poly(value, 2)1", "Estimate"]
    polynomial_Estimate2 <- polynomial_model_summary$coefficients["poly(value, 2)2", "Estimate"]
    
    #Calculate R2
    linear_marginal_R2 <- r.squaredGLMM(linear_model)[[1]]
    linear_conditional_R2 <- r.squaredGLMM(linear_model)[[2]]
    
    polynomial_marginal_R2 <- r.squaredGLMM(polynomial_model)[[1]]
    polynomial_conditional_R2 <- r.squaredGLMM(polynomial_model)[[2]]
    
    if (linear_p.value < 0.05) {
      # Add results to the dataframe
      model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                       AICc = linear_AICc,
                                                       p.value1 = linear_p.value,
                                                       Estimate1 = linear_Estimate,
                                                       Estimate2 = NA,
                                                       type = "linear",
                                                       marginal_R2 = linear_marginal_R2,
                                                       conditional_R2 = linear_conditional_R2))
      
      # Add the ggplot object to the plotlist
      plotlist[[paste0(parameter, "_linear")]] <- ggplot(data = subset_data, aes(x = value, y = !!sym(response_variable))) +
        geom_point() +
        geom_smooth(method = "lm") +
        labs(x = parameter) +
        theme_bw()
    }
    
    if (polynomial_p.value < 0.05) {
      # Add results to the dataframe
      model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                       AICc = polynomial_AICc,
                                                       p.value1 = polynomial_p.value,
                                                       Estimate1 = polynomial_Estimate1,
                                                       Estimate2 = polynomial_Estimate2,
                                                       type = "polynomial",
                                                       marginal_R2 = polynomial_marginal_R2,
                                                       conditional_R2 = polynomial_conditional_R2))
      
      # Add the ggplot object to the plotlist
      plotlist[[paste0(parameter, "_polynomial")]] <- ggplot(data = subset_data, aes(x = value, y = !!sym(response_variable))) +
        geom_point() +
        geom_smooth(method = "lm", formula = y ~ poly(x, 2)) +
        labs(x = parameter) +
        theme_bw()
    }
  }
  
  grid.arrange(grobs = plotlist, ncol = 2)
  
  return(model_results)
}
# Example usage:
# result <- analyze_dsr(SI_data, "Porites rus", "Δ15N")
```

```{r analyze function no re of cage}
analyze_dsr_caged <- function(data, species, response_variable) {
  model_results <- data.frame(Parameter = character(),
                              AICc = numeric(),
                              p.value1 = numeric(),
                              p.value2 = numeric(),
                              Estimate1 = numeric(),
                              Estimate2 = numeric(),
                              type = character(),
                              stringsAsFactors = FALSE)
  plotlist <- list()
  
  parameters <- unique(data$Parameter)
  
  for (parameter in parameters) {
    # Create a subset of data for the current parameter
    subset_data <- data %>% 
      filter(Parameter == parameter)
    
    # Fit the mixed-effects model
    linear_model <- lmer(as.formula(paste(response_variable, "~ value + (1|Genotype)")), data = subset_data)
    polynomial_model <- lmer(as.formula(paste(response_variable, "~ poly(value, 2) + (1|Genotype)")), data = subset_data)
    
    # Get AICc
    linear_AICc <- AICc(linear_model)
    polynomial_AICc <- AICc(polynomial_model)
    
    # Get p-value from summary
    linear_model_summary <- summary(linear_model)
    anova_linear <- car::Anova(linear_model)
    linear_p.value <- anova_linear$`Pr(>Chisq)`
    linear_p.value <- linear_model_summary$coefficients["value", "Pr(>|t|)"]
    
    polynomial_model_summary <- summary(polynomial_model)
    anova_poly <- car::Anova(polynomial_model)
    polynomial_p.value <- anova_poly$`Pr(>Chisq)`
    
    # Get Estimate
    linear_Estimate <- linear_model_summary$coefficients["value", "Estimate"]
    polynomial_Estimate1 <- polynomial_model_summary$coefficients["poly(value, 2)1", "Estimate"]
    polynomial_Estimate2 <- polynomial_model_summary$coefficients["poly(value, 2)2", "Estimate"]
    
    if (linear_p.value < 0.05) {
      # Add results to the dataframe
      model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                       AICc = linear_AICc,
                                                       p.value1 = linear_p.value,
                                                       p.value2 = NA,
                                                       Estimate1 = linear_Estimate,
                                                       Estimate2 = NA,
                                                       type = "linear"))
      
      # Add the ggplot object to the plotlist
      plotlist[[paste0(parameter, "_linear")]] <- ggplot(data = subset_data, aes(x = value, y = !!sym(response_variable))) +
        geom_point() +
        geom_smooth(method = "lm") +
        geom_text(aes(label = Pin_Number)) +
        labs(x = parameter) +
        theme_bw()
    }
    
    if (polynomial_p.value < 0.05) {
      # Add results to the dataframe
      model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                       AICc = polynomial_AICc,
                                                       p.value1 = polynomial_p.value,
                                                       p.value2 = NA,
                                                       Estimate1 = polynomial_Estimate1,
                                                       Estimate2 = polynomial_Estimate2,
                                                       type = "polynomial"))
      
      # Add the ggplot object to the plotlist
      plotlist[[paste0(parameter, "_polynomial")]] <- ggplot(data = subset_data, aes(x = value, y = !!sym(response_variable))) +
        geom_point() +
        geom_text(aes(label = Pin_Number)) +
        geom_smooth(method = "lm", formula = y ~ poly(x, 2)) +
        labs(x = parameter) +
        theme_bw()
    }
  }
  
  grid.arrange(grobs = plotlist, ncol = 2)
  
  return(model_results)
}
# Example usage:
# result <- analyze_dsr_caged(SI_data, "Porites rus", "Δ15N")
```


#### Pac growth
```{r, fig.height= 10}
PAC_growth_model_results <- analyze_dsr(PAC_model_scaled_data_long, "Pocillopora acuta", "Percent_Change")
PAC_growth_model_results[order(PAC_growth_model_results$AICc),]
```

##### Multivariate

```{r}
multivariate_PAC_growth <- lmer(Percent_Change ~ poly(sd_pH_scaled,2) + poly(Minimum_Salinity_scaled,2) +
                                 poly(Low_Tide_Mean_Phosphate_umolL_scaled,2) + 
#                                  poly(shore_dist_m,2) +
                                  (1|Genotype) + (1|Cage_Uncaged), data = PAC_model_data)

#summary(multivariate_PAC_growth)
car::Anova(multivariate_PAC_growth)
plot(allEffects(multivariate_PAC_growth))
```
Ok, so of the top 3 models, two explain different parts of the variation. pH variability and minimum salinity (a conservative SGD tracer, but also what Katie's paper found). Both unimodal, which is sick. 

```{r multivariate dredge}
multivariate_PAC_growth <- lmer(Percent_Change ~ 
                       poly(sd_pH_scaled,2) + 
                         poly(Minimum_Salinity_scaled,2) + 
                                 poly(Low_Tide_Mean_Phosphate_umolL_scaled,2) + 
#                                  poly(shore_dist_m,2) +
                       (1 | Genotype)+ (1|Cage_Uncaged), 
                                 data = PAC_model_data, 
                                 na.action = na.pass)

Anova(multivariate_PAC_growth)
plot(allEffects(multivariate_PAC_growth))

multivariate_PAC_growth_dredge <- dredge(multivariate_PAC_growth, trace = 2)
#model.sel(PAC_cv_low_growth_model_dredge)
PAC_growth.avg = model.avg(multivariate_PAC_growth_dredge, delta < 15)
summary(PAC_growth.avg)
PAC_growth.avg$sw
```

Both are better than either independently. When I add in the next two models, model averaging says it is better to include them, but if I look a this model, things aren't significant any more. Not sure how to interpret this.

```{r PLOTTING}
parameter <- c("sd_pH_scaled", "Minimum_Salinity_scaled", "Low_Tide_Mean_Phosphate_umolL_scaled")

#Plot1
plot1 <- ggplot(data = PAC_plot_data, aes(x = sd_pH, y = Percent_Change)) +
        geom_point() +
        geom_smooth(method = "lm", formula = y ~ poly(x, 2)) +
        labs(x = "Standard Deviation of pH", y = "Percent Change in Buoyant Weight") +
        theme_linedraw()
#Plot2
plot2 <- ggplot(data = PAC_plot_data, aes(x = Minimum_Salinity, y = Percent_Change)) +
        geom_point() +
        geom_smooth(method = "lm", formula = y ~ poly(x, 2)) +
        labs(x = "Minimum Salinity", y = "Percent Change in Buoyant Weight") +
        theme_linedraw()
#Plot3
plot3 <- ggplot(data = PAC_plot_data, aes(x = Low_Tide_Mean_Phosphate_umolL, y = Percent_Change)) +
        geom_point() +
        geom_smooth(method = "lm", formula = y ~ poly(x, 2)) +
        labs(x = "Low Tide Mean Phosphate umol/L", y = "Percent Change in Buoyant Weight") +
        theme_linedraw()

grid.arrange(plot1, plot2, plot3, nrow = 1)

```

```{r, fig.width=15}
parameters <- c("sd_pH", "Minimum_Salinity", "Low_Tide_Mean_Phosphate_umolL")

PAC_growth_plot_data_long_prep <- PAC_plot_data[,c("Percent_Change", parameters)]
PAC_growth_plot_data_long <- pivot_longer(PAC_growth_plot_data_long_prep, 
                                    cols = parameters,
                                    names_to = "Parameter", 
                                    values_to = "Value")
combined_plot <- ggplot(data = PAC_growth_plot_data_long, aes(x = Value, y = Percent_Change)) +
  geom_point() +
  geom_smooth(method = "lm", formula = y ~ poly(x, 2), color = "#265588") +
  labs(x = "", y = "Percent Change in Buoyant Weight") +
  facet_wrap(~ Parameter, scales = "free_x", nrow = 1) +
  theme_linedraw() +
  theme(strip.background = element_rect(fill = "#265588"))

parameter_titles <- c("sd_pH" = "Standard deviation of pH",
                      "Minimum_Salinity" = "Minimum Salinity",
                      "Low_Tide_Mean_Phosphate_umolL" = "Low Tide Mean Phosphate (μmol/L)")

combined_plot <- combined_plot +
  theme(strip.background = element_rect(fill = "#265588")) +
  # Updating facet labels
  labs(title = "") +
  theme(strip.text.x = element_text(size = 12, face = "bold"),
        strip.text.y = element_text(size = 12, face = "bold")) +
  facet_wrap(~ Parameter, scales = "free_x", nrow = 1, labeller = labeller(Parameter = parameter_titles))

# Print the combined plot
print(combined_plot)
ggsave(filename = "output/PAC_growth_multivariate_effects_plot.png", plot = combined_plot, width = 10, height = 5)
```


#### Pru growth 
Pru growth vs shore distance:
```{r}
PRU_model_data1 <- PRU_model_data %>%  filter(Cage_Uncaged == "C")
shore_dist <- lmer(Percent_Change ~ shore_dist_m + (1|Genotype), data = PRU_model_data1)
#summary(shore_dist)
Anova(shore_dist)
```


```{r}
PRU_model_scaled_data_long %>% 
  filter(Cage_Uncaged == "C") %>% 
       filter(!(Pin_Number == "14")) %>%  #found this in earlier code
  analyze_dsr_caged("Porites rus", "Percent_Change") -> PRU_growth_model_results
PRU_growth_model_results[order(PRU_growth_model_results$AICc),]
```


##### Multivariate PRU Growth:
```{r, eval = FALSE}
multivariate_PRU_growth <- lmer(Percent_Change ~ poly(sd_Phosphate_umolL_scaled,2) + 
                                  poly(shore_dist_m,2) + (1|Genotype), data = PRU_model_data1)
#summary(multivariate_PRU_growth)
car::Anova(multivariate_PRU_growth)
```
```{r multivariate dredge}
multivariate_PRU_growth <- lmer(Percent_Change ~ 
                       poly(sd_Phosphate_umolL_scaled,2) + 
                         poly(shore_dist_m,2) + 
                                 poly(Minimum_pH_scaled,2) +
                       (1 | Genotype), 
                                 data = PRU_model_data1, 
                                 na.action = na.pass)

multivariate_PRU_growth_dredge <- dredge(multivariate_PRU_growth, trace = 2)
#model.sel(PAC_cv_low_growth_model_dredge)
PRU_growth.avg = model.avg(multivariate_PRU_growth_dredge, delta < 15)
summary(PRU_growth.avg)
PRU_growth.avg$sw
```

Better together than apart, but really are any of these good???

#### Pac symb

```{r}
PAC_model_scaled_data_long$log_sym_cm2 <- log10(PAC_model_scaled_data_long$FSC.Events_per_cm_2)
PAC_model_scaled_data_long$log_sym_gm <- log10(PAC_model_scaled_data_long$FSC.Events_per_g_dry_weight)

PAC_sym_cm2_model_results <- analyze_dsr(PAC_model_scaled_data_long, "Pocillopora acuta", "log_sym_cm2")
PAC_sym_cm2_model_results[order(PAC_sym_cm2_model_results$AICc),]

PAC_sym_gm_model_results <- analyze_dsr(PAC_model_scaled_data_long, "Pocillopora acuta", "log_sym_gm")
PAC_sym_gm_model_results[order(PAC_sym_gm_model_results$AICc),]
```


#### Pru symb 
```{r, message=FALSE}
PRU_model_scaled_data_long$log_sym_cm2 <- log10(PRU_model_scaled_data_long$FSC.Events_per_cm_2)
PRU_model_scaled_data_long$log_sym_gm <- log10(PRU_model_scaled_data_long$FSC.Events_per_g_dry_weight)

PRU_sym_cm2_model_results <- analyze_dsr(PRU_model_scaled_data_long, "Porites rus", "log_sym_cm2")
PRU_sym_cm2_model_results[order(PRU_sym_cm2_model_results$AICc),]

PRU_sym_gm_model_results <- analyze_dsr(PRU_model_scaled_data_long, "Porites rus", "log_sym_gm")
PRU_sym_gm_model_results[order(PRU_sym_gm_model_results$AICc),]
```

```{r PLOTTING IT}
pru_symb <- ggplot(data = PRU_plot_data, aes(x = Low_Tide_Mean_Phosphate_umolL, y = log10(FSC.Events_per_cm_2))) +
  geom_point() +
  geom_smooth(method = "lm", formula = y ~ poly(x, 2), color = "#265588") +
  labs(x = expression("Low tide mean phosphate" ~ (μmol/L)),
       y = expression("Log"[10] ~ " Symbiodiniaceae cells per " ~ cm^2)) +
  theme_linedraw()

pru_symb

#ggsave(filename = "output/PRU_symb_effects_plot.png", plot = pru_symb, width = 5, height = 4)
```

## ISOTOPES

```{r}
SI <- read.csv("data/SI_Tidy.csv")
SI_join <- left_join(SI, explanatory_all_wide, by = "CowTagID")

selected_columns <- c("Δ13C", "Δ15N", "δ15N_symb", "δ15N_host","δ13C_symb", "δ13C_host", "Cage_Uncaged", "Species",
 #                     minimum_columns, 
#                      maximum_columns,
#                      CV_columns,
#                      mean_low_columns,
                      scaled_min_columns, 
                      scaled_max_columns,
#                      scaled_cv_columns,
                      scaled_ml_columns,
                      scaled_sd_columns,
                      "Pin_Number", "pulse_pc1")

SI_model_data <- all_data_wide[, selected_columns]


PAC_model_data <- na.omit(SI_model_data %>% 
                            filter(Species == "Pocillopora acuta"))

PRU_model_data <- na.omit(SI_model_data %>% 
        filter(Species == "Porites rus"))
```

### Carbon

Is C being shared:
```{r}
response_data %>% 
  filter(!Placement_Code == "T0") %>% 
  ggplot(aes(x = δ13C_symb, y = δ13C_host)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "steelblue2") +
#  geom_smooth(method = "lm") +
#  geom_text(aes(label = Pin_Number)) +
  facet_wrap(~Species, scales = "free")
```

From this, it looks like there is more heterotrophy going on in acuta than in rus. I don't know why rus symbionts would be so enriched in 13C compared to host. This tells me that rus did not have more heterotrophy, acuta might have. No clue is this is related to SGD or not.

```{r}
SI_join %>% 
  filter(!Placement_Code == "T0") %>% 
  ggplot(aes(y = Δ13C, x = Maximum_Silicate_umolL)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "steelblue2") +
#  geom_smooth(method = "lm") +
#  geom_text(aes(label = Pin_Number)) +
  facet_wrap(~Species, scales = "free")
```

```{r}
SI_join %>% 
  filter(!Placement_Code == "T0") %>% 
  ggplot(aes(y = Δ13C, x = pulse_pc1)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "steelblue2") +
#  geom_smooth(method = "lm") +
#  geom_text(aes(label = Pin_Number)) +
  facet_wrap(~Species, scales = "free")
```

This does not support increased heterotrophy due to SGD. 

### Nitrogen

```{r is N being shared, warning=FALSE}
response_data %>% 
  filter(!Placement_Code == "T0") %>% 
  ggplot(aes(x = δ15N_symb, y = δ15N_host)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
#  geom_smooth(method = "lm") +
#  geom_text(aes(label = Pin_Number)) +
  facet_wrap(~Species, scales = "free")
```

Looks like in acuta and in rus, there's a lot more heavy nitrogen in the host than in the symbiont. This *does* imply heterotrophy (since the trophic level of host food and of symbionts should be the same).



```{r}
SI_join %>%   
  filter(!Placement_Code == "T0") %>% 
  filter(HS == "symb") %>% 
  ggplot(aes(x = δ15N, y = log10(del15N))) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +
#  geom_smooth(method = "lm") +
  labs(x = "Coral Symbiont Bulk δ15N", y = "Turbinaria Bulk δ15N") +
#  geom_text(aes(label = Pin_Number)) +
  facet_wrap(~Species, scales = "free")
```
Acuta looks like it might be signiciant (rus definitely not)
```{r}
Acuta <- SI_join %>%   
  filter(!Placement_Code == "T0") %>% 
  filter(HS == "symb") %>%
  filter(Species == "Pocillopora acuta")
model <- lmer(δ15N ~ log10(del15N) + (1|Genotype), data = Acuta)
car::Anova(model)
summary(model)
```

I log-transformed the turbinaria data because it was very much not normal, and log10 helped. Coral symbiont δ15N is inversely correlated with Turbinaria δ15N (p=0.07529)

Let's see if this is varying by the nitrate/nitrite (the most SGD-y N source). Might need to re-summarize to make this DIN instead, but would make harder to interpret as SGD since ammonia is so biologically active


```{r, warning=FALSE}
plot_list <- list()
nitrate_parameters <- c("Maximum_NN_umolL", "Minimum_NN_umolL", "Low_Tide_Mean_NN_umolL", "Low_Tide_Mean_Ammonia_umolL")

for (parameter in nitrate_parameters) {
  # Filter data for the current species and only caged
  species_data <- SI_data_wide %>%
    filter(Species == "Porites rus") %>% 
    filter(HS == "host")
  
  # Create plot for the current species
  plot_list[[parameter]] <- species_data %>%
    ggplot(aes(x = .data[[parameter]], y = Δ15N)) +
    geom_point() +
    geom_smooth(method = "lm") +
#    facet_wrap(~ HS, scales = "free") +
    ggtitle(paste("Porites rus")) +  #Add species name to the plot title
    theme_bw()+
    ylim(-1.1, NA) 
}
grid.arrange(grobs = plot_list, ncol = 2)
```

But, right now, it doesn't look like this is tightly related to anything that relates to NN enrichment.

```{r, warning=FALSE}
plot_list <- list()

for (parameter in nitrate_parameters) {
  # Filter data for the current species and only caged
  species_data <- SI_data_wide %>%
    filter(Species == "Pocillopora acuta") %>% 
    filter(HS == "host")
  
  # Create plot for the current species
  plot_list[[parameter]] <- species_data %>%
    ggplot(aes(x = .data[[parameter]], y = Δ15N)) +
    geom_point() +
    geom_smooth(method = "lm") +
#    facet_wrap(~ HS, scales = "free") +
    ggtitle(paste("Pocillopora acuta")) +  #Add species name to the plot title
    theme_bw()+
    ylim(-1.1, NA) 
}
grid.arrange(grobs = plot_list, ncol = 2)
```

For either species.
```{r, warning=FALSE}
plot_list <- list()

for (parameter in nitrate_parameters) {
  # Filter data for the current species and only caged
  species_data <- SI_data_wide %>%
    filter(Species == "Pocillopora acuta")
  
  # Create plot for the current species
  plot_list[[parameter]] <- species_data %>%
    ggplot(aes(x = .data[[parameter]], y = δ15N_T1_T0)) +
    geom_point() +
    geom_smooth(method = "lm") +
    facet_wrap(~ HS, scales = "free_x") +
    ggtitle("Pocillopora acuta") +  #Add species name to the plot title
    theme_bw()
}
grid.arrange(grobs = plot_list, ncol = 2)
```

### Exploring plots of symbionts and growth vs. isotope values
```{r}
SI_data_wide <- left_join(SI_data_wide, response_data[,c("Placement_Code", "FSC.Events_per_cm_2")])
SI_data_wide$log10symbcount <- log10(SI_data_wide$FSC.Events_per_cm_2)
```

If you remember, the P. acuta did not have anything affecting its symbionts, but rus did. 

```{r Acuta vs symbionts, fig.width=12, fig.height=6}
create_SI_plot <- function(data, species, host_sym, y_variable, title_suffix) {
  data %>%
    filter(Species == {species}) %>% 
    filter(HS == {host_sym}) %>% 
    ggplot(aes(x = log10(FSC.Events_per_cm_2), y = !!sym(y_variable))) +
    geom_point(aes(shape = Genotype)) +
    geom_smooth(method = "lm") +
    ggtitle(paste(species, host_sym, title_suffix)) +  
    theme_bw() +
    theme(legend.position = "none")
}

plot1 <- create_SI_plot(SI_data_wide, "Pocillopora acuta", "symb", "δ15N", "δ15N")
plot2 <- create_SI_plot(SI_data_wide, "Pocillopora acuta", "host", "δ15N", "δ15N")
plot3 <- create_SI_plot(SI_data_wide, "Pocillopora acuta", "host", "Δ15N", "minus symbiont, Δ15N")
plot4 <- create_SI_plot(SI_data_wide, "Pocillopora acuta", "symb", "δ13C", "δ13C")
plot5 <- create_SI_plot(SI_data_wide, "Pocillopora acuta", "host", "δ13C", "δ13C")
plot6 <- create_SI_plot(SI_data_wide, "Pocillopora acuta", "host", "Δ13C", "minus symbiont, Δ13C")

legend <- gtable::gtable_filter(ggplot_gtable(ggplot_build(plot1 + theme(legend.position = "top"))), "guide-box")

acuta_SIvssymb_plots <- grid.arrange(plot1, plot2, plot3, plot4, plot5, plot6, legend, ncol = 3)
```

I'm not surprised these mostly look like flat lines. Let's look at the symbionts versus the rus:

```{r Prus symb vs isotopes plots, warning=FALSE, message=FALSE, fig.height=6, fig.width=10}
SI_data_wide_no_14C <- SI_data_wide %>%
  filter(!(Pin_Number == 14))

plot1 <- create_SI_plot(SI_data_wide_no_14C, "Porites rus", "symb", "δ15N", "δ15N")
plot2 <- create_SI_plot(SI_data_wide_no_14C, "Porites rus", "host", "δ15N", "δ15N")
plot3 <- create_SI_plot(SI_data_wide_no_14C, "Porites rus", "host", "Δ15N", "minus symbiont, Δ15N")
plot4 <- create_SI_plot(SI_data_wide_no_14C, "Porites rus", "symb", "δ13C", "δ13C")
plot5 <- create_SI_plot(SI_data_wide_no_14C, "Porites rus", "host", "δ13C", "δ13C")
plot6 <- create_SI_plot(SI_data_wide_no_14C, "Porites rus", "host", "Δ13C", "minus symbiont, Δ13C")

legend <- gtable::gtable_filter(ggplot_gtable(ggplot_build(plot1 + theme(legend.position = "top"))), "guide-box")

rus_SIvssymb_plots <- grid.arrange(plot1, plot2, plot3, plot4, plot5, plot6, legend, ncol = 3)
```

Ok, we expect Δ13C(h-s) to increase with increasing symbiont populations. This can make it hard to determine if changed in ∆13C are from additional symbionts decreasing the carbon pool or if increased heterotrophy. I think that because this is driven by the host getting more heavy carbon with more symbionts, this suggests heterotrophy instead of symbionts depleting the carbon pool. 

#### Just running a model to see bc the last plot looks potentially significant:

```{r rus symbiont vs isotope C}
Rus_data <- SI_data_wide %>%
  filter(Species == "Porites rus" & HS == "host")
model <- lmer(δ13C ~ log10(FSC.Events_per_cm_2) + (1|Genotype), data = Rus_data)
car::Anova(model)
model <- lmer(Δ13C ~ log10(FSC.Events_per_cm_2) + (1|Genotype), data = Rus_data)
car::Anova(model)
```
Ok so the host is going to have more 13C than the symbiont at higher symbiont populations in Porties rus corals, but we're not quite significant to the point where it is almost painful. 

Increased contributions of heterotrophically-derived carbon results in more pronounced differences between δ13C levels in host and Symbiodiniaceae (∆13C = δ13Chost - δ13Csymbiont) (Muscatine et al., 1989; M. E. A. Santos et al., 2021).

“During periods of high coral photosynthesis the internal carbon pool becomes enriched in 13C (higher δ13C values) as dissolved inorganic carbon enriched in 12C is preferentially fixed” [Wall et al., 2020, p. 954]. 
^this is what I want to look into, because if 12C is preferentially fixed then why is the host becoming enriched in 13C with more symbionts? shouldn't the symbionts be giving off a lot of 12C and then the coral would be fixing that??

```{r}
plot1 <- create_SI_plot(SI_data_wide_no_14C, "Porites rus", "symb", "δ15N_T1_T0", "δ15N_T1_T0")
plot2 <- create_SI_plot(SI_data_wide_no_14C, "Porites rus", "host", "δ15N_T1_T0", "δ15N_T1_T0")
plot3 <- create_SI_plot(SI_data_wide_no_14C, "Porites rus", "host", "Δ15N_T1T0", "minus symbiont, Δ15N")
plot4 <- create_SI_plot(SI_data_wide_no_14C, "Porites rus", "symb", "δ13C_T1_T0", "δ13C_T1_T0")
plot5 <- create_SI_plot(SI_data_wide_no_14C, "Porites rus", "host", "δ13C_T1_T0", "δ13C_T1_T0")
plot6 <- create_SI_plot(SI_data_wide_no_14C, "Porites rus", "host", "Δ13C_T1T0", "minus symbiont, Δ13C")

legend <- gtable::gtable_filter(ggplot_gtable(ggplot_build(plot1 + theme(legend.position = "top"))), "guide-box")

rus_SIvssymb_plots <- grid.arrange(plot1, plot2, plot3, plot4, plot5, plot6, legend, ncol = 3)
```

I'm pretty pumped that this looks the same, with relatively little enrichment in 13C in the symbionts as populations increase, but a strong increase in 13C in the host. To me, this is suggesting an indirect effect (or like, not really correlated?). I think the nutrients are increasing the symbionts and heterotrophy

```{r}
model <- lmer(δ13C_T1_T0 ~ log10(FSC.Events_per_cm_2) + pulse_pc1 + (1|Genotype), data = Rus_data)
car::Anova(model)
```

Adding in a SGD parameter (I tried silicate and pulse pc1) makes the symbionts more significant, but the SGD parameter isn't significant. I don't know how to interpret this, except that I wish that BOTH were significant, so I could say that SGD helps explain the residual variation from the symbiot count

```{r}
model <- lmer(Δ13C_T1T0 ~ log10(FSC.Events_per_cm_2) + pulse_pc1 + (1|Genotype), data = Rus_data)
car::Anova(model)
```

Cool. Now, neither are significant...



```{r rus symbiont vs isotope N}
Rus_data <- SI_data_wide %>%
  filter(Species == "Porites rus" & HS == "host")
model <- lmer(Δ13C_T1T0 ~ log10(FSC.Events_per_cm_2) + (1|Genotype), data = Rus_data)
car::Anova(model)
```

But, as expected from the plot, this is not congruent between C and N isotopes. 15N normally comes from more heterotrophy, whereas 14N is normally fixed from the environment.

#### PC of response?
```{r PRU Response PC}
PRU_response_data$logsymb <- log10(PRU_response_data$FSC.Events_per_cm_2)
pca.data <-na.omit(PRU_response_data[,c("Pin_Number", "Percent_Change", "logsymb", "δ15N_host","δ15N_symb", "δ13C_host", "δ13C_symb")])
pca = princomp(pca.data[,c(2:7)], cor=TRUE)
summary(pca)
loadings(pca)
pca.data$pc1 = pca$scores[,1] #what's this data's score on pc1 axis
pca.data$pc2 = pca$scores[,2] #what's this data's score on pc2 axis
```

```{r}
biplot(pca)
```

```{r}
#ggplot(pca.data, aes(x=pc1, y=pc2))+
#  geom_point()
```

```{r}
pcoa = capscale(pca.data ~ 1, dist = "euclidean")
pcoa
```
The total inertia (0.889) is the summed squared Bray distance, which is the total variation in the
data. I don't fully understand the 'imaginary' vs. 'unconstrained' variance, but I know if you do this:
```{r}
summary <- summary(pcoa)
summary$cont
```
You can see that the first axis explains 87% of the variation... which is very very high. The second explains an additional 12% 

```{r}
par(mfrow = c(1,2))
plot(pcoa, type = 'n')
text(pcoa, "species", col = 'blue', cex = 1)
plot(pcoa, type = 'n')
#text(pcoa, "location", col = 'blue', cex = 0.5)
points(pcoa, col = 'black', bg = 'grey', pch = 21)
```


```{r}
proc <- procrustes(pca, pcoa)
plot(proc, main = "sample ordination")
```


```{r PAC Response PC}
PAC_response_data$log10symb <- log10(PAC_response_data$FSC.Events_per_cm_2)
pca.data <-na.omit(PAC_response_data[,c("Pin_Number", "Percent_Change", "log10symb", "δ15N_host","δ15N_symb", "δ13C_host", "δ13C_symb")])
pca = princomp(pca.data[,c("Percent_Change", "log10symb", "δ15N_host","δ15N_symb", "δ13C_host", "δ13C_symb")], cor=TRUE)
summary(pca)
loadings(pca)
```

```{r}
biplot(pca)
```
```{r PAC PCoA}
pcoa = capscale(pca.data ~ 1, dist = "euclidean")
pcoa
```

```{r}
par(mfrow = c(1,2))
plot(pcoa, type = 'n')
text(pcoa, "species", col = 'blue', cex = 1)
plot(pcoa, type = 'n')
#text(pcoa, "location", col = 'blue', cex = 0.5)
points(pcoa, col = 'black', bg = 'grey', pch = 21)
```

```{r}
unique(explanatory_all_wide[,c(mean_low_columns)])
colname <- unique(mean_low_columns)
loop <- ncol(explanatory_all_wide)

#for (i in 1:length(mean_low_columns)) {
#  hist(explanatory_all_wide[,c(i)])
#}

dist_explan_df <-explanatory_all_wide[,c("CowTagID", "Low_Tide_Mean_NN_umolL", "Low_Tide_Mean_Phosphate_umolL", "Low_Tide_Mean_Salinity", "Low_Tide_Mean_Temperature", "Low_Tide_Mean_TA", "Low_Tide_Mean_pH", "Low_Tide_Mean_Silicate_umolL")]

dist_explan_df <- dist_explan_df %>% 
  separate(col = CowTagID, sep = "V", into = c(NA, "Pin_Number")) %>% 
  filter(!Pin_Number == "14")

par(mfrow = c(2,5))
hist(explanatory_all_wide$Low_Tide_Mean_NN_umolL)
hist(explanatory_all_wide$Low_Tide_Mean_Phosphate_umolL)
hist(explanatory_all_wide$Low_Tide_Mean_Salinity)
hist(explanatory_all_wide$Low_Tide_Mean_Temperature)
hist(explanatory_all_wide$Low_Tide_Mean_TA)
hist(explanatory_all_wide$Low_Tide_Mean_pH)
hist(explanatory_all_wide$Low_Tide_Mean_Silicate_umolL)
```



```{r}
dist.explanatory <- dist(scale(x = dist_explan_df[,c(2:8)], scale = T, center = T), method = "euclidean")
dist.response <- dist(scale(x = pca.data[,c(2:7)], scale = T, center = T), method = "euclidean")
```

```{r}
response_by_explan <- mantel(dist.response, dist.explanatory, method = "spearman", permutations = 900, na.rm = TRUE)
response_by_explan
```



```{r}
PAC_growth <- analyze_dsr(PAC_model_scaled_data_long, "Pocillopora acuta", "Percent_Change")
PAC_growth[order(PAC_growth$AICc),]
PAC_growth_model_results[order(PAC_growth_model_results$AICc),]
```

```{r}
PRU_growth <- analyze_dsr(PRU_model_scaled_data_long, "Porites rus", "Percent_Change")
PRU_growth[order(PRU_growth$AICc),]
```

```{r}
PRU_growth_caged_only <- PRU_model_scaled_data_long %>% 
  filter(Cage_Uncaged == "C") %>% 
  analyze_dsr_caged("Porites rus", "Percent_Change")

PRU_growth_caged_only[order(PRU_growth_caged_only$AICc),]
```