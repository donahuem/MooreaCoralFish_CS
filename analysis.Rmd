---
title: "Coral"
author: "Callie Stephenson"
date: "2023-08-29"
output: github_document
---
## Introduction

This is a R Markdown file in which I hope to write out my analyses. I will use this document to process all the R scripts found in the R folder and complete my project. 

#### Loading the data
```{r load packages, echo=FALSE, message=FALSE}
library(tidyverse)
library(here)
library(ggrepel)
library(patchwork)
library(tidytext)
library(AICcmodavg)
library(kableExtra)
library(PNWColors)
library(fishualize)
library(lme4)
library(lmerTest) #figure out which lme package you need
library(ggpp)
library(ggplot2)
library(GGally)
library(ggeffects)
library(arm) #discrete hist
```

```{r load data, echo=FALSE}
nut <- read.csv("data/March_nutrients_processed.csv")
sa <- read.csv("data/Surface_Area.csv")
BW <- read.csv("data/BW_tidy.csv") 
BW <- subset(BW, select=-c(1,4,5)) #remove some erroneous columns
TLE <- read.csv("data/TLE_summary.csv")
FCM <- read.csv("data/FCM_tidy.csv") %>% 
  rename(Placement_Code = PLACEMENT)
shore_dist <- read.csv("https://raw.githubusercontent.com/dbarnas/Community_Functional_Diversity/main/Data/Shore_distance.csv") #using Danielle's
seep_dist <- read.csv("https://raw.githubusercontent.com/dbarnas/Community_Functional_Diversity/main/Data/Plate_Distance_to_Seep.csv")
depth <- read.csv("https://raw.githubusercontent.com/njsilbiger/MooreaSGD_site-selection/main/Data/Adj_Sandwich_Depth.csv")
clod <- read.csv("data/Clod_Cards.csv")
clod$CowTagID <- paste0("V",clod$PIN)
clod <- clod[,c(13,11)]

depth <- depth[,c(1,2,6)]
shore_dist <- left_join(shore_dist, seep_dist)
shore_dist <- left_join(shore_dist, depth)


#meta takes a little massaging
PAC_meta <- read.csv("data/PAC_Coral_Codes.csv") 
PAC_meta <- PAC_meta[,c(3:10)]
PAC_meta$Species <- "Pocillopora acuta"
PAC_meta$Genotype <- gsub('PR21', 'PA21', PAC_meta$Genotype) #did find a typo in the genotypes here

PRU_meta <- read.csv("data/PRU_Coral_Codes.csv") 
PRU_meta <- PRU_meta[,c(2:9)]
PRU_meta$Species <- "Porites rus"

meta <- rbind(PAC_meta, PRU_meta)
meta$Cage_Uncaged <- as.factor(meta$Cage_Uncaged)

#make a master response variable data sheet
data <- left_join(meta[,c(2:4,7,8)], BW[,c(2,4,5)], by = join_by(Placement_Code)) %>% 
  #select(!X) %>% #check that this doesn't need to be here
  left_join(FCM[,c(1,15,17)], by = join_by(Placement_Code)) %>% 
  left_join(TLE[,c(3:7)], by = join_by(Placement_Code)) 
data$CowTagID <- paste0("V",data$Pin_Number)

PRU_response_data <- data %>% 
  filter(Species == "Porites rus")

PAC_response_data <- data %>% 
  filter(Species == "Pocillopora acuta")
```

```{r}
#combine nutrient data and shore distance for a master explanatory variable data sheet
explanatory <- left_join(nut, shore_dist[,c(2:3,6)], by = join_by(CowTagID))
```

```{r warning=FALSE}
#now make an all data that has both explanatory and response variables:
all_data <- left_join(data, explanatory, by = join_by(CowTagID))
#suppress warnings because there will be a many-to-many relationship between x and y
all_PAC_data <- all_data %>% 
  filter(Species == "Pocillopora acuta")

all_PRU_data <- all_data %>% 
  filter(Species == "Porites rus")
```

### Data Exploration:
Data exploration focuses on the following points:
1. Outliers
2. Collinearity
3. Independence (Relationships between response and explanatory variables) 

```{r fig.width=10, fig.height=10}
par(mfrow = c(4,4), oma=c(1,1,3,1))
hist(PAC_response_data$Change_Over_Area, main="Change Over Area", col="lightblue", xlab="Change_Over_Area")
hist_columns <- c(7:13)
for (i in 1:length(hist_columns)) {
  hist(PAC_response_data[, hist_columns[i]], col="lightblue", 
       main = paste("PAC", colnames(PAC_response_data)[hist_columns[i]], sep=" - "),
       xlab=colnames(data)[hist_columns[i]])
}
hist(PRU_response_data$Change_Over_Area, main="Change Over Area", col="darkolivegreen3", xlab="Change_Over_Area")
for (i in 1:length(hist_columns)) {
  hist(PRU_response_data[, hist_columns[i]], col="darkolivegreen3", 
       main = paste("PRU", colnames(PRU_response_data)[hist_columns[i]], sep=" - "),
       xlab=colnames(data)[hist_columns[i]])
}
main_title <- "Data Exploration"
title(main = main_title, outer = TRUE)
```

Ok so FSC.Events are both pretty right-skewed. We normally log10 transform these.

#### Look for Outliers:
Buoyant Weight
It looks like that 13 A is really off. We know it broke, so I am removing it and replotted next to it:
```{r BW Outlier Tidy, echo=FALSE}
# BW Plot
BW <- merge(BW, meta[, c("Placement_Code", "Cage_Uncaged")], by = "Placement_Code")
BW_no <- BW[!(BW$Placement_Code == "PRU V13 A"), ]
```

Now making a plot to look at outliers:

```{r BW Outlier Plot, echo=FALSE}
par(mar = c(2.5, 1, 1, 1) + 0.1)
layout(matrix(1:2, nrow = 2), heights = c(3, 3))
dotchart(BW$Change_Over_Area, main = "∆BW", 
         groups = BW$Cage_Uncaged)
dotchart(BW_no$Change_Over_Area, main = "∆BW removed erroneous data point", 
         groups = BW_no$Cage_Uncaged)
layout(1)
```
I removed PRU V13 A placement because this was broken in the field, creating a large negative change in buoyant weight. 

TLE
```{r TLE Plot, echo=FALSE}
TLE <- merge(TLE, meta[, c("Placement_Code", "Cage_Uncaged")], by = "Placement_Code")
# Setting up the layout
layout(matrix(c(1, 2, 3, 4), 2, 2, byrow = TRUE))
# Side Max L Plot
dotchart(TLE$Max_L_AVG, main = "Max L", groups = TLE$Cage_Uncaged)
# Basal Max L plot
dotchart(TLE$Max_L_Basal, main = "Max L Basal", groups = TLE$Cage_Uncaged)
# Area plot
dotchart(TLE$Area_AVG, main = "Area", groups = TLE$Cage_Uncaged)
# Basal Area plot
dotchart(TLE$Area_Basal, main = "Basal Area", groups = TLE$Cage_Uncaged)
# Reset the layout
layout(1)
# Add a title
title("TLE Outlier Dotchart", line = -1, outer = TRUE, cex.main = 1.5)
```

### Symbionts

```{r Sym plot, echo=FALSE}
FCM <- FCM[complete.cases(FCM[, "Cage_Uncaged"]), ] #Remove T0 samples by only including rows where the "Cage_Uncaged" exists
FCM$Cage_Uncaged <- as.factor(FCM$Cage_Uncaged) 
FCM_no <- FCM[!(FCM$Placement_Code == "PRU V17 C"), ]
par(mar = c(2.5, 1, 1, 1) + 0.1)
layout(matrix(1:2, nrow = 2), heights = c(3, 3))
dotchart(FCM$FSC.Events_per_cm_2, main = "Symbionts", groups = FCM$Cage_Uncaged)
dotchart(FCM_no$FSC.Events_per_cm_2, main = "Symbionts without erroneous point", groups = FCM_no$Cage_Uncaged)
layout(1)
```
Jess will rerun PRU 49 (PRU V17 C) with her samples - I likely added twice as much as needed to the sample, but for now I will omit in my analyses (using dataframe FCM_no for "no outliers")

```{r FCM Violin Plot}
ggplot(FCM_no, aes(x = Cage_Uncaged, y = log10(FSC.Events_per_cm_2), fill = Species)) +
  geom_violin() +
  geom_jitter(width = 0.2, height = 0, alpha = 0.5) +  # Adding jitter
  scale_fill_fish_d(option = "Acanthurus_olivaceus", alpha = 0.4, begin = 0.3, end = 1)+
  facet_wrap(~Species)+
  labs(title = expression(paste("Symbionts per ", cm^2, " by caging treatment")))+
  theme(plot.title = element_text(hjust = 0.5))
```
same but other normalization:
```{r}
ggplot(FCM_no, aes(x = Cage_Uncaged, y = log10(FSC.Events_per_g_dry_weight), fill = Species)) +
  geom_violin() +
  geom_jitter(width = 0.2, height = 0, alpha = 0.5) +  # Adding jitter
  scale_fill_fish_d(option = "Acanthurus_olivaceus", alpha = 0.4, begin = 0.3, end = 1) +
  facet_wrap(~Species)+
  labs(title = "Symbionts per g dry weight by caging treatment")+
  theme(plot.title = element_text(hjust = 0.5))
```

### Collinearity
need to make a dataframe that's long that has all the nutrient metrics and independent variables
```{r nutrient cleanup, message=FALSE}
nut_wide <- pivot_wider(
  data = explanatory,
  names_from = Parameters,
  values_from =3:7,
  names_glue = "{.value}_{Parameters}"
)

maximum_columns <- names(nut_wide)[grepl("Maximum_", names(nut_wide)) & 
                                     !grepl("Salinity|Temperature|pH", names(nut_wide))]

minimum_columns <- names(nut_wide)[grepl("Minimum_", names(nut_wide)) & 
                                     grepl("Salinity|Temperature|pH", names(nut_wide))]
nut_wide_no_seep <- nut_wide[nut_wide$CowTagID != 'VSEEP', ]
```
Here's the thing: we KNOW the nutrients are collinear
For example, here's a pairs plot for the maximum of all the nutrient values:

```{r pairs plot collinearity}
ggpairs(nut_wide_no_seep[, c(maximum_columns)],progress = FALSE)
```


#### PCA
I want to start exploring PCA's to explain the nutrient dynamics:

MJD says to run this w/o ammonia!! Originally, Ammonia was really heavily out-grouping. 
MJD: It is higher coming out of the seep, but it's taken up really quickly
Could be more of an alongshore axis (but you'll see later it's not acutally tightly correlated)

```{r PCA Max}
#MJD says to run this w/o ammonia!!
#NS says to try this w/o temp n pH
maximum_columns <- names(nut_wide)[grepl("Maximum_", names(nut_wide)) & 
                                     !grepl("Salinity|Temperature|pH|Ammonia_umol", names(nut_wide))]

#NS says to add in CV
CV_columns <- names(nut_wide)[grepl("CVSeasonal_", names(nut_wide), names(nut_wide))]

pca.max.data <- na.omit(nut_wide_no_seep[, c(maximum_columns, minimum_columns,CV_columns)]) #keeping V13 in this ex
pca.max = princomp(pca.max.data, cor=TRUE)
summary(pca.max)
loadings(pca.max)
```
These look nice!!!! let's see what the biplot looks like:

```{r}
biplot(pca.max, col = c('grey', 'blue'))
```
It looks like PC1 is really an axis of SGD influence, and that it can explain 92% of the variation of these nutrient dynamics. If things are interacting with PC1, they're probably doing so due to SGD influence. 


PC2 is mostly from Ammmonia, with some influence of pH and temp. I'm not quite sure how to interpret that yet.
```{r PCA Max axes into dataset, warning=FALSE}
nut_wide_no_seep$pc1 = pca.max$scores[,1] #what's this data's score on pc1 axis
nut_wide_no_seep$pc2 = pca.max$scores[,2] #what's this data's score on pc2 axis

#really, i want it back in explanatory:
nut_wide_no_seep <- nut_wide_no_seep[,c(1:47)]
explanatory2 <- pivot_longer(
  data = nut_wide_no_seep,
  cols = c(shore_dist_m:pc2)) # Specifying non-parameter columns
 # names_to = c("value", "Parameter") 
  #names_pattern = "^(.*?)_(.*)$"
#)

PAC_response_data_caged <- PAC_response_data %>% 
  filter(Cage_Uncaged == "C")

PAC_response_data_caged <- PAC_response_data_caged[,c("Change_Over_Area","Percent_Change","CowTagID")]
explanatory2 <- left_join(PAC_response_data_caged, explanatory2)
#explanatory2 <- pivot_longer(
#  data = nut_wide_no_seep,
#  cols = -c(CowTagID, lat, lon), # Specifying non-parameter columns
#  names_to = c(".value", "Parameter"), 
#  names_pattern = "^(.*?)_(.*)$"
#)

#wide data
all_data_pca <- left_join(data, explanatory2, by = join_by(CowTagID)) #supress warning bc this has many-to-many relationship
pca_data_wide <- left_join(nut_wide, data, by = join_by(CowTagID))
```
```{r}
plot <- explanatory2 %>%
  ggplot(aes(x = value, y = Percent_Change))+
  geom_point()+
  geom_smooth(method = "lm")+
  facet_wrap(~name, scales = "free")

ggsave(filename = "explanatory.png", plot = plot, width = 15, height = 15)
```

Megan wants me to 'take the loadings onto pc1'
make a "cheap map" that plots lat long and colors by pc1
```{r}
#editing nutwidenoseep so that i also now have clod card data. clean this up later
nut_wide_no_seep <- left_join(nut_wide_no_seep, clod) 

ggplot(nut_wide_no_seep, aes(x = lon, y = lat, color = pc1)) +
  geom_point() +
  labs(x = "Latitude", y = "Longitude", color = "PC1") +
  scale_color_fish(option = "Coryphaena_hippurus", direction = -1) +
  theme_minimal()
```

Should I incorporate shore dist? Shore dist might be linear with these nutrients, if it isn't, it's better to put into the models as a separate variable.
```{r PCA vs Shore Dist, warning=FALSE}
ggpairs(na.omit(nut_wide_no_seep)[c("pc1", "pc2", "shore_dist_m", "dist_to_seep_m")], progress = FALSE)
```
Not going to include in PCA, looks like it does its own thing, and can be built into models separately.
```{r warning=FALSE}
#reminder that V13 is removed in dist to seep stuff becuase it is not supposed to be there
ggplot(nut_wide_no_seep)+
  geom_point(aes(x=dist_to_seep_m, y=pc1, color = shore_dist_m))+
  scale_color_fish(option = "Coryphaena_hippurus")
```

### NS reccomendation

 * Grab both dataframes and make the same version of nut
 * make graphs that have the min/max (like you've put into the PCA) and then the PC axes and then the bw
 * use BW just caged and do model selection like Kyle says
 
```{r}

```


### Independence
```{r independence}

```

### Data Analysis
FCM Data Analysis:
```{r FCM vis, echo=FALSE}
anova_PRU <- aov(FSC.Events_per_cm_2 ~ Cage_Uncaged, 
                 data = FCM_no %>% 
                   filter(Species=="Porites_rus"))
summary(anova_PRU)

#caging did not effect P. rus

anova_PAC <- aov(FSC.Events_per_cm_2 ~ Cage_Uncaged, 
                 data = FCM_no %>% 
                   filter(Species=="Pocillopora_acuta"))
summary(anova_PAC)
#caging did not effect symbionts in P. acuta
#this I have a bit of a hard time believing 
```

### Models
```{r }
hist(all_data_pca$pc1)
bw_caged_PAC <-lmer(Percent_Change ~ shore_dist_m + (1 | Genotype), data = all_data %>% 
                    filter(Parameters == "Salinity" & 
                             Species == "Pocillopora acuta" 
                           & Cage_Uncaged == "C")) 
anova(bw_caged_PAC)


data = all_data_pca %>% 
                    filter(Parameter == "Salinity" & 
                             Species == "Pocillopora acuta" 
                           & Cage_Uncaged == "C")
#adding clod card, clean this up
data <- left_join(data, clod)

bw_caged_PAC <-lmer(Percent_Change ~ shore_dist_m + pc1 + (1 | Genotype), data = data) 
anova(bw_caged_PAC)

#this removes V13 because it doesn't have shore dist
ggplot(data, aes(x = X._loss, y = Percent_Change))+
  geom_point(aes(color = pc1))+
  scale_color_fish(option = "Coryphaena_hippurus")+
  geom_smooth(method = "lm", formula = 'y~poly(x,2)')+
  labs(title="Growth of Pocillopora acuta colonies against distance from shore")
```

So this is suggesting that distance from shore is significant, let's see if SGD is too:
```{r}
bw_caged_PAC <-lmer(Percent_Change ~ shore_dist_m + pc1 + pc2 + (1 | Genotype), data = all_data_pca %>% 
                    filter(Parameter == "Salinity" & 
                             Species == "Pocillopora acuta" 
                           & Cage_Uncaged == "C")) 
anova(bw_caged_PAC)
ggplot(data)+
  geom_point(aes(x = pc1, y = Percent_Change, color = shore_dist_m))+
  scale_color_fish(option = "Coryphaena_hippurus")+
  labs(title="Growth of Pocillopora acuta colonies against markers of Submarine Groundwater Discharge")
```


Now that we've done our data exploration, let's make the data frame needed to build some models!

```{r starting models with megan}
#For models of only caged corals, we are running with Genotype as covariate instead of random effect
#Cannot run as random effect without singularity (as there is only one occurance of genotype for every occurence of the nutrient parameter)
#for example, see how this is singular:

bw_m1_caged_PAC <-lmer(Percent_Change ~ shore_dist_m + (1 | Genotype), data = all_data %>% 
                    filter(Parameters == "Salinity" & Species == "Pocillopora acuta" & Cage_Uncaged == "C")) 
anova(bw_m1_caged_PAC)
summary(bw_m1_caged_PAC)

##plots with megan
ggplot(all_PAC_data) +
  geom_point(data = subset(all_PAC_data, Cage_Uncaged == "C"),
             aes(x = Genotype, y = Percent_Change, color = shore_dist_m)) +
  scale_color_fish(option = "Coryphaena_hippurus")
#this shore distance looks like it could be a trend

#variance components analysis within genotype and between genotype variance
#looking at all the variance in the data, looking at the grand mean vs. the mean for the random effects
#how much is between vs within genotype variance
bw_m1_caged_PRU <-lmer(Percent_Change ~ shore_dist_m + (1 | Genotype), data = all_data %>% 
                    filter(Parameters == "Salinity" & Species == "Porites rus" & Cage_Uncaged == "C")) 
anova(bw_m1_caged_PRU)
summary(bw_m1_caged_PRU)

ggplot(all_PRU_data) +
  geom_point(data = subset(all_PRU_data, Cage_Uncaged == "C"),
             aes(x = Genotype, y = Percent_Change, color = shore_dist_m))+
  scale_color_fish(option = "Coryphaena_hippurus")
```
```{r WHY YOU GET SINGULARITY IN ACUTA, eval = FALSE, echo=FALSE}
dataPAC = all_data %>%
  filter(Parameters == "Salinity" & Species == "PAC" & Cage_Uncaged == "C")

dataPRU = all_data %>% 
  filter(Parameters == "Salinity" & Species == "PRU" & Cage_Uncaged == "C")

ggplot(dataPAC) +
  geom_point(aes(x = Genotype, y = Percent_Change, color = shore_dist_m))+
  scale_color_fish(option = "Coryphaena_hippurus")
#NEARLY NO VARIATION ATTRIBUTABLE TO GENOTYPE

ggplot(dataPRU) +
  geom_point(aes(x = Genotype, y = Percent_Change, color = shore_dist_m))+
  scale_color_fish(option = "Coryphaena_hippurus")

#Q from MJD for KE:
#if you get an estimate of 0 for your random effect what do you do
#do you keep bc the structure is important
#or do you drop because the model becomes simpler

#To move forward: drop the random effect for PAC models.
```

```{r starting models, eval = FALSE, echo=FALSE}
###
#Cannot run as random effect without singularity (as there is only one occurance of genotype for every occurence of the nutrient parameter)
bw_m1_caged_PAC <-lm(Percent_Change ~ CVSeasonal + shore_dist_m,
                  data = all_data %>% 
                    filter(Parameters == "Salinity" & Species == "PAC" & Cage_Uncaged == "C"))
anova(bw_m1_caged_PAC)

bw_m1_caged_PRU <-lmer(Percent_Change ~ CVSeasonal + shore_dist_m + (1 | Genotype),
                  data = all_data %>% 
                    filter(Parameters == "Salinity" & Species == "PRU" & Cage_Uncaged == "C"))
anova(bw_m1_caged_PRU)

#For models of all corals, we are running with Genotype as a random effect
bw_m1_PAC <- lmer(Percent_Change ~ CVSeasonal + (1 | Genotype) + Cage_Uncaged, 
                  data = all_data %>% 
                    filter(Parameters == "Salinity" & Species == "PAC"))
anova(bw_m1_PAC)

bw_m1_PRU <- lmer(Percent_Change ~ CVSeasonal + (1 | Genotype) + Cage_Uncaged, 
                  data = all_data %>% 
                    filter(Parameters == "Salinity" & Species == "PRU"))
anova(bw_m1_PRU)
summary(bw_m1_PRU)
```
Same models as before, but now with silicate instead, because the range in SiO32- was an order of magnitude higher on the reef than salinity allowing for a higher signal to noise ratio. I also used maximum silicate, as it is more indicative of the maximum amount of groundwater experienced
```{r starting models silicate, eval = FALSE, echo=FALSE}
#For models of only caged corals, we are running with Genotype as covariate instead of random effect
#Cannot run as random effect without singularity (as there is only one occurance of genotype for every occurence of the nutrient parameter)
#for example, see how this is singular:
bw_m1_caged_PAC <-lmer(Percent_Change ~ Maximum + (1 | Genotype), data = all_data %>% 
                    filter(Parameters == "Silicate_umolL" & Species == "PAC" & Cage_Uncaged == "C")) 
anova(bw_m1_caged_PAC)
                    
###
#Cannot run as random effect without singularity (as there is only one occurrence of genotype for every occurrence of the nutrient parameter)
bw_m1_caged_PAC <-lm(Percent_Change ~ Maximum + Genotype,
                  data = all_data %>% 
                    filter(Parameters == "Silicate_umolL" & 
                             Species == "PAC" & 
                             Cage_Uncaged == "C"))
anova(bw_m1_caged_PAC)

bw_m1_caged_PRU <-lm(Percent_Change ~ Maximum + Genotype,
                  data = all_data %>% 
                    filter(Parameters == "Silicate_umolL" & 
                             Species == "PRU" & 
                             Cage_Uncaged == "C"))
anova(bw_m1_caged_PRU)

#For models of all corals, we are running with Genotype as a random effect
bw_m1_PAC <- lmer(Percent_Change ~ Maximum + (1 | Genotype) + Cage_Uncaged, 
                  data = all_data %>% 
                    filter(Parameters == "Silicate_umolL" & 
                             Species == "PAC"))
anova(bw_m1_PAC)
summary(bw_m1_PAC)

bw_m1_PRU <- lmer(Percent_Change ~ Maximum + (1 | Genotype) + Cage_Uncaged, 
                  data = all_data %>% 
                    filter(Parameters == "Silicate_umolL" & 
                             Species == "PRU"))
anova(bw_m1_PRU)
summary(bw_m1_PRU)
```
This also only sees a correlation between all (not just caged) change in buoyant weight for PRU. PAC is not significant.

Now let's see those same models with symbiont counts
```{r starting models symb, eval = FALSE, echo=FALSE}
#again running with Genotype as covariate when only 
symb_m1_caged_PAC <-lm(Normalized_Symbiont_Counts ~ CVSeasonal + Genotype,
                  data = all_data %>% 
                    filter(Parameters == "Salinity" & Species == "PAC" & Cage_Uncaged == "C"))
anova(symb_m1_caged_PAC)

symb_m1_caged_PRU <-lm(Normalized_Symbiont_Counts ~ CVSeasonal + Genotype,
                  data = all_data %>% 
                    filter(Parameters == "Salinity" & Species == "PRU" & Cage_Uncaged == "C"))
anova(symb_m1_caged_PRU)

#but with all the corals we can use Genotype as random effect
symb_m1_PAC <- lmer(Normalized_Symbiont_Counts ~ CVSeasonal + (1 | Genotype) + Cage_Uncaged, 
                  data = all_data %>% 
                    filter(Parameters == "Salinity" & Species == "PAC"))
anova(symb_m1_PAC)

symb_m1_PRU <- lmer(Normalized_Symbiont_Counts ~ CVSeasonal + (1 | Genotype) + Cage_Uncaged, 
                  data = all_data %>% 
                    filter(Parameters == "Salinity" & Species == "PRU"))
anova(symb_m1_PRU)
summary(symb_m1_PRU)
```
Nothing significant there


IGNORE THESE PLOTS:
```{r proposal plots all bad very bad, eval = FALSE, echo=FALSE}
gg_data <- all_data %>% 
  filter(Parameters == "Salinity")

gg_data <- merge(gg_data, FCM_Join[, c("Placement_Code", "sym_FSC.Events")], by = "Placement_Code")

ggplot(gg_data, aes(x = CVSeasonal, y = Percent_Change, color = factor(Cage_Uncaged, labels = c("Uncaged", "Partially Caged", "Caged")))) +
  geom_point() + # add points
  geom_smooth(data = subset(gg_data, Species == "PRU"), method = "lm") + # only PRU was significant
  scale_color_fish_d(option = "Coryphaena_hippurus") +
  labs(
    title = "Percent Change in Buoyant Weight vs Salinity Variability",
    x = "CV Salinity",
    y = "Percent Change in Buoyant Weight",
    color = "Cage Status"
  ) +
  facet_wrap(~Species)

gg_data_no <- gg_data[!(gg_data$Placement_Code == "PRU V17 C"), ]

ggplot(gg_data_no, aes(x = CVSeasonal, y = Normalized_Symbiont_Counts,)) +
  geom_point(aes(color=Cage_Uncaged)) +  # Add points
  scale_color_fish_d(option = "Coryphaena_hippurus")+
  labs(title = "Number of Symbionts vs Salinity Variability",
       x = "CV Salinity",
       y = "Symbionts") +
  facet_wrap(~Species)

#NOW I'M ONLY LOOKING AT CAGED:
gg_data <- all_data %>% 
  filter(Parameters == "Silicate_umolL") %>% 
  filter(Cage_Uncaged == "C")

ggplot(gg_data, aes(x = CVSeasonal, y = Change_Over_Area)) +
  geom_point(aes(color=Species)) +  # Add points
  labs(title = "Percent Change in Buoyant Weight vs Salinity Variability",
       x = "CV Silicate",
       y = "Change Over Area")

```

```{r more symbiont in caged or no, eval = FALSE, echo=FALSE}
#IS C MORE LIKELY TO HAVE BEEN BIGGER THAN A OR B
sym_weight <- read.csv("data/Symbiont_filter_weight.csv")
sym_weight$Placement_Code <- sym_weight$Placement
sym_weight$Symbiont_dry_weight <- as.numeric(sym_weight$Symbiont_dry_weight)
sym_weight <- subset(sym_weight, Symbiont_dry_weight >= 0 & !is.na(Symbiont_dry_weight))
sym_weight <- merge(sym_weight, meta[, c("Placement_Code", "Cage_Uncaged")], by = "Placement_Code")

# Example boxplot
boxplot(Symbiont_dry_weight ~ Cage_Uncaged, data = sym_weight)

# Create subsets for each 'Cage_Uncaged' value
subset_A <- sym_weight$Symbiont_dry_weight[sym_weight$Cage_Uncaged == 'A']
subset_B <- sym_weight$Symbiont_dry_weight[sym_weight$Cage_Uncaged == 'B']
subset_C <- sym_weight$Symbiont_dry_weight[sym_weight$Cage_Uncaged == 'C']

# Calculate proportions for each subset
prop_A <- mean(subset_A > 0.5, na.rm = TRUE)
prop_B <- mean(subset_B > 0.5, na.rm = TRUE)
prop_C <- mean(subset_C > 0.5, na.rm = TRUE)

# Perform proportion test for 'C' vs 'A'
prop_test_result <- prop.test(c(sum(subset_C > 0.5), sum(subset_A > 0.5)), c(length(subset_C), length(subset_A)))

# Print the proportions and test result
cat("Proportion for 'C':", prop_C, "\n")
cat("Proportion for 'A':", prop_A, "\n")
print(prop_test_result)

```



