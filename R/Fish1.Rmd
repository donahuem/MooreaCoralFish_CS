---
title: "Fish_Stuff"
author: "Callie Stephenson"
date: "2024-03-28"
output: html_document
---
```{r packages, message=FALSE}
library(dplyr)
library(readr)
library(here)
library(fishualize)
library(ggplot2)
library(vegan)
library(viridis)
```

```{r data}
setwd("/Users/calliestephenson/Documents/GitHub/MooreaCoralFish_CS")
maxn <- read.csv("/Users/calliestephenson/Documents/GitHub/MooreaCoralFish_CS/data/MaxN.csv")
explan<- read.csv("data/explanatory_all_wide.csv")
```

TIDY DATA:
```{r}
block_count_per_location <- maxn %>%
  group_by(Pin, On.Adjacent) %>%
  summarise(num_blocks = n_distinct(Block))

subset_maxn <- maxn %>%
  filter(!(Pin == "13" & On.Adjacent == "Adjacent")) %>% 
  group_by(Pin, On.Adjacent) %>%
  filter(Block %in% sample(unique(Block), 4, replace = FALSE)) %>%
  ungroup()

subset_block_count_per_location <- subset_maxn %>%
  group_by(Pin, On.Adjacent) %>%
  summarise(num_blocks = n_distinct(Block))
```

Use 4 blocks from each sampling location. This uses 4 from On and 4 from Adjacent, so 8 total for each pin.

Linda rec: make a plot that is ordered by the most abundant fish at site 17, then see if others do the same

```{r average maxn at each pin}
maxn_avg <- subset_maxn %>%
  group_by(Pin, Species) %>%
  summarize(avg_MaxN = mean(MaxN, na.rm = TRUE)) 

maxn_avg %>%
  ggplot(aes(x = Species, y = avg_MaxN)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ Pin) +
  labs(y = "Average MaxN", x = "Block", title = "Average MaxN of Each Species Across Blocks by Pin") +
  coord_flip()+
  theme_minimal()
```

```{r same but only top 20 species}
# Step 1: Calculate the overall average MaxN for each species
species_avg <- maxn_avg %>%
  group_by(Species) %>%
  summarize(overall_avg_MaxN = mean(avg_MaxN, na.rm = TRUE)) %>%
  arrange(desc(overall_avg_MaxN))

# Step 2: Identify the top 20 species based on the overall average MaxN
top_species <- species_avg %>%
  top_n(20, overall_avg_MaxN) %>%
  pull(Species)

maxn_avg_top <- maxn_avg %>%
  filter(Species %in% top_species)

maxn_avg_top %>%
  ggplot(aes(x = Species, y = avg_MaxN)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ Pin) +
  labs(y = "Average MaxN", x = "Block", title = "Average MaxN of Each Species Across Blocks by Pin") +
  coord_flip()+
  theme_minimal()
```

now let's order it by pin 14
```{r pin 14 most common}
# Step 1: Create a new column for avg_MaxN at Pin 14
pin14_avg <- maxn_avg_top %>%
  filter(Pin == 14) %>%
  dplyr::select(Species, avg_MaxN) %>%
  rename(MaxN_Pin14 = avg_MaxN)

# Step 2: Add MaxN_Pin14 to the original dataframe and calculate overall average MaxN
maxn_avg_top <- maxn_avg_top %>%
  left_join(pin14_avg[,c("Species","MaxN_Pin14")], by = "Species") %>%
  group_by(Species) %>%
  mutate(overall_avg_MaxN = mean(avg_MaxN, na.rm = TRUE)) %>%
  ungroup()

# Step 3: Define species order based on MaxN_Pin14 and overall_avg_MaxN
species_order <- maxn_avg_top %>%
  # Replace NA in MaxN_Pin14 with a very low value to ensure they come last
  mutate(MaxN_Pin14 = ifelse(is.na(MaxN_Pin14), -Inf, MaxN_Pin14)) %>%
  arrange(desc(MaxN_Pin14), desc(overall_avg_MaxN)) %>%
  pull(Species) %>%
  unique()

# Step 4: Reorder species factor levels
maxn_avg_top <- maxn_avg_top %>%
  mutate(Species = factor(Species, levels = species_order))

# Step 5: Create the plot with the reordered species
p1 <-maxn_avg_top %>%
  ggplot(aes(x = Species, y = avg_MaxN)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ Pin) +
  labs(y = "Average MaxN", x = "Species", title = "Average Abundance of the Most Common 20 Species Across Sampling Locations") +
  coord_flip() +  # Flip coordinates to have species names on y-axis
  theme_linedraw()+ 
  theme(plot.title = element_text(size=9))

p1

ggsave(filename = "output/most_common_fish.png", p1, height = 10, width = 5)
```

Ok, let's order this by distance to seep:

```{r by dist to seep}
explan <- explan %>%
  mutate(Pin = as.numeric(sub("V", "", CowTagID)))

maxn_explan <- left_join(maxn_avg_top, explan[,c("Pin", "dist_to_seep_m", "Low_Tide_Mean_Silicate_umolL")])

pin_order <- maxn_explan %>%
  distinct(Pin, dist_to_seep_m) %>%
  filter(Pin != 13) %>%  # Exclude Pin 13
  arrange(dist_to_seep_m) %>%
  pull(Pin)

maxn_explan <- maxn_explan %>%
  mutate(Pin = factor(Pin, levels = pin_order)) 

maxn_explan %>%
  ggplot(aes(x = Species, y = avg_MaxN)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ Pin) +
  labs(y = "Average MaxN", x = "Species", title = "Average Abundance of Each Species at Sampling Locations") +
  coord_flip()+
  theme_minimal()
```


```{r by dist to silicate}
explan <- explan %>%
  mutate(Pin = as.numeric(sub("V", "", CowTagID)))

maxn_explan <- left_join(maxn_avg_top, explan[,c("Pin", "dist_to_seep_m", "Low_Tide_Mean_Silicate_umolL")])

pin_order <- maxn_explan %>%
  distinct(Pin, Low_Tide_Mean_Silicate_umolL) %>%
#  filter(Pin != 13) %>%  # Exclude Pin 13
  arrange(Low_Tide_Mean_Silicate_umolL) %>%
  pull(Pin)

maxn_explan <- maxn_explan %>%
  mutate(Pin = factor(Pin, levels = pin_order)) 

maxn_explan %>%
  ggplot(aes(x = Species, y = avg_MaxN)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ Pin) +
  labs(y = "Average MaxN", x = "Species", title = "Average Abundance of Each Species at Sampling Locations") +
  coord_flip()+
  theme_minimal()
```

```{r by pulse pc 1}
explan <- explan %>%
  mutate(Pin = as.numeric(sub("V", "", CowTagID)))

maxn_explan <- left_join(maxn_avg_top, explan[,c("Pin", "pulse_pc1", "Low_Tide_Mean_Silicate_umolL")])

pin_order <- maxn_explan %>%
  distinct(Pin, pulse_pc1) %>%
#  filter(Pin != 13) %>%  # Exclude Pin 13
  arrange(pulse_pc1) %>%
  pull(Pin)

maxn_explan <- maxn_explan %>%
  mutate(Pin = factor(Pin, levels = pin_order)) 

maxn_explan %>%
  ggplot(aes(x = Species, y = avg_MaxN)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ Pin) +
  labs(y = "Average MaxN", x = "Species", title = "Average Abundance of Each Species at Sampling Locations") +
  coord_flip()+
  theme_minimal()
```


NMDS Code from Linda:

DATA CLEANING YOU NEED TO DEAL WITH:
```{r}
# Summarize to find duplicates
duplicates <- subset_maxn %>%
  dplyr::group_by(Pin, On.Adjacent, Block, Species) %>%
  dplyr::summarise(count = dplyr::n(), .groups = 'drop') %>%
  dplyr::filter(count > 1)

# Subset the original data to only include the duplicates
duplicate_rows <- subset_maxn %>%
  dplyr::inner_join(duplicates, by = c("Pin", "On.Adjacent", "Block", "Species")) %>%
  dplyr::arrange(Pin, On.Adjacent, Block, Species)
```


```{r wide data}
maxn_sum <- maxn %>%
  group_by(Pin, On.Adjacent, Block, Species) %>%
  summarize(MaxN = sum(MaxN, na.rm = TRUE)) %>%
  ungroup()

#make it wide
wide_maxn_df1 <- pivot_wider(maxn_sum, 
                             id_cols = c("Pin", "On.Adjacent", "Block"),
                             names_from = Species, 
                             values_from = MaxN)

#but now with only the blocks we are using:

subset_maxn1 <- subset_maxn %>%
  group_by(Pin, On.Adjacent, Block, Species) %>%
  summarize(MaxN = sum(MaxN, na.rm = TRUE)) %>%
  ungroup()

wide_maxn_df <- pivot_wider(subset_maxn1[,c("Pin","On.Adjacent","Block","Species","MaxN")], 
                             id_cols = c("Pin", "On.Adjacent", "Block"),
                             names_from = Species, 
                             values_from = MaxN)

#make the NAs as 0's
wide_maxn_df <- wide_maxn_df %>% 
  mutate_all(~ifelse(is.na(.), 0, .))
```

```{r}
##make a dataframe with ONLY your fish data
##within the parentheses you write which columns this would be
Fish2 <-wide_maxn_df[c(4:68)]

##extract the info about location (in this case your habitats) from the dataset, this table needs to have equal number of rows as the fish table
Sites<-wide_maxn_df[c(1)]
#str(Sites)
```

```{r}
##hellinger transformation is a common transformation with community data when you have a lot of zeros
Fish_com <- decostand(Fish2, method = "hellinger" )

##constructing the dissimilarity matrix, using bray -curtis "how differently are they different"
mat.dis_fish <- vegdist(Fish_com,method="bray")
```

```{r}
set.seed(123)

nmds = metaMDS(mat.dis_fish,k=2, trymax=500, distance = "bray")
##stressplot is just a diagnostic for your data, shows how your datapoints are distributed and should be somewhat linear..
stressplot(nmds) 
nmds

##Stress Value = how well doe your NMDS represent reality (<0.2)
plot(nmds, type = "text")
plot(nmds)
```

```{r}
data.scores = as.data.frame(scores(nmds))
#including the factors 

data.scores$Site = Sites$Pin
#data.scores$Site <- factor(data.scores$Site, levels = c(1:223))

head(data.scores)
```

```{r}
data.spp.fit <- envfit(nmds, Fish2, permutations = 999)

head(data.spp.fit)

spp.scrs <- as.data.frame(scores(data.spp.fit, display = "vectors")) #save species intrinsic values into dataframe
spp.scrs <- cbind(spp.scrs, Species = rownames(spp.scrs)) #add species names to dataframe

head(spp.scrs)

sig.spp.scrs <- spp.scrs
#sig.spp.scrs <- subset(spp.scrs, pval<=0.05) #subset data to show species significant at 0.05

#head(sig.spp.scrs)
```

```{r}
##set theme!
mytheme3<-theme(axis.title = element_text(size = 12, colour = "black"), 
                panel.background = element_blank(), panel.border = element_rect(fill = NA, colour = "black"), 
                axis.ticks = element_blank(), axis.text = element_text(size = 12), legend.key = element_blank(), 
                legend.title = element_text(size = 12, colour = "black"), 
                legend.text = element_text(size = 12, colour = "black"))
```

```{r}
library(viridis)
gg2 <- ggplot(data = data.scores, aes(x = NMDS1, y = NMDS2))+ 
  scale_color_viridis(discrete = TRUE, option = "D")+
  scale_fill_viridis(discrete = TRUE)+
  labs(colour = "Site")+
 ggtitle("NMDS")+  mytheme3

data.scores$Site <- as.factor(data.scores$Site)

g2<-gg2+geom_point(data = data.scores, aes(colour = Site, shape = Site),size = 3, alpha = 0.8)+
  #geom_segment(aes(x = 0, y = 0, xend = NMDS1, yend = NMDS2), 
             #  data = spp.scrs)+
  ggrepel::geom_text_repel(data = spp.scrs, aes(x=NMDS1, y=NMDS2, label = Species), cex = 3, direction = "both", segment.size = 0.25) #add labels for species, use ggrepel::geom_text_repel so that labels do not overlap

g2 <- g2 + scale_shape_manual(values = 1:20)  # Assuming there are 20 unique sites

g2
```

```{r FOR MACKENZIE!!!}
g3 <- gg2+geom_point(data = data.scores, aes(colour = Site, shape = Site),size = 3, alpha = 0.8)+ scale_shape_manual(values = 1:20)
g3

#ggsave("NMDS_for_MT.png", g3)
```

```{r}
gg1 =ggplot(data = data.scores, aes(x = NMDS1, y = NMDS2))+ 
  scale_color_viridis(discrete = TRUE, option = "D")+
  scale_fill_viridis(discrete = TRUE)+
  labs(colour = "Reef.zone")+
  stat_ellipse(aes(fill = Site), geom = "polygon", alpha = .4,
               type="t",level = 0.95,linetype = 3)+ ggtitle("My NMDS")+  mytheme3


g1<- gg1+
  geom_point(data = data.scores, aes(shape = Site),size = 3, alpha = 0.8)+
  geom_segment(aes(x = 0, y = 0, xend = NMDS1, yend = NMDS2), 
               data = spp.scrs, size =0.5, alpha = 0.8, colour = "grey30")+
  scale_shape_manual(values = 1:20)+
  ggrepel::geom_text_repel(data = spp.scrs, aes(x=NMDS1, y=NMDS2, label = Species), cex = 3, direction = "both", segment.size = 0.25) #add labels for species, use ggrepel::geom_text_repel so that labels do not overlap

g1
```

```{r add species names in the data}
spp.scrs3 <- as.data.frame(scores(data.spp.fit, display = "vectors")) #save species intrinsic values into dataframe
spp.scrs3 <- cbind(spp.scrs3, Species = rownames(spp.scrs3)) #add species names to dataframe
spp.scrs3 <- cbind(spp.scrs3, pval = data.spp.fit$vectors$pvals) #add pvalues to dataframe so you can select species which are significant

#spp.scrs<- cbind(spp.scrs, abrev = abbreviate(spp.scrs$Species, minlength = 6)) #abbreviate species names
sig.spp.scrs3 <- subset(spp.scrs3, pval<=0.05) #subset data to show species significant at 0.05

sig.spp.scrs3
```
```{r set theme}
##set theme!
mytheme3<-theme(axis.title = element_text(size = 12, colour = "black"), 
                panel.background = element_blank(), panel.border = element_rect(fill = NA, colour = "black"), 
                axis.ticks = element_blank(), axis.text = element_text(size = 12), legend.key = element_blank(), 
                legend.title = element_text(size = 12, colour = "black"), 
                legend.text = element_text(size = 12, colour = "black"))
```

```{r add species names in the data to the plot}
options(ggrepel.max.overlaps = Inf)

gg2 = ggplot(data = data.scores, aes(x = NMDS1, y = NMDS2))+
  scale_color_viridis(discrete = TRUE, option = "D")+
  scale_fill_viridis(discrete = TRUE)+
  labs(colour = "Location")+
  stat_ellipse(aes(fill = Site), geom = "polygon", alpha = .15,
               type="t",level = 0.95,linetype = 3)+
  scale_shape_manual(values = 1:20)+
  mytheme3

g2<-gg2+geom_point(data = data.scores, aes(colour = Site, shape = Site),size = 3, alpha = 0.7)+
  geom_segment(aes(x = 0, y = 0, xend = NMDS1, yend = NMDS2),
               data = sig.spp.scrs3, size =0.5, alpha = 0.5, colour = "grey30")+
  ggrepel::geom_text_repel(data = sig.spp.scrs3, aes(x=NMDS1, y=NMDS2, label = Species), cex = 3, direction = "both", segment.size = 0.5, max.overlaps = 15) #add labels for species, use ggrepel::geom_text_repel so that labels do not overlap
g2

#ggsave("NMDS_sig_spp.png", g2, width=15, height=10)
```

```{r, fig.width=20, fig.height=20}
options(ggrepel.max.overlaps = Inf)

gg2 = ggplot(data = data.scores, aes(x = NMDS1, y = NMDS2))+
  scale_color_viridis(discrete = TRUE, option = "D")+
  scale_fill_viridis(discrete = TRUE)+
  labs(colour = "Location")+
  stat_ellipse(aes(fill = Site), geom = "polygon", alpha = .15,
               type="t",level = 0.95,linetype = 3)+
  scale_shape_manual(values = 1:20)+
  mytheme3

g2<-gg2+geom_point(data = data.scores, aes(colour = Site, shape = Site),size = 3, alpha = 0.7)+
  geom_segment(aes(x = 0, y = 0, xend = NMDS1, yend = NMDS2),
               data = sig.spp.scrs3, size =0.5, alpha = 0.5, colour = "grey30")+
  geom_text(data = sig.spp.scrs3, aes(x=NMDS1, y=NMDS2, label = Species), cex = 3, direction = "both", segment.size = 0.5, max.overlaps = 15) #add labels for species, use ggrepel::geom_text_repel so that labels do not overlap
g2

ggsave("NMDS_with_sig_spp.png", g2, width = 20, height = 20)
```


### Calculating richness against gradient metrics:

```{r}
species_richness <- subset_maxn1 %>%
  filter(!Pin == "13") %>% 
  filter(!Pin == "14") %>% 
  group_by(Pin, On.Adjacent, Block) %>%
  summarise(Richness = n_distinct(Species[MaxN > 0]))

species_richness_explan <- left_join(species_richness, explan[,c("Pin", "pulse_pc1", "Low_Tide_Mean_Silicate_umolL","dist_to_seep_m")])

species_richness_explan %>%
  ggplot(aes(x = Low_Tide_Mean_Silicate_umolL, y = Richness)) +
  geom_text(aes(label = Pin))+
  geom_point() +
  geom_smooth() +
  theme_minimal() +
  facet_wrap(~On.Adjacent)

species_richness_explan %>%
  ggplot(aes(x = pulse_pc1, y = Richness)) +
  geom_text(aes(label = Pin))+
  geom_point() +
  geom_smooth() +
  theme_minimal()+
  facet_wrap(~On.Adjacent)

species_richness_explan %>%
  ggplot(aes(x = dist_to_seep_m, y = Richness)) +
  geom_text(aes(label = Pin))+
  geom_point() +
  geom_smooth() +
  theme_minimal()+
  facet_wrap(~On.Adjacent)
```

### Calculating diversity against gradient metrics:
```{r}
species_diversity <- subset_maxn1 %>%
  filter(!Pin == "13") %>% 
  filter(!Pin == "14") %>% 
  group_by(Pin, On.Adjacent, Block) %>%
  summarise(Diversity = diversity(MaxN, index = "shannon"))

species_diversity_explan <- left_join(species_diversity, explan[,c("Pin", "pulse_pc1", "Low_Tide_Mean_Silicate_umolL","dist_to_seep_m")])

species_diversity_explan %>%
  ggplot(aes(x = Low_Tide_Mean_Silicate_umolL, y = Diversity)) +
  geom_text(aes(label = Pin))+
  geom_point() +
  geom_smooth() +
  theme_minimal()+
  facet_wrap(~On.Adjacent)

species_diversity_explan %>%
  ggplot(aes(x = pulse_pc1, y = Diversity)) +
  geom_text(aes(label = Pin))+
  geom_point() +
  geom_smooth() +
  theme_minimal()+
  facet_wrap(~On.Adjacent)

species_diversity_explan %>%
  ggplot(aes(x = dist_to_seep_m, y = Diversity)) +
  geom_text(aes(label = Pin))+
  geom_point() +
  geom_smooth() +
  theme_minimal() +
  facet_wrap(~On.Adjacent)
```

