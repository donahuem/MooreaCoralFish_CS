---
title: "Code I don't think I need"
author: "Callie Stephenson"
date: "2024-04-08"
output: html_document
---

### ISotope unneded code:

```{r EXPLORATORY 13C host, fig.width=15, fig.height=15}
species <- c("Pocillopora acuta", "Porites rus" )
for (sp in species) {
  # Filter data for the current species and only caged
  species_data <- SI_data %>%
    filter(Species == sp, HS == "host")
  
  # Create plot for the current species
  plot <- species_data %>%
    ggplot(aes(x = value, y = δ13C)) +
    geom_point(aes(shape = Genotype)) +
    geom_smooth(method = "lm") +
    facet_wrap(~ Parameter, scales = "free") +
    ggtitle(paste(sp)) +  #Add species name to the plot title
    theme_bw()
  # Print and save the plot
  print(plot)
  #ggsave(filename = paste("output/wet_raw_growth_data_response_plot_", sp, ".png", sep = ""),
  #       plot = plot, 
  #       width = 15, height = 15)
}
```

```{r EXPLORATORY 13C symb, fig.width=15, fig.height=15}
species <- c("Pocillopora acuta", "Porites rus" )
for (sp in species) {
  # Filter data for the current species and only caged
  species_data <- SI_data %>%
    filter(Species == sp, HS == "symb")
  
  # Create plot for the current species
  plot <- species_data %>%
    ggplot(aes(x = value, y = δ13C)) +
    geom_point() +
    geom_smooth(method = "lm") +
    facet_wrap(~ Parameter, scales = "free") +
    ggtitle(paste(sp)) +  #Add species name to the plot title
    theme_bw()
  # Print and save the plot
  print(plot)
  #ggsave(filename = paste("output/wet_raw_growth_data_response_plot_", sp, ".png", sep = ""),
  #       plot = plot, 
  #       width = 15, height = 15)
}
```


```{r EXPLORATORY 15N symb, fig.width=15, fig.height=15}
species <- c("Pocillopora acuta", "Porites rus" )
for (sp in species) {
  # Filter data for the current species and only caged
  species_data <- SI_data %>%
    filter(Species == sp, HS == "symb")
  
  # Create plot for the current species
  plot <- species_data %>%
    ggplot(aes(x = value, y = δ15N)) +
    geom_point() +
    geom_smooth(method = "lm") +
    facet_wrap(~ Parameter, scales = "free_x") +
    ggtitle(paste(sp)) +  #Add species name to the plot title
    theme_bw()
  # Print and save the plot
  print(plot)
  #ggsave(filename = paste("output/wet_raw_growth_data_response_plot_", sp, ".png", sep = ""),
  #       plot = plot, 
  #       width = 15, height = 15)
}
```



```{r}
create_SI_plot <- function(data, species, host_sym, y_variable, title_suffix) {
  data %>%
    filter(Species == {species}) %>% 
    filter(HS == {host_sym}) %>% 
    ggplot(aes(x = pulse_pc1, y = !!sym(y_variable))) +
    geom_point(aes(shape = Genotype)) +
    geom_smooth(method = "lm") +
    ggtitle(paste(species, host_sym, title_suffix)) +  
    theme_bw() +
    theme(legend.position = "none")
}
```



```{r pc plots, warning=FALSE, message=FALSE, fig.width=15, fig.height=8}
plot1 <- create_SI_plot(SI_data_wide, "Porites rus", "symb", "δ15N", "δ15N")
plot2 <- create_SI_plot(SI_data_wide, "Porites rus", "host", "δ15N", "δ15N")
plot3 <- create_SI_plot(SI_data_wide, "Porites rus", "host", "Δ15N", "minus symbiont, Δ15N")
plot4 <- create_SI_plot(SI_data_wide, "Porites rus", "symb", "δ13C", "δ13C")
plot5 <- create_SI_plot(SI_data_wide, "Porites rus", "host", "δ13C", "δ13C")
plot6 <- create_SI_plot(SI_data_wide, "Porites rus", "host", "Δ13C", "minus symbiont, Δ13C")


legend <- gtable::gtable_filter(ggplot_gtable(ggplot_build(plot1 + theme(legend.position = "bottom"))), "guide-box")

rus_pc_plots <- grid.arrange(plot1, plot2, plot3, plot4, plot5, plot6, legend, ncol = 3)

#ggsave(filename = paste("output/exploratory_isotope_rus_pc_plots.png", sep = ""),
#         plot = rus_pc_plots, 
#         width = 15, height = 8)
```


```{r acuta pc plots, warning=FALSE, message=FALSE, fig.width=12, fig.height=6}
plot1 <- create_SI_plot(SI_data_wide, "Pocillopora acuta", "symb", "δ15N", "δ15N")
plot2 <- create_SI_plot(SI_data_wide, "Pocillopora acuta", "host", "δ15N", "δ15N")
plot3 <- create_SI_plot(SI_data_wide, "Pocillopora acuta", "host", "Δ15N", "minus symbiont, Δ15N")
plot4 <- create_SI_plot(SI_data_wide, "Pocillopora acuta", "symb", "δ13C", "δ13C")
plot5 <- create_SI_plot(SI_data_wide, "Pocillopora acuta", "host", "δ13C", "δ13C")
plot6 <- create_SI_plot(SI_data_wide, "Pocillopora acuta", "host", "Δ13C", "minus symbiont, Δ13C")


legend <- gtable::gtable_filter(ggplot_gtable(ggplot_build(plot1 + theme(legend.position = "bottom"))), "guide-box")

acuta_pc_plots <- grid.arrange(plot1, plot2, plot3, plot4, plot5, plot6, ncol = 3)

#ggsave(filename = paste("output/exploratory_isotope_acuta_pc_plots.png", sep = ""),
#         plot = acuta_pc_plots, 
#         width = 15, height = 8)

```


## Some univariate models with isotopes:

```{r PAC_Δ15N_model_results}
model_results <- data.frame(Parameter = character(),
                            AICc = numeric(),
                            p.value1 = numeric(),
                            p.value2 = numeric(),
                            Estimate1 = numeric(),
                            Estimate2 = numeric(),
                            type = character(),
                            Marginal_R2 = numeric(),
                            Conditional_R2 = numeric(),
                            stringsAsFactors = FALSE)

plotlist <- list()

parameters <- unique(SI_data$Parameter)

for (parameter in parameters) {
  # Create a subset of data for the current parameter
  subset_data <- subset(SI_data, Parameter == parameter)
  subset_data <- subset(subset_data, Species == "Pocillopora acuta")
  subset_data <- subset(subset_data, HS == "host")
  
  # Fit the mixed-effects model
  linear_model <- lmer(Δ15N ~ value + (1|Genotype), data = subset_data)
  polynomial_model <- lmer(Δ15N ~ poly(value,2) + (1|Genotype), data = subset_data)
  
  # Get AICc
  linear_AICc <- AICc(linear_model)
  polynomial_AICc <- AICc(polynomial_model)
  
  # Get p-value from summary
  linear_model_summary <- summary(linear_model)
  anova_linear <- car::Anova(linear_model)
  linear_p.value <- anova_linear$`Pr(>Chisq)`
  linear_p.value <- linear_model_summary$coefficients["value", "Pr(>|t|)"]
  polynomial_model_summary <- summary(polynomial_model)
  anova_poly <- car::Anova(polynomial_model)
  polynomial_p.value <- anova_poly$`Pr(>Chisq)`
  
  # Get Estimate
  linear_Estimate <- linear_model_summary$coefficients["value", "Estimate"]
  polynomial_Estimate1 <- polynomial_model_summary$coefficients["poly(value, 2)1", "Estimate"]
  polynomial_Estimate2 <- polynomial_model_summary$coefficients["poly(value, 2)2", "Estimate"]
  
  #Get R2
    rsq <- as.numeric(r.squaredGLMM(linear_model))
    linear_marginal_R2 <- rsq[1]
    linear_conditional_R2 <- rsq[2]
  
  if (linear_p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = linear_AICc,
                                                     p.value1 = linear_p.value,
                                                     p.value2 = "NA",
                                                     Estimate1 = linear_Estimate,
                                                     Estimate2 = "NA",
                                                     Marginal_R2 = linear_marginal_R2,
                                                     Conditional_R2 = linear_conditional_R2,
                                                     type = "linear"))
    
    # Add the ggplot object to the plotlist
    plotlist[[paste0(parameter, "_linear")]] <- ggplot(data = subset_data, aes(x = value, y = Δ15N)) +
      geom_point() +
      geom_smooth(method = "lm") +
      labs(x = parameter) +
      theme_bw()
  }
  
    if (polynomial_p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = polynomial_AICc,
                                                     p.value1 = polynomial_p.value,
                                                     p.value2 = "NA",
                                                     Estimate1 = polynomial_Estimate1,
                                                     Estimate2 = polynomial_Estimate2,
                                                     Marginal_R2 = "NA",
                                                     Conditional_R2 = "NA",
                                                     type = "polynomial"))
    
    # Add the ggplot object to the plotlist
    plotlist[[paste0(parameter, "_polynomial")]] <- ggplot(data = subset_data, aes(x = value, y = Δ15N)) +
      geom_point() +
      geom_smooth(method = "lm", formula = y ~ poly(x, 2)) +
      labs(x = parameter) +
      theme_bw()
    }
}

grid.arrange(grobs = plotlist, ncol = 2)

model_results$Species <- "Pocillopora acuta"

PAC_Δ15N_model_results <- model_results
PAC_Δ15N_model_results[order(PAC_Δ15N_model_results$AICc), c(10, 1, 3, 2, 5:9)]
```

```{r}
SI_data %>% 
  filter(Species == "Pocillopora acuta") %>% 
  filter(Parameter == "Maximum_Phosphate_umolL") %>% 
  ggplot(aes(x = value, y = Δ15N)) +
      geom_point() +
      geom_smooth(method = "lm") +
      labs(x = "Maximum_Phosphate_umolL") +
      theme_bw()
```


```{r PAC_Δ13C_model_results}
model_results <- data.frame(Parameter = character(),
                            AICc = numeric(),
                            p.value1 = numeric(),
                            p.value2 = numeric(),
                            Estimate1 = numeric(),
                            Estimate2 = numeric(),
                            type = character(),
                            Marginal_R2 = numeric(),
                            Conditional_R2 = numeric(),
                            stringsAsFactors = FALSE)

plotlist <- list()

parameters <- unique(SI_data$Parameter)

for (parameter in parameters) {
  # Create a subset of data for the current parameter
  subset_data <- subset(SI_data, Parameter == parameter)
  subset_data <- subset(subset_data, Species == "Pocillopora acuta")
  subset_data <- subset(subset_data, HS == "host")
  
  # Fit the mixed-effects model
  linear_model <- lmer(Δ13C ~ value + (1|Genotype), data = subset_data)
  polynomial_model <- lmer(Δ13C ~ poly(value,2) + (1|Genotype), data = subset_data)
  
  # Get AICc
  linear_AICc <- AICc(linear_model)
  polynomial_AICc <- AICc(polynomial_model)
  
  # Get p-value from summary
  linear_model_summary <- summary(linear_model)
  anova_linear <- car::Anova(linear_model)
  linear_p.value <- anova_linear$`Pr(>Chisq)`
  linear_p.value <- linear_model_summary$coefficients["value", "Pr(>|t|)"]
  polynomial_model_summary <- summary(polynomial_model)
  anova_poly <- car::Anova(polynomial_model)
  polynomial_p.value <- anova_poly$`Pr(>Chisq)`
  
  # Get Estimate
  linear_Estimate <- linear_model_summary$coefficients["value", "Estimate"]
  polynomial_Estimate1 <- polynomial_model_summary$coefficients["poly(value, 2)1", "Estimate"]
  polynomial_Estimate2 <- polynomial_model_summary$coefficients["poly(value, 2)2", "Estimate"]
  
  #Get R2
    rsq <- as.numeric(r.squaredGLMM(linear_model))
    linear_marginal_R2 <- rsq[1]
    linear_conditional_R2 <- rsq[2]
  
  if (linear_p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = linear_AICc,
                                                     p.value1 = linear_p.value,
                                                     p.value2 = "NA",
                                                     Estimate1 = linear_Estimate,
                                                     Estimate2 = "NA",
                                                     Marginal_R2 = linear_marginal_R2,
                                                     Conditional_R2 = linear_conditional_R2,
                                                     type = "linear"))
    
    # Add the ggplot object to the plotlist
    plotlist[[paste0(parameter, "_linear")]] <- ggplot(data = subset_data, aes(x = value, y = Δ13C)) +
      geom_point() +
      geom_smooth(method = "lm") +
      labs(x = parameter) +
      theme_bw()
  }
  
    if (polynomial_p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = polynomial_AICc,
                                                     p.value1 = polynomial_p.value,
                                                     p.value2 = "NA",
                                                     Estimate1 = polynomial_Estimate1,
                                                     Estimate2 = polynomial_Estimate2,
                                                     Marginal_R2 = "NA",
                                                     Conditional_R2 = "NA",
                                                     type = "polynomial"))
    
    # Add the ggplot object to the plotlist
    plotlist[[paste0(parameter, "_polynomial")]] <- ggplot(data = subset_data, aes(x = value, y = Δ13C)) +
      geom_point() +
      geom_smooth(method = "lm", formula = y ~ poly(x, 2)) +
      labs(x = parameter) +
      theme_bw()
    }
}

grid.arrange(grobs = plotlist, ncol = 2)

model_results$Species <- "Pocillopora acuta"

PAC_Δ13C_model_results <- model_results
PAC_Δ13C_model_results[order(PAC_Δ13C_model_results$AICc), c(10, 1, 9, 3, 2, 5:8)]
```

```{r}
plot1 <- SI_data %>% 
  filter(Species == "Pocillopora acuta") %>% 
  filter(Parameter == "Maximum_Phosphate_umolL") %>% 
  ggplot(aes(x = value, y = Δ15N)) +
      geom_point() +
      geom_smooth(method = "lm") +
      labs(x = "Maximum_Phosphate_umolL", title = "Pocillopora acuta") +
      theme_bw()

plot2 <- SI_data %>% 
  filter(Species == "Pocillopora acuta") %>% 
  filter(Parameter == "Maximum_NN_umolL") %>% 
  ggplot(aes(x = value, y = Δ13C)) +
      geom_point() +
      geom_smooth(method = "lm", formula = "y~poly(x,2)")+
      labs(x = "Maximum_NN_umolL", title = "Pocillopora acuta") +
      theme_bw()

grid.arrange(plot1, plot2, ncol = 2)
```



```{r PRU_Δ15N_model_results}
model_results <- data.frame(Parameter = character(),
                            AICc = numeric(),
                            p.value1 = numeric(),
                            p.value2 = numeric(),
                            Estimate1 = numeric(),
                            Estimate2 = numeric(),
                            type = character(),
                            Marginal_R2 = numeric(),
                            Conditional_R2 = numeric(),
                            stringsAsFactors = FALSE)

plotlist <- list()

parameters <- unique(SI_data$Parameter)

for (parameter in parameters) {
  # Create a subset of data for the current parameter
  subset_data <- subset(SI_data, Parameter == parameter)
  subset_data <- subset(subset_data, Species == "Porites rus")
  subset_data <- subset(subset_data, HS == "host")
  
  # Fit the mixed-effects model
  linear_model <- lmer(Δ15N ~ value + (1|Genotype), data = subset_data)
  polynomial_model <- lmer(Δ15N ~ poly(value,2) + (1|Genotype), data = subset_data)
  
  # Get AICc
  linear_AICc <- AICc(linear_model)
  polynomial_AICc <- AICc(polynomial_model)
  
  # Get p-value from summary
  linear_model_summary <- summary(linear_model)
  anova_linear <- car::Anova(linear_model)
  linear_p.value <- anova_linear$`Pr(>Chisq)`
  linear_p.value <- linear_model_summary$coefficients["value", "Pr(>|t|)"]
  polynomial_model_summary <- summary(polynomial_model)
  anova_poly <- car::Anova(polynomial_model)
  polynomial_p.value <- anova_poly$`Pr(>Chisq)`
  
  # Get Estimate
  linear_Estimate <- linear_model_summary$coefficients["value", "Estimate"]
  polynomial_Estimate1 <- polynomial_model_summary$coefficients["poly(value, 2)1", "Estimate"]
  polynomial_Estimate2 <- polynomial_model_summary$coefficients["poly(value, 2)2", "Estimate"]
  
  #Get R2
    rsq <- as.numeric(r.squaredGLMM(linear_model))
    linear_marginal_R2 <- rsq[1]
    linear_conditional_R2 <- rsq[2]
  
  if (linear_p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = linear_AICc,
                                                     p.value1 = linear_p.value,
                                                     p.value2 = "NA",
                                                     Estimate1 = linear_Estimate,
                                                     Estimate2 = "NA",
                                                     Marginal_R2 = linear_marginal_R2,
                                                     Conditional_R2 = linear_conditional_R2,
                                                     type = "linear"))
    
    # Add the ggplot object to the plotlist
    plotlist[[paste0(parameter, "_linear")]] <- ggplot(data = subset_data, aes(x = value, y = Δ15N)) +
      geom_point() +
      geom_smooth(method = "lm") +
      labs(x = parameter) +
      theme_bw()
  }
  
    if (polynomial_p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = polynomial_AICc,
                                                     p.value1 = polynomial_p.value,
                                                     p.value2 = "NA",
                                                     Estimate1 = polynomial_Estimate1,
                                                     Estimate2 = polynomial_Estimate2,
                                                     Marginal_R2 = "NA",
                                                     Conditional_R2 = "NA",
                                                     type = "polynomial"))
    
    # Add the ggplot object to the plotlist
    plotlist[[paste0(parameter, "_polynomial")]] <- ggplot(data = subset_data, aes(x = value, y = Δ15N)) +
      geom_point() +
      geom_smooth(method = "lm", formula = y ~ poly(x, 2)) +
      labs(x = parameter) +
      theme_bw()
    }
}

grid.arrange(grobs = plotlist, ncol = 2)

model_results$Species <- "Porites rus"

PRU_Δ15N_model_results <- model_results
PRU_Δ15N_model_results[order(PRU_Δ15N_model_results$AICc), c(10, 1, 3, 2, 5:9)]
```


```{r PRU_Δ13C_model_results}
model_results <- data.frame(Parameter = character(),
                            AICc = numeric(),
                            p.value1 = numeric(),
                            p.value2 = numeric(),
                            Estimate1 = numeric(),
                            Estimate2 = numeric(),
                            type = character(),
                            Marginal_R2 = numeric(),
                            Conditional_R2 = numeric(),
                            stringsAsFactors = FALSE)

plotlist <- list()

parameters <- unique(SI_data$Parameter)

for (parameter in parameters) {
  # Create a subset of data for the current parameter
  subset_data <- subset(SI_data, Parameter == parameter)
  subset_data <- subset(subset_data, Species == "Porites rus")
  subset_data <- subset(subset_data, HS == "host")
  
  # Fit the mixed-effects model
  linear_model <- lmer(Δ13C ~ value + (1|Genotype), data = subset_data)
  polynomial_model <- lmer(Δ13C ~ poly(value,2) + (1|Genotype), data = subset_data)
  
  # Get AICc
  linear_AICc <- AICc(linear_model)
  polynomial_AICc <- AICc(polynomial_model)
  
  # Get p-value from summary
  linear_model_summary <- summary(linear_model)
  anova_linear <- car::Anova(linear_model)
  linear_p.value <- anova_linear$`Pr(>Chisq)`
  linear_p.value <- linear_model_summary$coefficients["value", "Pr(>|t|)"]
  polynomial_model_summary <- summary(polynomial_model)
  anova_poly <- car::Anova(polynomial_model)
  polynomial_p.value <- anova_poly$`Pr(>Chisq)`
  
  # Get Estimate
  linear_Estimate <- linear_model_summary$coefficients["value", "Estimate"]
  polynomial_Estimate1 <- polynomial_model_summary$coefficients["poly(value, 2)1", "Estimate"]
  polynomial_Estimate2 <- polynomial_model_summary$coefficients["poly(value, 2)2", "Estimate"]
  
  #Get R2
    rsq <- as.numeric(r.squaredGLMM(linear_model))
    linear_marginal_R2 <- rsq[1]
    linear_conditional_R2 <- rsq[2]
  
  if (linear_p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = linear_AICc,
                                                     p.value1 = linear_p.value,
                                                     p.value2 = "NA",
                                                     Estimate1 = linear_Estimate,
                                                     Estimate2 = "NA",
                                                     Marginal_R2 = linear_marginal_R2,
                                                     Conditional_R2 = linear_conditional_R2,
                                                     type = "linear"))
    
    # Add the ggplot object to the plotlist
    plotlist[[paste0(parameter, "_linear")]] <- ggplot(data = subset_data, aes(x = value, y = Δ13C)) +
      geom_point() +
      geom_smooth(method = "lm") +
      labs(x = parameter) +
      theme_bw()
  }
  
    if (polynomial_p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = polynomial_AICc,
                                                     p.value1 = polynomial_p.value,
                                                     p.value2 = "NA",
                                                     Estimate1 = polynomial_Estimate1,
                                                     Estimate2 = polynomial_Estimate2,
                                                     Marginal_R2 = "NA",
                                                     Conditional_R2 = "NA",
                                                     type = "polynomial"))
    
    # Add the ggplot object to the plotlist
    plotlist[[paste0(parameter, "_polynomial")]] <- ggplot(data = subset_data, aes(x = value, y = Δ13C)) +
      geom_point() +
      geom_smooth(method = "lm", formula = y ~ poly(x, 2)) +
      labs(x = parameter) +
      geom_text(aes(label = Pin_Number)) +
      theme_bw()
    }
}

grid.arrange(grobs = plotlist, ncol = 2)

model_results$Species <- "Porites rus"

PRU_Δ13C_model_results <- model_results
PRU_Δ13C_model_results[order(PRU_Δ13C_model_results$AICc), c(10, 1, 3, 2, 5:9)]
```

```{r PRU_Δ13C_model_results}
model_results <- data.frame(Parameter = character(),
                            AICc = numeric(),
                            p.value1 = numeric(),
                            p.value2 = numeric(),
                            Estimate1 = numeric(),
                            Estimate2 = numeric(),
                            type = character(),
                            Marginal_R2 = numeric(),
                            Conditional_R2 = numeric(),
                            stringsAsFactors = FALSE)

plotlist <- list()

parameters <- unique(SI_data$Parameter)

for (parameter in parameters) {
  # Create a subset of data for the current parameter
  subset_data <- subset(SI_data, Parameter == parameter)
  subset_data <- subset(subset_data, Species == "Porites rus")
  subset_data <- subset(subset_data, HS == "host")
  
  # Fit the mixed-effects model
  linear_model <- lmer(Δ13C_T1T0 ~ value + (1|Genotype), data = subset_data)
  polynomial_model <- lmer(Δ13C_T1T0 ~ poly(value,2) + (1|Genotype), data = subset_data)
  
  # Get AICc
  linear_AICc <- AICc(linear_model)
  polynomial_AICc <- AICc(polynomial_model)
  
  # Get p-value from summary
  linear_model_summary <- summary(linear_model)
  anova_linear <- car::Anova(linear_model)
  linear_p.value <- anova_linear$`Pr(>Chisq)`
  linear_p.value <- linear_model_summary$coefficients["value", "Pr(>|t|)"]
  polynomial_model_summary <- summary(polynomial_model)
  anova_poly <- car::Anova(polynomial_model)
  polynomial_p.value <- anova_poly$`Pr(>Chisq)`
  
  # Get Estimate
  linear_Estimate <- linear_model_summary$coefficients["value", "Estimate"]
  polynomial_Estimate1 <- polynomial_model_summary$coefficients["poly(value, 2)1", "Estimate"]
  polynomial_Estimate2 <- polynomial_model_summary$coefficients["poly(value, 2)2", "Estimate"]
  
  #Get R2
    rsq <- as.numeric(r.squaredGLMM(linear_model))
    linear_marginal_R2 <- rsq[1]
    linear_conditional_R2 <- rsq[2]
  
  if (linear_p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = linear_AICc,
                                                     p.value1 = linear_p.value,
                                                     p.value2 = "NA",
                                                     Estimate1 = linear_Estimate,
                                                     Estimate2 = "NA",
                                                     Marginal_R2 = linear_marginal_R2,
                                                     Conditional_R2 = linear_conditional_R2,
                                                     type = "linear"))
    
    # Add the ggplot object to the plotlist
    plotlist[[paste0(parameter, "_linear")]] <- ggplot(data = subset_data, aes(x = value, y = Δ13C_T1T0)) +
      geom_point() +
      geom_smooth(method = "lm") +
      labs(x = parameter) +
      theme_bw()
  }
  
    if (polynomial_p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = polynomial_AICc,
                                                     p.value1 = polynomial_p.value,
                                                     p.value2 = "NA",
                                                     Estimate1 = polynomial_Estimate1,
                                                     Estimate2 = polynomial_Estimate2,
                                                     Marginal_R2 = "NA",
                                                     Conditional_R2 = "NA",
                                                     type = "polynomial"))
    
    # Add the ggplot object to the plotlist
    plotlist[[paste0(parameter, "_polynomial")]] <- ggplot(data = subset_data, aes(x = value, y = Δ13C_T1T0)) +
      geom_point() +
      geom_smooth(method = "lm", formula = y ~ poly(x, 2)) +
      labs(x = parameter) +
      geom_text(aes(label = Pin_Number)) +
      theme_bw()
    }
}

grid.arrange(grobs = plotlist, ncol = 2)

model_results$Species <- "Porites rus"

PRU_Δ13CT1T0_model_results <- model_results
PRU_Δ13CT1T0_model_results[order(PRU_Δ13CT1T0_model_results$AICc), c(10, 1, 3, 2, 5:9)]
```



```{r}
plot1 <- SI_data %>% 
  filter(Species == "Porites rus") %>% 
  filter(Parameter == "Low_Tide_Mean_NN_umolL") %>% 
  ggplot(aes(x = value, y = Δ15N)) +
      geom_point() +
      geom_smooth(method = "lm", formula = "y~poly(x,2)") +
      labs(x = "Low_Tide_Mean_NN_umolL", title = "Porites rus") +
      theme_bw()

plot2 <- SI_data %>% 
  filter(Species == "Porites rus") %>% 
  filter(Parameter == "Low_Tide_Mean_Phosphate_umolL") %>% 
  ggplot(aes(x = value, y = Δ13C)) +
      geom_point() +
      geom_smooth(method = "lm")+
      labs(x = "Low_Tide_Mean_Phosphate_umolL", title = "Porites rus") +
      theme_bw()

grid.arrange(plot1, plot2, ncol = 2)
```


### Versus growth

```{r}
SI_data_wide <- left_join(SI_data_wide, BW[,c("Placement_Code", "Percent_Change")])
SI_data_wide$Percent_Change <-100*SI_data_wide$Percent_Change
```

```{r, warning=FALSE, message=FALSE}
plot1 <- create_SI_plot(SI_data_wide, "Pocillopora acuta", "symb", "Percent_Change","δ15N", "δ15N")
plot2 <- create_SI_plot(SI_data_wide, "Pocillopora acuta", "host", "Percent_Change", "δ15N", "δ15N")
plot3 <- create_SI_plot(SI_data_wide, "Pocillopora acuta", "host", "Percent_Change", "Δ15N", "minus symbiont, Δ15N")
plot4 <- create_SI_plot(SI_data_wide, "Pocillopora acuta", "symb", "Percent_Change", "δ13C", "δ13C")
plot5 <- create_SI_plot(SI_data_wide, "Pocillopora acuta", "host", "Percent_Change", "δ13C", "δ13C")
plot6 <- create_SI_plot(SI_data_wide, "Pocillopora acuta", "host", "Percent_Change", "Δ13C", "minus symbiont, Δ13C")


legend <- gtable::gtable_filter(ggplot_gtable(ggplot_build(plot1 + theme(legend.position = "top"))), "guide-box")

acuta_SIvsgrowth_plots <- grid.arrange(plot1, plot2, plot3, plot4, plot5, plot6, legend, ncol = 3)
```

```{r}
plot1 <- create_SI_plot(SI_data_wide, "Porites rus", "symb", "Percent_Change","δ15N", "δ15N")
plot2 <- create_SI_plot(SI_data_wide, "Porites rus", "host", "Percent_Change", "δ15N", "δ15N")
plot3 <- create_SI_plot(SI_data_wide, "Porites rus", "host", "Percent_Change", "Δ15N", "minus symbiont, Δ15N")
plot4 <- create_SI_plot(SI_data_wide, "Porites rus", "symb", "Percent_Change", "δ13C", "δ13C")
plot5 <- create_SI_plot(SI_data_wide, "Porites rus", "host", "Percent_Change", "δ13C", "δ13C")
plot6 <- create_SI_plot(SI_data_wide, "Porites rus", "host", "Percent_Change", "Δ13C", "minus symbiont, Δ13C")


legend <- gtable::gtable_filter(ggplot_gtable(ggplot_build(plot1 + theme(legend.position = "top"))), "guide-box")

rus_SIvsgrowth_plots <- grid.arrange(plot1, plot2, plot3, plot4, plot5, plot6, legend, ncol = 3)
```



### Exploratory plots:
If you could plot their 15N and 13C host and symbiont values on 2 different plots that would be a good place to start. One plot for 15N and one for 13C and then facet by whatever your categories are (location on gradient?). Then we can look at how overlapped their isotopes are:

```{r}
CV <- names(explanatory_all_wide)[grepl("CV_", names(explanatory_all_wide), names(explanatory_all_wide))]
mean_low <- names(explanatory_all_wide)[grepl("Low_Tide_Mean_", names(explanatory_all_wide), names(explanatory_all_wide))]

filter_values <- c("Maximum_NN_umolL",
                   "Maximum_Phosphate_umolL",
                   "Maximum_NNP_umolL",
                   "Low_Tide_Mean_Phosphate_umolL",
                   "Low_Tide_Mean_NN_umolL",
                   "Low_Tide_Mean_pH",
                   "Low_Tide_Mean_TA",
                   "Low_Tide_Mean_Salinity")

#SI_data1 <- left_join(SI, explanatory_all,by = join_by(CowTagID))
SI_data_wide <- left_join(SI, explanatory_all_wide,by = join_by(CowTagID))

# Filter the dataframe SI_data
#SI_data <- SI_data1[SI_data1$Parameter %in% filter_values, ] 
```

```{r}
SI_data_wide %>% 
  filter(Species == "Pocillopora acuta") %>% 
  ggplot(aes(x = C_N, y = C_N_ratio)) +
  geom_point() + 
  labs(x="Turbinaria C:N", y= "Coral C:N Ratio", main = "Pocillopora acuta") +
  facet_wrap(~HS)
```


```{r}
SI_data_wide %>% 
  filter(Species == 'Porites rus') %>% 
  ggplot(aes(x = C_N, y = C_N_ratio)) +
  geom_point() + 
  geom_text(aes(label=Pin_Number))+
  labs(x="Turbinaria C:N", y= "Coral C:N Ratio", main = "Porites rus") +
  facet_wrap(~HS)
```
### Collinearity
need to make a dataframe that's long that has all the nutrient metrics and independent variables
Here's the thing: we KNOW the nutrients are collinear
For example, here's a pairs plot for the maximum of all the nutrient values:

```{r pairs plot collinearity}
nut_wide_no_seep<- nut_wide[nut_wide$CowTagID != 'VSEEP', ]
maximum_columns <- names(nut_wide)[grepl("Maximum_", names(nut_wide)) & !grepl("Salinity|Temperature|pH|Ammonia_umol", names(nut_wide))]

#ggpairs( all_nut_no_seep[, c(CV_columns,variance_columns)], progress = FALSE)
#correlation_matrix <- cor(CV_columns, variance_columns)

all_nut_no_seep<- all_nut[all_nut$CowTagID != 'VSEEP', ]
plot1 <- all_nut_no_seep %>% 
  ggplot(aes(x=CV_Silicate_umolL, y = sd_Silicate_umolL))+
  geom_point()
  
plot2 <- all_nut_no_seep %>% 
  ggplot(aes(x=CV_Silicate_umolL, y = Mean_Silicate_umolL))+
  geom_point()

grid.arrange(plot1, plot2, ncol =2)
```

```{r multivariate dredge}
PRU_symb_big_model <- lmer(log10(FSC.Events_per_cm_2) ~ 
                       Maximum_Phosphate_umolL_scaled + 
                       Low_Tide_Mean_Phosphate_umolL_scaled +
                       (1 | Genotype)+ (1|Cage_Uncaged), 
                                 data = PRU_model_data, 
                                 na.action = na.pass)

PRU_symb_big_model_dredge <- dredge(PRU_symb_big_model, trace = 2)
#model.sel(PAC_cv_low_growth_model_dredge)
PRU_symb.avg = model.avg(PRU_symb_big_model_dredge, delta < 2)
summary(PRU_symb.avg)
PRU_symb.avg$sw
```


```{r STOP HERE !!!}
bw_caged_PAC <-lmer(Percent_Change ~ shore_dist_m + (1 | Genotype), data = all_data %>%                     filter(Species == "Pocillopora acuta" 
                           & Cage_Uncaged == "C"))
anova(bw_caged_PAC)

data <- all_data %>% 
                     filter(Species == "Pocillopora acuta" 
                           & Cage_Uncaged == "C" 
                           & Parameter == "pc1") 
#this removes V13 because it doesn't have shore dist
ggplot(data, aes(x = X._loss, y = Percent_Change))+
  geom_point(aes(color = value))+
  scale_color_fish(option = "Coryphaena_hippurus")+
  geom_smooth(method = "lm", formula = 'y~poly(x,2)')+
  labs(title="Growth of Pocillopora acuta colonies against distance from shore")
```
So this is suggesting that distance from shore is significant, let's see if SGD is too:
```{r}
bw_caged_PAC <-lmer(Percent_Change ~ shore_dist_m + value + (1 | Genotype), data = all_data %>% 
                     filter(Species == "Pocillopora acuta" 
                           & Cage_Uncaged == "C" 
                           & Parameter == "pc1") ) 
anova(bw_caged_PAC)
```


Now that we've done our data exploration, let's make the data frame needed to build some models!

```{r starting models with megan}
#For models of only caged corals, we are running with Genotype as covariate instead of random effect
#Cannot run as random effect without singularity (as there is only one occurance of genotype for every occurence of the nutrient parameter)
#for example, see how this is singular:

bw_m1_caged_PAC <-lmer(Percent_Change ~ shore_dist_m + (1 | Genotype), data = all_data %>% 
                    filter(Parameters == "Salinity" & Species == "Pocillopora acuta" & Cage_Uncaged == "C")) 
anova(bw_m1_caged_PAC)
summary(bw_m1_caged_PAC)

##plots with megan
ggplot(all_PAC_data) +
  geom_point(data = subset(all_PAC_data, Cage_Uncaged == "C"),
             aes(x = Genotype, y = Percent_Change, color = shore_dist_m)) +
  scale_color_fish(option = "Coryphaena_hippurus")
#this shore distance looks like it could be a trend

#variance components analysis within genotype and between genotype variance
#looking at all the variance in the data, looking at the grand mean vs. the mean for the random effects
#how much is between vs within genotype variance
bw_m1_caged_PRU <-lmer(Percent_Change ~ shore_dist_m + (1 | Genotype), data = all_data %>% 
                    filter(Parameters == "Salinity" & Species == "Porites rus" & Cage_Uncaged == "C")) 
anova(bw_m1_caged_PRU)
summary(bw_m1_caged_PRU)

ggplot(all_PRU_data) +
  geom_point(data = subset(all_PRU_data, Cage_Uncaged == "C"),
             aes(x = Genotype, y = Percent_Change, color = shore_dist_m))+
  scale_color_fish(option = "Coryphaena_hippurus")
```
```{r WHY YOU GET SINGULARITY IN ACUTA, eval = FALSE, echo=FALSE}
dataPAC = all_data %>%
  filter(Parameters == "Salinity" & Species == "PAC" & Cage_Uncaged == "C")

dataPRU = all_data %>% 
  filter(Parameters == "Salinity" & Species == "PRU" & Cage_Uncaged == "C")

ggplot(dataPAC) +
  geom_point(aes(x = Genotype, y = Percent_Change, color = shore_dist_m))+
  scale_color_fish(option = "Coryphaena_hippurus")
#NEARLY NO VARIATION ATTRIBUTABLE TO GENOTYPE

ggplot(dataPRU) +
  geom_point(aes(x = Genotype, y = Percent_Change, color = shore_dist_m))+
  scale_color_fish(option = "Coryphaena_hippurus")

#Q from MJD for KE:
#if you get an estimate of 0 for your random effect what do you do
#do you keep bc the structure is important
#or do you drop because the model becomes simpler

#To move forward: drop the random effect for PAC models.
```

```{r starting models, eval = FALSE, echo=FALSE}
###
#Cannot run as random effect without singularity (as there is only one occurance of genotype for every occurence of the nutrient parameter)
bw_m1_caged_PAC <-lm(Percent_Change ~ CVSeasonal + shore_dist_m,
                  data = all_data %>% 
                    filter(Parameters == "Salinity" & Species == "PAC" & Cage_Uncaged == "C"))
anova(bw_m1_caged_PAC)

bw_m1_caged_PRU <-lmer(Percent_Change ~ CVSeasonal + shore_dist_m + (1 | Genotype),
                  data = all_data %>% 
                    filter(Parameters == "Salinity" & Species == "PRU" & Cage_Uncaged == "C"))
anova(bw_m1_caged_PRU)

#For models of all corals, we are running with Genotype as a random effect
bw_m1_PAC <- lmer(Percent_Change ~ CVSeasonal + (1 | Genotype) + Cage_Uncaged, 
                  data = all_data %>% 
                    filter(Parameters == "Salinity" & Species == "PAC"))
anova(bw_m1_PAC)

bw_m1_PRU <- lmer(Percent_Change ~ CVSeasonal + (1 | Genotype) + Cage_Uncaged, 
                  data = all_data %>% 
                    filter(Parameters == "Salinity" & Species == "PRU"))
anova(bw_m1_PRU)
summary(bw_m1_PRU)
```

Same models as before, but now with silicate instead, because the range in SiO32- was an order of magnitude higher on the reef than salinity allowing for a higher signal to noise ratio. I also used maximum silicate, as it is more indicative of the maximum amount of groundwater experienced

```{r starting models silicate, eval = FALSE, echo=FALSE}
#For models of only caged corals, we are running with Genotype as covariate instead of random effect
#Cannot run as random effect without singularity (as there is only one occurance of genotype for every occurence of the nutrient parameter)
#for example, see how this is singular:
bw_m1_caged_PAC <-lmer(Percent_Change ~ Maximum + (1 | Genotype), data = all_data %>% 
                    filter(Parameters == "Silicate_umolL" & Species == "PAC" & Cage_Uncaged == "C")) 
anova(bw_m1_caged_PAC)
                    
###
#Cannot run as random effect without singularity (as there is only one occurrence of genotype for every occurrence of the nutrient parameter)
bw_m1_caged_PAC <-lm(Percent_Change ~ Maximum + Genotype,
                  data = all_data %>% 
                    filter(Parameters == "Silicate_umolL" & 
                             Species == "PAC" & 
                             Cage_Uncaged == "C"))
anova(bw_m1_caged_PAC)

bw_m1_caged_PRU <-lm(Percent_Change ~ Maximum + Genotype,
                  data = all_data %>% 
                    filter(Parameters == "Silicate_umolL" & 
                             Species == "PRU" & 
                             Cage_Uncaged == "C"))
anova(bw_m1_caged_PRU)

#For models of all corals, we are running with Genotype as a random effect
bw_m1_PAC <- lmer(Percent_Change ~ Maximum + (1 | Genotype) + Cage_Uncaged, 
                  data = all_data %>% 
                    filter(Parameters == "Silicate_umolL" & 
                             Species == "PAC"))
anova(bw_m1_PAC)
summary(bw_m1_PAC)

bw_m1_PRU <- lmer(Percent_Change ~ Maximum + (1 | Genotype) + Cage_Uncaged, 
                  data = all_data %>% 
                    filter(Parameters == "Silicate_umolL" & 
                             Species == "PRU"))
anova(bw_m1_PRU)
summary(bw_m1_PRU)
```
This also only sees a correlation between all (not just caged) change in buoyant weight for PRU. PAC is not significant.

Now let's see those same models with symbiont counts
```{r starting models symb, eval = FALSE, echo=FALSE}
#again running with Genotype as covariate when only 
symb_m1_caged_PAC <-lm(Normalized_Symbiont_Counts ~ CVSeasonal + Genotype,
                  data = all_data %>% 
                    filter(Parameters == "Salinity" & Species == "PAC" & Cage_Uncaged == "C"))
anova(symb_m1_caged_PAC)

symb_m1_caged_PRU <-lm(Normalized_Symbiont_Counts ~ CVSeasonal + Genotype,
                  data = all_data %>% 
                    filter(Parameters == "Salinity" & Species == "PRU" & Cage_Uncaged == "C"))
anova(symb_m1_caged_PRU)

#but with all the corals we can use Genotype as random effect
symb_m1_PAC <- lmer(Normalized_Symbiont_Counts ~ CVSeasonal + (1 | Genotype) + Cage_Uncaged, 
                  data = all_data %>% 
                    filter(Parameters == "Salinity" & Species == "PAC"))
anova(symb_m1_PAC)

symb_m1_PRU <- lmer(Normalized_Symbiont_Counts ~ CVSeasonal + (1 | Genotype) + Cage_Uncaged, 
                  data = all_data %>% 
                    filter(Parameters == "Salinity" & Species == "PRU"))
anova(symb_m1_PRU)
summary(symb_m1_PRU)
```


### EXTRA


#### Dredged data models (aka is multiresponse better than univariate models)

```{r collinearity in cv dredge parameters}
ggpairs(PAC_model_data, columns = c("CV_Salinity_scaled",  
                       "CV_Temperature_scaled",  
                       "CV_TA_scaled",  
                       "CV_pH_scaled"), progress = FALSE)
```

```{r collinearity in pulse dredge parameters}
ggpairs(PAC_model_data, columns = c("Low_Tide_Mean_Phosphate_umolL",  
                       "Low_Tide_Mean_NN_umolL", 
                       "Low_Tide_Mean_Ammonia_umolL",
                       "Low_Tide_Mean_NNP_umolL"), progress = FALSE)
```

Extra exploratory plots:
```{r exploratory plots with bw change}
PAC_model_data_long <- pivot_longer(
  data = PAC_model_data,
  cols = c("Low_Tide_Mean_Phosphate_umolL",  
                       "Low_Tide_Mean_NN_umolL", 
                       "Low_Tide_Mean_Ammonia_umolL",
                       "Low_Tide_Mean_NNP_umolL",
           "CV_Salinity_scaled",  
                       "CV_Temperature_scaled",  
                       "CV_TA_scaled",  
                       "CV_pH_scaled"),
  names_to = "Parameter",
  values_to = "Value")

ggplot(PAC_model_data_long, aes(x = Value, y = Percent_Change)) +
    geom_point() +
    geom_smooth(method = "lm") +
    facet_wrap(~ Parameter, scales = "free") +
    theme_bw()
```


```{r exploratory plots with symb}
ggplot(PAC_model_data_long, aes(x = Value, y = FSC.Events_per_cm_2)) +
    geom_point() +
    geom_smooth(method = "lm") +
    facet_wrap(~ Parameter, scales = "free") +
    theme_bw()
```


```{r Growth Dredge CV or Low Tide Pulse, warning=FALSE, message=FALSE}
#PAC_cv_model <- glm(Percent_Change ~ ., data = PAC_cv_model_data, na.action = na.pass)
#the above line works if you only include response and explanatory in the dataframe, but dredge can't handle it with random effects

# Build the GLM model
#PAC_cv_model <- glm(Percent_Change ~ ., data = PAC_cv_model_data, na.action = na.pass)
PAC_cv_low_growth_model <- lmer(Percent_Change ~ 
                       CV_Salinity_scaled + 
                       CV_Temperature_scaled + 
                       CV_TA_scaled + 
                       CV_pH_scaled +
                       Low_Tide_Mean_Phosphate_umolL_scaled + 
                       Low_Tide_Mean_NN_umolL_scaled + 
                       Low_Tide_Mean_Ammonia_umolL_scaled +
                       Low_Tide_Mean_NNP_umolL_scaled +
                       (1 | Genotype), 
                                 data = PAC_model_data, 
                                 na.action = na.pass)

PAC_cv_low_growth_model_dredge <- dredge(PAC_cv_low_growth_model, trace = 2)
#model.sel(PAC_cv_low_growth_model_dredge)
PAC.avg_cv_low_growth_model = model.avg(PAC_cv_low_growth_model_dredge, delta < 5)
summary(PAC.avg_cv_low_growth_model)
PAC.avg_cv_low_growth_model$sw
```

Make the effects plots for the model with the most support:
```{r Growth CV + Low tide best model effects plots}
PAC_growth_cv_plus_lowtide_model <- lmer(Percent_Change ~ 
#                       CV_Salinity_scaled + 
#                       CV_Temperature_scaled + 
                       CV_TA_scaled + 
#                       CV_pH_scaled +
                       (1 | Genotype), 
                                 data = PAC_model_data, 
                                 na.action = na.pass)
plot(allEffects(PAC_growth_cv_plus_lowtide_model))
```

# April 17 Minimum Maximum models aka extremes drive change
```{r  PAC Growth Dredge Min and Max, warning=FALSE, message=FALSE}
#PAC_cv_model <- glm(Percent_Change ~ ., data = PAC_cv_model_data, na.action = na.pass)
#the above line works if you only include response and explanatory in the dataframe, but dredge can't handle it with random effects

# Build the GLM model
#PAC_cv_model <- glm(Percent_Change ~ ., data = PAC_cv_model_data, na.action = na.pass)
PAC_cv_minmax_growth_model <- lmer(Percent_Change ~ 
                       Minimum_Salinity_scaled + 
                       Minimum_Temperature_scaled + 
                       Maximum_TA_scaled + 
                       Minimum_pH_scaled +
                       Maximum_NN_umolL_scaled + 
                       Maximum_Phosphate_umolL_scaled + 
                       Maximum_NNP_umolL_scaled +
                       (1 | Genotype), 
                                 data = PAC_model_data, 
                                 na.action = na.pass)

PAC_cv_minmax_growth_model_dredge <- dredge(PAC_cv_minmax_growth_model, trace = 2)
#model.sel(PAC_cv_low_growth_model_dredge)
PAC.avg_minmax_growth_model = model.avg(PAC_cv_minmax_growth_model_dredge, delta < 10)
summary(PAC.avg_minmax_growth_model)
PAC.avg_minmax_growth_model$sw
```

```{r PRU Growth Dredge Min and Max, warning=FALSE, message=FALSE}
PRU_cv_minmax_growth_model <- lmer(Percent_Change ~ 
                       Minimum_Salinity_scaled + 
                       Minimum_Temperature_scaled + 
                       Maximum_TA_scaled + 
                       Minimum_pH_scaled +
                       Maximum_NN_umolL_scaled + 
                       Maximum_Phosphate_umolL_scaled + 
                       Maximum_NNP_umolL_scaled +
                       (1 | Genotype), 
                                 data = PRU_model_data, 
                                 na.action = na.pass)

PRU_cv_minmax_growth_model_dredge <- dredge(PRU_cv_minmax_growth_model, trace = 2)
#model.sel(PAC_cv_low_growth_model_dredge)
PRU.avg_minmax_growth_model = model.avg(PRU_cv_minmax_growth_model_dredge, delta < 10)
summary(PRU.avg_minmax_growth_model)
PRU.avg_minmax_growth_model$sw
```

### Symbiont Count Models

```{r Symbiont data CV AND low tide data dredge, warning=FALSE, message=FALSE}
# Build the GLM model
#PAC_cv_model <- glm(Percent_Change ~ ., data = PAC_cv_model_data, na.action = na.pass)
PAC_cv_low_symb_model <- lmer(log10(FSC.Events_per_cm_2) ~
                       Low_Tide_Mean_Phosphate_umolL_scaled + 
                       Low_Tide_Mean_NN_umolL_scaled + 
                       Low_Tide_Mean_Ammonia_umolL_scaled +
                       Low_Tide_Mean_NNP_umolL_scaled +
                       (1 | Genotype) + (1 | Cage_Uncaged), 
                                 data = PAC_model_data, 
                                 na.action = na.pass)

PAC_cv_low_symb_model_dredge <- dredge(PAC_cv_low_symb_model, trace = 2)
model.sel(PAC_cv_low_symb_model_dredge)
PAC_cv_low_symb_model_dredge_model.avg = model.avg(PAC_cv_low_symb_model_dredge, delta < 8)
summary(PAC_cv_low_symb_model_dredge_model.avg)
PAC_cv_low_symb_model_dredge_model.avg$sw
```


```{r Symbiont cv and low tide best model effects plots}
PAC_symb_cv_plus_lowtide_model <- lmer(log10(FSC.Events_per_cm_2) ~ 
                       CV_Salinity + 
                       CV_Temperature + 
                       CV_TA + 
                       CV_pH +
                       (1 | Genotype) + (1 | Cage_Uncaged), 
                                 data = PAC_model_data, 
                                 na.action = na.pass)
plot(allEffects(PAC_symb_cv_plus_lowtide_model))
```


```{r, warning=FALSE, message=FALSE, fig.width=12, fig.height=6}
plot1 <- SI_data_wide %>%
    filter(Species == "Porites rus", HS == "symb") %>% 
    ggplot(aes(x = pulse_pc1, y = δ15N)) +
    geom_point(aes(shape=Genotype)) +
    geom_smooth(method = "lm") +
    ggtitle("Porites rus symb δ15N") +  #Add species name to the plot title
    theme_bw() +
  theme(legend.position = "none")

plot2 <- SI_data_wide %>%
    filter(Species == "Porites rus", HS == "host") %>% 
    ggplot(aes(x = pulse_pc1, y = δ15N)) +
    geom_point(aes(shape=Genotype)) +
    geom_smooth(method = "lm") +
    ggtitle("Porites rus host δ15N") +  #Add species name to the plot title
    theme_bw()+
  theme(legend.position = "none")

plot3 <- SI_data_wide %>%
    filter(Species == "Porites rus", HS == "host") %>% 
    ggplot(aes(x = pulse_pc1, y = Δ15N)) +
    geom_point(aes(shape=Genotype)) +
    geom_smooth(method = "lm") +
    ggtitle("Porites rus Δ15N") +  #Add species name to the plot title
    theme_bw()+
  theme(legend.position = "none")

plot4 <- SI_data_wide %>%
    filter(Species == "Pocillopora acuta", HS == "symb") %>% 
    ggplot(aes(x = pulse_pc1, y = δ15N)) +
    geom_point(aes(shape=Genotype)) +
    geom_smooth(method = "lm") +
    ggtitle("Pocillopora acuta symb δ15N") +  #Add species name to the plot title
    theme_bw()+
  theme(legend.position = "none")

plot5 <- SI_data_wide %>%
    filter(Species == "Pocillopora acuta", HS == "host") %>% 
    ggplot(aes(x = pulse_pc1, y = δ15N)) +
    geom_point(aes(shape=Genotype)) +
    geom_smooth(method = "lm") +
    ggtitle("Pocillopora acuta host δ15N") +  #Add species name to the plot title
    theme_bw()+
  theme(legend.position = "none")

plot6 <- SI_data_wide %>%
    filter(Species == "Pocillopora acuta", HS == "host") %>% 
    ggplot(aes(x = pulse_pc1, y = Δ15N)) +
    geom_point(aes(shape=Genotype)) +
    geom_smooth(method = "lm") +
    ggtitle("Pocillopora acuta Δ15N") +  #Add species name to the plot title
    theme_bw()+
  theme(legend.position = "none")

grid.arrange(plot1, plot2, plot3, plot4, plot5, plot6, ncol = 2)
```



```{r, eval=FALSE, include=FALSE}
plot1 <- SI_data_wide %>%
    filter(Species == "Porites rus", HS == "symb") %>% 
    ggplot(aes(x = pulse_pc1, y = δ13C)) +
    geom_point() +
    geom_smooth(method = "lm") +
    ggtitle("Porites rus symb δ13C") +  #Add species name to the plot title
    theme_bw()

plot2 <- SI_data_wide %>%
    filter(Species == "Porites rus", HS == "host") %>% 
    ggplot(aes(x = pulse_pc1, y = δ13C)) +
    geom_point() +
    geom_smooth(method = "lm") +
    ggtitle("Porites rus host δ13C") +  #Add species name to the plot title
    theme_bw()

plot3 <- SI_data_wide %>%
    filter(Species == "Porites rus", HS == "host") %>% 
    ggplot(aes(x = pulse_pc1, y = Δ13C)) +
    geom_point() +
    geom_smooth(method = "lm") +
    ggtitle("Porites rus host δ13C") +  #Add species name to the plot title
    theme_bw()

plot4 <- SI_data_wide %>%
    filter(Species == "Pocillopora acuta", HS == "symb") %>% 
    ggplot(aes(x = pulse_pc1, y = δ13C)) +
    geom_point() +
    geom_smooth(method = "lm") +
    ggtitle("Pocillopora acuta symb δ13C") +  #Add species name to the plot title
    theme_bw()

plot5 <- SI_data_wide %>%
    filter(Species == "Pocillopora acuta", HS == "host") %>% 
    ggplot(aes(x = pulse_pc1, y = δ13C)) +
    geom_point() +
    geom_smooth(method = "lm") +
    ggtitle("Pocillopora acuta host δ13C") +  #Add species name to the plot title
    theme_bw()

plot6 <- SI_data_wide %>%
    filter(Species == "Pocillopora acuta", HS == "host") %>% 
    ggplot(aes(x = pulse_pc1, y = Δ13C)) +
    geom_point() +
    geom_smooth(method = "lm") +
    ggtitle("Porites rus host δ13C") +  #Add species name to the plot title
    theme_bw()

grid.arrange(plot1, plot2, plot3, plot4, plot5, plot6, ncol = 3)
```


```{r}

create_SI_plot <- function(data, species, HS, x_variable, y_variable, title_suffix) {
  data %>%
    filter(Species == species, HS == HS) %>% 
    ggplot(aes(x = !!sym(x_variable), y = !!sym(y_variable))) +
    geom_point(aes(shape = Genotype)) +
    geom_smooth(method = "lm") +
    ggtitle(paste(species, HS, title_suffix)) +  
    theme_bw() +
    theme(legend.position = "none")
}
```



```{r PRU all variables scaled against growth, message=FALSE}
model_results <- data.frame(Parameter = character(),
                            AICc = numeric(),
                            p.value = numeric(),
                            Estimate = numeric(),
                            stringsAsFactors = FALSE)
plotlist <- list()

parameters <- unique(PRU_model_scaled_data_long$Parameter)

for (parameter in parameters) {
  # Create a subset of data for the current parameter
  subset_data <- subset(PRU_model_scaled_data_long, Parameter == parameter)
  
  # Fit the mixed-effects model
  model <- lmer(Percent_Change ~ value + (1|Genotype) + (1|Cage_Uncaged), data = subset_data)
  
  # Get AICc
  AICc <- AICc(model)
  
  # Get p-value from summary
  model_summary <- summary(model)
  p.value <- model_summary$coefficients["value", "Pr(>|t|)"]
  Estimate <- model_summary$coefficients["value", "Estimate"]
  
 if (p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = AICc,
                                                     p.value = p.value,
                                                     Estimate = Estimate))
    
    # Create an effects plot using ggpredict
    effect_plot <- ggpredict(model, terms = "value[all]")
    
    # Extract the ggplot object from the ggpredict object
    ggplot_obj <- plot(effect_plot)
    
    # Add the ggplot object to the plotlist
    plotlist[[parameter]] <- ggplot_obj + ggtitle(parameter)
  }
  }
model_results %>% filter(p.value < 0.05)
grid.arrange(grobs = plotlist, ncol = 2)

model_results$Species <- "Porites rus"
model_results$type <- "linear"

PRU_growth_model_results <- model_results
```

#### Pru growth polynomial

```{r}
model_results <- data.frame(Parameter = character(),
                            AICc = numeric(),
                            p.value = numeric(),
                            Estimate = numeric(),
                            stringsAsFactors = FALSE)
plotlist <- list()

parameters <- unique(PRU_model_scaled_data_long$Parameter)

for (parameter in parameters) {
  # Create a subset of data for the current parameter
  subset_data <- subset(PRU_model_scaled_data_long, Parameter == parameter)
  
  # Fit the mixed-effects model
  model <- lmer(Percent_Change ~ (value^2) + (1|Genotype) + (1|Cage_Uncaged), data = subset_data)
  
  # Get AICc
  AICc <- AICc(model)
  
  # Get p-value from summary
  model_summary <- summary(model)
  p.value <- model_summary$coefficients["value", "Pr(>|t|)"]
  Estimate <- model_summary$coefficients["value", "Estimate"]
  
 if (p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = AICc,
                                                     p.value = p.value,
                                                     Estimate = Estimate))
    
    # Create an effects plot using ggpredict
    effect_plot <- ggpredict(model, terms = "value[all]")
    
    # Extract the ggplot object from the ggpredict object
    ggplot_obj <- plot(effect_plot)
    
    # Add the ggplot object to the plotlist
    plotlist[[parameter]] <- ggplot_obj + ggtitle(parameter)
  }
  }
model_results %>% filter(p.value < 0.05)
grid.arrange(grobs = plotlist, ncol = 2)

model_results$Species <- "Porites rus"
model_results$type <- "value^2"

PRU_growth_model_results <- model_results
```

#### using poly,2

```{r PRU polynomial all variables scaled against growth, message=FALSE}
model_results <- data.frame(Parameter = character(),
                            AICc = numeric(),
                            p.value = numeric(),
                            Estimate1 = numeric(),
                            Estimate2 = numeric(),
                            stringsAsFactors = FALSE)
plotlist <- list()

parameters <- unique(PRU_model_scaled_data_long$Parameter)

for (parameter in parameters) {
  # Create a subset of data for the current parameter
  subset_data <- subset(PRU_model_scaled_data_long, Parameter == parameter)
  
  # Fit the mixed-effects model
  model <- lmer(Percent_Change ~ poly(value,2) + (1|Genotype) + (1|Cage_Uncaged), data = subset_data)
  
  # Get AICc and p-value
  AICc <- AICc(model)
  
  # Get p-value from summary
  model_summary <- summary(model)
  p.value_linear <- model_summary$coefficients["poly(value, 2)1", "Pr(>|t|)"]
  p.value_exp <- model_summary$coefficients["poly(value, 2)2", "Pr(>|t|)"]
  poly_Estimate <- model_summary$coefficients["poly(value, 2)2", "Estimate"]
  linear_Estimate <- model_summary$coefficients["poly(value, 2)1", "Estimate"]
  
  if (p.value_linear < 0.05) {
    if (p.value_exp < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = AICc,
                                                     p.value = p.value,
                                                     Estimate1 = poly_Estimate,
                                                     Estimate2 = linear_Estimate))
    
    # Create an effects plot using ggpredict
    effect_plot <- ggpredict(model, terms = "value")
    
    # Extract the ggplot object from the ggpredict object
    ggplot_obj <- plot(effect_plot)
    
    # Add the ggplot object to the plotlist
    plotlist[[parameter]] <- ggplot_obj + ggtitle(parameter)
  }
  }
}

model_results %>% filter(p.value < 0.05)
grid.arrange(grobs = plotlist, ncol = 2)

model_results$Species <- "Porites rus"
model_results$type <- "full polynomial"

#PRU_growth_model_results <- rbind(model_results,PRU_growth_model_results)
```


### UNIVARIATE Models
```{r CALLIE THIS IS YOUR LOOPING CODE Singular model looping, warning=FALSE}
#make the PAC data frame longer
PAC_model_scaled_data_long <- pivot_longer(
  data = PAC_model_data[,c(1:5,32:57)],
  cols = c(Minimum_Salinity_scaled:Low_Tide_Mean_Ammonia_umolL_scaled)) 
names(PAC_model_scaled_data_long)[names(PAC_model_scaled_data_long) == "name"] <- "Parameter"

PAC_model_data_long <- pivot_longer(
  data = PAC_model_data[,c(1:5,6:31)],
  cols = c(Minimum_Salinity:Low_Tide_Mean_Ammonia_umolL)) 
names(PAC_model_data_long)[names(PAC_model_data_long) == "name"] <- "Parameter"


#make the PRU data frame longer
PRU_model_scaled_data_long <- pivot_longer(
  data = PRU_model_data[,c(1:5,32:57)],
  cols = c(Minimum_Salinity_scaled:Low_Tide_Mean_Ammonia_umolL_scaled)) 
names(PRU_model_scaled_data_long)[names(PRU_model_scaled_data_long) == "name"] <- "Parameter"

```

#### Pac growth linear
```{r PAC linear growth model all scaled parameteres against}
model_results <- data.frame(Parameter = character(),
                            AICc = numeric(),
                            p.value = numeric(),
                            Estimate = numeric(),
                            stringsAsFactors = FALSE)

plotlist <- list()

parameters <- unique(PAC_model_scaled_data_long$Parameter)

for (parameter in parameters) {
  # Create a subset of data for the current parameter
  subset_data <- subset(PAC_model_scaled_data_long, Parameter == parameter)
  
  # Fit the mixed-effects model
  model <- lmer(Percent_Change ~ value + (1|Genotype) + (1|Cage_Uncaged), data = subset_data)
  
  # Get AICc and p-value
    AICc <- AICc(model)
  
  # Get p-value from summary
  model_summary <- summary(model)
  p.value <- model_summary$coefficients["value", "Pr(>|t|)"]
  Estimate <- model_summary$coefficients["value", "Estimate"]
  
  # Calculate marginal and conditional R-squared values
    rsq <- as.numeric(r.squaredGLMM(model))
    marginal_R2 <- rsq[1]
    conditional_R2 <- rsq[2]
  
  if (p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = AICc,
                                                     p.value = p.value,
                                                     Estimate = Estimate,
                                                     Marginal_R2 = marginal_R2,
                                                     Conditional_R2 = conditional_R2))
    
    # Create an effects plot using ggpredict
    effect_plot <- ggpredict(model, terms = "value[all]")
    
    # Extract the ggplot object from the ggpredict object
    ggplot_obj <- plot(effect_plot)
    
    # Add the ggplot object to the plotlist
    plotlist[[parameter]] <- ggplot_obj + ggtitle(parameter)
  }
  }
print(model_results)
grid.arrange(grobs = plotlist, ncol = 2)

model_results$Species <- "Pocillopora acuta"
model_results$type <- "linear"

PAC_growth_model_results <- model_results

```

#### Pac growth polynomial
```{r PAC polynomial model all scaled parameteres against growth}
model_results <- data.frame(Parameter = character(),
                            AICc = numeric(),
                            p.value = numeric(),
                            Estimate = numeric(),
                            stringsAsFactors = FALSE)
plotlist <- list()

parameters <- unique(PAC_model_scaled_data_long$Parameter)

for (parameter in parameters) {
  # Create a subset of data for the current parameter
  subset_data <- subset(PAC_model_scaled_data_long, Parameter == parameter)
  
  # Fit the mixed-effects model
  model <- lmer(Percent_Change ~ poly(value,2) + (1|Genotype) + (1|Cage_Uncaged), data = subset_data)
  
  # Get AICc and p-value
  AICc <- AICc(model)
  
  # Get p-value from summary
  model_summary <- summary(model)
  p.value <- model_summary$coefficients["poly(value, 2)1", "Pr(>|t|)"]
  Estimate <- model_summary$coefficients["poly(value, 2)1", "Estimate"]
  
  # Calculate marginal and conditional R-squared values
    rsq <- as.numeric(r.squaredGLMM(model))
    marginal_R2 <- rsq[1]
    conditional_R2 <- rsq[2]
  
  if (p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = AICc,
                                                     p.value = p.value,
                                                     Estimate = Estimate,
                                                     Marginal_R2 = marginal_R2,
                                                     Conditional_R2 = conditional_R2))
    
    # Create an effects plot using ggpredict
    effect_plot <- ggpredict(model, terms = "value[all]")
    
    # Extract the ggplot object from the ggpredict object
    ggplot_obj <- plot(effect_plot)
    
    # Add the ggplot object to the plotlist
    plotlist[[parameter]] <- ggplot_obj + ggtitle(parameter)
  }
  }

model_results %>% filter(p.value < 0.05)
grid.arrange(grobs = plotlist, ncol = 2)

model_results$Species <- "Pocillopora acuta"
model_results$type <- "polynomial"

PAC_growth_model_results <- rbind(model_results, PAC_growth_model_results)
```

#### PAC growth results
```{r}
PAC_growth_model_results[order(PAC_growth_model_results$AICc), c(1, 8, 2:7)]
```

```{r PAC growth multivariate dredge}
PAC_growth_big_model <- lmer(Percent_Change ~ 
                      poly(CV_pH_scaled,2) +
                        Minimum_pH_scaled +
                         CV_TA_scaled +
                         CV_NN_umolL_scaled +
                         Maximum_TA_scaled +
                       (1 | Genotype)+ (1|Cage_Uncaged), 
                                 data = PAC_model_data, 
                                 na.action = na.pass)

PAC_growth_big_model_dredge <- dredge(PAC_growth_big_model, trace = 2)
#model.sel(PAC_cv_low_growth_model_dredge)
PAC_growth.avg = model.avg(PAC_growth_big_model_dredge, delta < 4)
summary(PAC_growth.avg)
PAC_growth.avg$sw
```


## PAC GROWTH FINAL:
```{r}
FINAL_PAC_growth <- subset(PAC_growth_model_results, abs(AICc - min(AICc)) < 2)

FINAL_PAC_growth
```


#### PRU growth results
```{r}
PRU_growth_model_results[order(PRU_growth_model_results$AICc), c(1, 6, 2:5)]
```

```{r multivariate dredge}
#PRU_growth_big_model <- lmer(Percent_Change ~ 
#                       poly(Low_Tide_Mean_Salinity_scaled,2) + 
#                       poly(CV_Salinity_scaled,2) +
#                       (1 | Genotype)+ (1|Cage_Uncaged), 
#                                 data = PRU_model_data, 
#                                 na.action = na.pass)

#PRU_growth_big_model_dredge <- dredge(PRU_growth_big_model, trace = 2)
#model.sel(PAC_cv_low_growth_model_dredge)
#PRU_growth.avg = model.avg(PRU_growth_big_model_dredge, delta < 10)
#summary(PRU_growth.avg)
#PRU_growth.avg$sw
```

```{r Pru growth ALL THE MODELS, message=FALSE}
model_results <- data.frame(Parameter = character(),
                            AICc = numeric(),
                            p.value1 = numeric(),
                            p.value2 = numeric(),
                            Estimate1 = numeric(),
                            Estimate2 = numeric(),
                            type = character(),
                            stringsAsFactors = FALSE)
plotlist <- list()

parameters <- unique(PRU_model_scaled_data_long$Parameter)

for (parameter in parameters) {
  # Create a subset of data for the current parameter
  subset_data <- subset(PRU_model_scaled_data_long, Parameter == parameter)
  
  # Fit the mixed-effects model
  linear_model <- lmer(Percent_Change ~ value + (1|Genotype) + (1|Cage_Uncaged), data = subset_data)
  polynomial_model <- lmer(Percent_Change ~ poly(value,2) + (1|Genotype) + (1|Cage_Uncaged), data = subset_data)
  
  # Get AICc
  linear_AICc <- AICc(linear_model)
  polynomial_AICc <- AICc(polynomial_model)
  
  # Get p-value from summary
  linear_model_summary <- summary(linear_model)
  linear_p.value <- linear_model_summary$coefficients["value", "Pr(>|t|)"]
  polynomial_model_summary <- summary(polynomial_model)
  polynomial_p.value1 <- polynomial_model_summary$coefficients["poly(value, 2)1", "Pr(>|t|)"]
  polynomial_p.value2 <- polynomial_model_summary$coefficients["poly(value, 2)2", "Pr(>|t|)"]
  
  # Get Estimate
  linear_Estimate <- linear_model_summary$coefficients["value", "Estimate"]
  polynomial_Estimate1 <- polynomial_model_summary$coefficients["poly(value, 2)1", "Estimate"]
  polynomial_Estimate2 <- polynomial_model_summary$coefficients["poly(value, 2)2", "Estimate"]
  
  if (linear_p.value < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = linear_AICc,
                                                     p.value1 = linear_p.value,
                                                     p.value2 = "NA",
                                                     Estimate1 = linear_Estimate,
                                                     Estimate2 = "NA",
                                                     type = "linear"))
    
    # Add the ggplot object to the plotlist
    plotlist[[paste0(parameter, "_linear")]] <- ggplot(data = subset_data, aes(x = value, y = Percent_Change)) +
      geom_point() +
      geom_smooth(method = "lm") +
      labs(x = parameter) +
      theme_bw()
 }
  
   if (polynomial_p.value2 < 0.05) {
    # Add results to the dataframe
    model_results <- rbind(model_results, data.frame(Parameter = parameter,
                                                     AICc = polynomial_AICc,
                                                     p.value1 = polynomial_p.value1,
                                                     p.value2 = polynomial_p.value2,
                                                     Estimate1 = polynomial_Estimate1,
                                                     Estimate2 = polynomial_Estimate2,
                                                     type = "polynomial"))
    
    # Add the ggplot object to the plotlist
    plotlist[[paste0(parameter, "_polynomial")]] <- ggplot(data = subset_data, aes(x = value, y = Percent_Change)) +
    geom_point() +
    geom_smooth(method = "lm", formula = y ~ poly(x, 2)) +
    labs(x = parameter) +
    theme_bw()
     }
  }

grid.arrange(grobs = plotlist, ncol = 4)

model_results$Species <- "Porites rus"

PRU_growth_model_results <- model_results
PRU_growth_model_results[order(PAC_growth_model_results$AICc), c(1, 7, 2:6)]
```

