---
title: "Code I don't think I need"
author: "Callie Stephenson"
date: "2024-04-08"
output: html_document
---




```{r STOP HERE !!!}
bw_caged_PAC <-lmer(Percent_Change ~ shore_dist_m + (1 | Genotype), data = all_data %>%                     filter(Species == "Pocillopora acuta" 
                           & Cage_Uncaged == "C"))
anova(bw_caged_PAC)

data <- all_data %>% 
                     filter(Species == "Pocillopora acuta" 
                           & Cage_Uncaged == "C" 
                           & Parameter == "pc1") 
#this removes V13 because it doesn't have shore dist
ggplot(data, aes(x = X._loss, y = Percent_Change))+
  geom_point(aes(color = value))+
  scale_color_fish(option = "Coryphaena_hippurus")+
  geom_smooth(method = "lm", formula = 'y~poly(x,2)')+
  labs(title="Growth of Pocillopora acuta colonies against distance from shore")
```
So this is suggesting that distance from shore is significant, let's see if SGD is too:
```{r}
bw_caged_PAC <-lmer(Percent_Change ~ shore_dist_m + value + (1 | Genotype), data = all_data %>% 
                     filter(Species == "Pocillopora acuta" 
                           & Cage_Uncaged == "C" 
                           & Parameter == "pc1") ) 
anova(bw_caged_PAC)
```


Now that we've done our data exploration, let's make the data frame needed to build some models!

```{r starting models with megan}
#For models of only caged corals, we are running with Genotype as covariate instead of random effect
#Cannot run as random effect without singularity (as there is only one occurance of genotype for every occurence of the nutrient parameter)
#for example, see how this is singular:

bw_m1_caged_PAC <-lmer(Percent_Change ~ shore_dist_m + (1 | Genotype), data = all_data %>% 
                    filter(Parameters == "Salinity" & Species == "Pocillopora acuta" & Cage_Uncaged == "C")) 
anova(bw_m1_caged_PAC)
summary(bw_m1_caged_PAC)

##plots with megan
ggplot(all_PAC_data) +
  geom_point(data = subset(all_PAC_data, Cage_Uncaged == "C"),
             aes(x = Genotype, y = Percent_Change, color = shore_dist_m)) +
  scale_color_fish(option = "Coryphaena_hippurus")
#this shore distance looks like it could be a trend

#variance components analysis within genotype and between genotype variance
#looking at all the variance in the data, looking at the grand mean vs. the mean for the random effects
#how much is between vs within genotype variance
bw_m1_caged_PRU <-lmer(Percent_Change ~ shore_dist_m + (1 | Genotype), data = all_data %>% 
                    filter(Parameters == "Salinity" & Species == "Porites rus" & Cage_Uncaged == "C")) 
anova(bw_m1_caged_PRU)
summary(bw_m1_caged_PRU)

ggplot(all_PRU_data) +
  geom_point(data = subset(all_PRU_data, Cage_Uncaged == "C"),
             aes(x = Genotype, y = Percent_Change, color = shore_dist_m))+
  scale_color_fish(option = "Coryphaena_hippurus")
```
```{r WHY YOU GET SINGULARITY IN ACUTA, eval = FALSE, echo=FALSE}
dataPAC = all_data %>%
  filter(Parameters == "Salinity" & Species == "PAC" & Cage_Uncaged == "C")

dataPRU = all_data %>% 
  filter(Parameters == "Salinity" & Species == "PRU" & Cage_Uncaged == "C")

ggplot(dataPAC) +
  geom_point(aes(x = Genotype, y = Percent_Change, color = shore_dist_m))+
  scale_color_fish(option = "Coryphaena_hippurus")
#NEARLY NO VARIATION ATTRIBUTABLE TO GENOTYPE

ggplot(dataPRU) +
  geom_point(aes(x = Genotype, y = Percent_Change, color = shore_dist_m))+
  scale_color_fish(option = "Coryphaena_hippurus")

#Q from MJD for KE:
#if you get an estimate of 0 for your random effect what do you do
#do you keep bc the structure is important
#or do you drop because the model becomes simpler

#To move forward: drop the random effect for PAC models.
```

```{r starting models, eval = FALSE, echo=FALSE}
###
#Cannot run as random effect without singularity (as there is only one occurance of genotype for every occurence of the nutrient parameter)
bw_m1_caged_PAC <-lm(Percent_Change ~ CVSeasonal + shore_dist_m,
                  data = all_data %>% 
                    filter(Parameters == "Salinity" & Species == "PAC" & Cage_Uncaged == "C"))
anova(bw_m1_caged_PAC)

bw_m1_caged_PRU <-lmer(Percent_Change ~ CVSeasonal + shore_dist_m + (1 | Genotype),
                  data = all_data %>% 
                    filter(Parameters == "Salinity" & Species == "PRU" & Cage_Uncaged == "C"))
anova(bw_m1_caged_PRU)

#For models of all corals, we are running with Genotype as a random effect
bw_m1_PAC <- lmer(Percent_Change ~ CVSeasonal + (1 | Genotype) + Cage_Uncaged, 
                  data = all_data %>% 
                    filter(Parameters == "Salinity" & Species == "PAC"))
anova(bw_m1_PAC)

bw_m1_PRU <- lmer(Percent_Change ~ CVSeasonal + (1 | Genotype) + Cage_Uncaged, 
                  data = all_data %>% 
                    filter(Parameters == "Salinity" & Species == "PRU"))
anova(bw_m1_PRU)
summary(bw_m1_PRU)
```

Same models as before, but now with silicate instead, because the range in SiO32- was an order of magnitude higher on the reef than salinity allowing for a higher signal to noise ratio. I also used maximum silicate, as it is more indicative of the maximum amount of groundwater experienced

```{r starting models silicate, eval = FALSE, echo=FALSE}
#For models of only caged corals, we are running with Genotype as covariate instead of random effect
#Cannot run as random effect without singularity (as there is only one occurance of genotype for every occurence of the nutrient parameter)
#for example, see how this is singular:
bw_m1_caged_PAC <-lmer(Percent_Change ~ Maximum + (1 | Genotype), data = all_data %>% 
                    filter(Parameters == "Silicate_umolL" & Species == "PAC" & Cage_Uncaged == "C")) 
anova(bw_m1_caged_PAC)
                    
###
#Cannot run as random effect without singularity (as there is only one occurrence of genotype for every occurrence of the nutrient parameter)
bw_m1_caged_PAC <-lm(Percent_Change ~ Maximum + Genotype,
                  data = all_data %>% 
                    filter(Parameters == "Silicate_umolL" & 
                             Species == "PAC" & 
                             Cage_Uncaged == "C"))
anova(bw_m1_caged_PAC)

bw_m1_caged_PRU <-lm(Percent_Change ~ Maximum + Genotype,
                  data = all_data %>% 
                    filter(Parameters == "Silicate_umolL" & 
                             Species == "PRU" & 
                             Cage_Uncaged == "C"))
anova(bw_m1_caged_PRU)

#For models of all corals, we are running with Genotype as a random effect
bw_m1_PAC <- lmer(Percent_Change ~ Maximum + (1 | Genotype) + Cage_Uncaged, 
                  data = all_data %>% 
                    filter(Parameters == "Silicate_umolL" & 
                             Species == "PAC"))
anova(bw_m1_PAC)
summary(bw_m1_PAC)

bw_m1_PRU <- lmer(Percent_Change ~ Maximum + (1 | Genotype) + Cage_Uncaged, 
                  data = all_data %>% 
                    filter(Parameters == "Silicate_umolL" & 
                             Species == "PRU"))
anova(bw_m1_PRU)
summary(bw_m1_PRU)
```
This also only sees a correlation between all (not just caged) change in buoyant weight for PRU. PAC is not significant.

Now let's see those same models with symbiont counts
```{r starting models symb, eval = FALSE, echo=FALSE}
#again running with Genotype as covariate when only 
symb_m1_caged_PAC <-lm(Normalized_Symbiont_Counts ~ CVSeasonal + Genotype,
                  data = all_data %>% 
                    filter(Parameters == "Salinity" & Species == "PAC" & Cage_Uncaged == "C"))
anova(symb_m1_caged_PAC)

symb_m1_caged_PRU <-lm(Normalized_Symbiont_Counts ~ CVSeasonal + Genotype,
                  data = all_data %>% 
                    filter(Parameters == "Salinity" & Species == "PRU" & Cage_Uncaged == "C"))
anova(symb_m1_caged_PRU)

#but with all the corals we can use Genotype as random effect
symb_m1_PAC <- lmer(Normalized_Symbiont_Counts ~ CVSeasonal + (1 | Genotype) + Cage_Uncaged, 
                  data = all_data %>% 
                    filter(Parameters == "Salinity" & Species == "PAC"))
anova(symb_m1_PAC)

symb_m1_PRU <- lmer(Normalized_Symbiont_Counts ~ CVSeasonal + (1 | Genotype) + Cage_Uncaged, 
                  data = all_data %>% 
                    filter(Parameters == "Salinity" & Species == "PRU"))
anova(symb_m1_PRU)
summary(symb_m1_PRU)
```


### EXTRA


#### Dredged data models (aka is multiresponse better than univariate models)

```{r collinearity in cv dredge parameters}
ggpairs(PAC_model_data, columns = c("CV_Salinity_scaled",  
                       "CV_Temperature_scaled",  
                       "CV_TA_scaled",  
                       "CV_pH_scaled"), progress = FALSE)
```

```{r collinearity in pulse dredge parameters}
ggpairs(PAC_model_data, columns = c("Low_Tide_Mean_Phosphate_umolL",  
                       "Low_Tide_Mean_NN_umolL", 
                       "Low_Tide_Mean_Ammonia_umolL",
                       "Low_Tide_Mean_NNP_umolL"), progress = FALSE)
```

Extra exploratory plots:
```{r exploratory plots with bw change}
PAC_model_data_long <- pivot_longer(
  data = PAC_model_data,
  cols = c("Low_Tide_Mean_Phosphate_umolL",  
                       "Low_Tide_Mean_NN_umolL", 
                       "Low_Tide_Mean_Ammonia_umolL",
                       "Low_Tide_Mean_NNP_umolL",
           "CV_Salinity_scaled",  
                       "CV_Temperature_scaled",  
                       "CV_TA_scaled",  
                       "CV_pH_scaled"),
  names_to = "Parameter",
  values_to = "Value")

ggplot(PAC_model_data_long, aes(x = Value, y = Percent_Change)) +
    geom_point() +
    geom_smooth(method = "lm") +
    facet_wrap(~ Parameter, scales = "free") +
    theme_bw()
```


```{r exploratory plots with symb}
ggplot(PAC_model_data_long, aes(x = Value, y = FSC.Events_per_cm_2)) +
    geom_point() +
    geom_smooth(method = "lm") +
    facet_wrap(~ Parameter, scales = "free") +
    theme_bw()
```


```{r Growth Dredge CV or Low Tide Pulse, warning=FALSE, message=FALSE}
#PAC_cv_model <- glm(Percent_Change ~ ., data = PAC_cv_model_data, na.action = na.pass)
#the above line works if you only include response and explanatory in the dataframe, but dredge can't handle it with random effects

# Build the GLM model
#PAC_cv_model <- glm(Percent_Change ~ ., data = PAC_cv_model_data, na.action = na.pass)
PAC_cv_low_growth_model <- lmer(Percent_Change ~ 
                       CV_Salinity_scaled + 
                       CV_Temperature_scaled + 
                       CV_TA_scaled + 
                       CV_pH_scaled +
                       Low_Tide_Mean_Phosphate_umolL_scaled + 
                       Low_Tide_Mean_NN_umolL_scaled + 
                       Low_Tide_Mean_Ammonia_umolL_scaled +
                       Low_Tide_Mean_NNP_umolL_scaled +
                       (1 | Genotype), 
                                 data = PAC_model_data, 
                                 na.action = na.pass)

PAC_cv_low_growth_model_dredge <- dredge(PAC_cv_low_growth_model, trace = 2)
#model.sel(PAC_cv_low_growth_model_dredge)
PAC.avg_cv_low_growth_model = model.avg(PAC_cv_low_growth_model_dredge, delta < 5)
summary(PAC.avg_cv_low_growth_model)
PAC.avg_cv_low_growth_model$sw
```

Make the effects plots for the model with the most support:
```{r Growth CV + Low tide best model effects plots}
PAC_growth_cv_plus_lowtide_model <- lmer(Percent_Change ~ 
#                       CV_Salinity_scaled + 
#                       CV_Temperature_scaled + 
                       CV_TA_scaled + 
#                       CV_pH_scaled +
                       (1 | Genotype), 
                                 data = PAC_model_data, 
                                 na.action = na.pass)
plot(allEffects(PAC_growth_cv_plus_lowtide_model))
```

# April 17 Minimum Maximum models aka extremes drive change
```{r  PAC Growth Dredge Min and Max, warning=FALSE, message=FALSE}
#PAC_cv_model <- glm(Percent_Change ~ ., data = PAC_cv_model_data, na.action = na.pass)
#the above line works if you only include response and explanatory in the dataframe, but dredge can't handle it with random effects

# Build the GLM model
#PAC_cv_model <- glm(Percent_Change ~ ., data = PAC_cv_model_data, na.action = na.pass)
PAC_cv_minmax_growth_model <- lmer(Percent_Change ~ 
                       Minimum_Salinity_scaled + 
                       Minimum_Temperature_scaled + 
                       Maximum_TA_scaled + 
                       Minimum_pH_scaled +
                       Maximum_NN_umolL_scaled + 
                       Maximum_Phosphate_umolL_scaled + 
                       Maximum_NNP_umolL_scaled +
                       (1 | Genotype), 
                                 data = PAC_model_data, 
                                 na.action = na.pass)

PAC_cv_minmax_growth_model_dredge <- dredge(PAC_cv_minmax_growth_model, trace = 2)
#model.sel(PAC_cv_low_growth_model_dredge)
PAC.avg_minmax_growth_model = model.avg(PAC_cv_minmax_growth_model_dredge, delta < 10)
summary(PAC.avg_minmax_growth_model)
PAC.avg_minmax_growth_model$sw
```

```{r PRU Growth Dredge Min and Max, warning=FALSE, message=FALSE}
PRU_cv_minmax_growth_model <- lmer(Percent_Change ~ 
                       Minimum_Salinity_scaled + 
                       Minimum_Temperature_scaled + 
                       Maximum_TA_scaled + 
                       Minimum_pH_scaled +
                       Maximum_NN_umolL_scaled + 
                       Maximum_Phosphate_umolL_scaled + 
                       Maximum_NNP_umolL_scaled +
                       (1 | Genotype), 
                                 data = PRU_model_data, 
                                 na.action = na.pass)

PRU_cv_minmax_growth_model_dredge <- dredge(PRU_cv_minmax_growth_model, trace = 2)
#model.sel(PAC_cv_low_growth_model_dredge)
PRU.avg_minmax_growth_model = model.avg(PRU_cv_minmax_growth_model_dredge, delta < 10)
summary(PRU.avg_minmax_growth_model)
PRU.avg_minmax_growth_model$sw
```

### Symbiont Count Models

```{r Symbiont data CV AND low tide data dredge, warning=FALSE, message=FALSE}
# Build the GLM model
#PAC_cv_model <- glm(Percent_Change ~ ., data = PAC_cv_model_data, na.action = na.pass)
PAC_cv_low_symb_model <- lmer(log10(FSC.Events_per_cm_2) ~
                       Low_Tide_Mean_Phosphate_umolL_scaled + 
                       Low_Tide_Mean_NN_umolL_scaled + 
                       Low_Tide_Mean_Ammonia_umolL_scaled +
                       Low_Tide_Mean_NNP_umolL_scaled +
                       (1 | Genotype) + (1 | Cage_Uncaged), 
                                 data = PAC_model_data, 
                                 na.action = na.pass)

PAC_cv_low_symb_model_dredge <- dredge(PAC_cv_low_symb_model, trace = 2)
model.sel(PAC_cv_low_symb_model_dredge)
PAC_cv_low_symb_model_dredge_model.avg = model.avg(PAC_cv_low_symb_model_dredge, delta < 8)
summary(PAC_cv_low_symb_model_dredge_model.avg)
PAC_cv_low_symb_model_dredge_model.avg$sw
```


```{r Symbiont cv and low tide best model effects plots}
PAC_symb_cv_plus_lowtide_model <- lmer(log10(FSC.Events_per_cm_2) ~ 
                       CV_Salinity + 
                       CV_Temperature + 
                       CV_TA + 
                       CV_pH +
                       (1 | Genotype) + (1 | Cage_Uncaged), 
                                 data = PAC_model_data, 
                                 na.action = na.pass)
plot(allEffects(PAC_symb_cv_plus_lowtide_model))
```

